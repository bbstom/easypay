# 生产环境部署 - 完成总结

## ✅ 已完成的工作

### 1. 数据库初始化脚本
**文件：** `server/scripts/initDatabase.js`

**功能：**
- ✅ 交互式创建管理员账号
- ✅ 初始化系统配置（默认参数）
- ✅ 检查是否已初始化，避免重复
- ✅ 提供后续配置步骤提示
- ✅ 支持重新初始化（清空数据）

**使用方法：**
```bash
npm run init-db
```

**初始化内容：**
- 管理员账号（用户名、邮箱、密码）
- 系统配置（网站名称、汇率、服务费等）
- 默认的 TRON API 节点配置
- 能量租赁配置（默认禁用）
- 支付平台配置（需要后续填写）
- 邮件配置（需要后续填写）
- 闪兑配置（默认启用）

---

### 2. 自动部署脚本
**文件：** `deploy.sh`

**功能：**
- ✅ 安装生产依赖
- ✅ 构建前端（生成 dist 目录）
- ✅ 检查 .env 文件（不存在则创建）
- ✅ 测试数据库连接
- ✅ 询问是否初始化数据库
- ✅ 检查并安装 PM2
- ✅ 启动/重启后端服务
- ✅ 显示服务状态和日志
- ✅ 提供后续步骤提示

**使用方法：**
```bash
chmod +x deploy.sh
bash deploy.sh
```

---

### 3. 完整部署指南
**文件：** `生产环境部署指南.md`

**内容：**
- ✅ 部署架构图
- ✅ 服务器环境准备（Ubuntu/CentOS）
- ✅ 软件安装步骤（Node.js、MongoDB、Nginx、PM2）
- ✅ 代码部署步骤
- ✅ 环境变量配置详解
- ✅ 数据库初始化详解
- ✅ 前端构建步骤
- ✅ Nginx 配置详解（含 SSL）
- ✅ 后端服务启动（PM2）
- ✅ 防火墙配置
- ✅ 部署验证步骤
- ✅ 安全加固建议
- ✅ 备份策略
- ✅ 更新部署流程
- ✅ 故障排查指南
- ✅ 部署检查清单

---

### 4. 快速开始指南
**文件：** `生产部署_快速开始.md`

**内容：**
- ✅ 5 分钟快速部署流程
- ✅ 前提条件检查
- ✅ 简化的部署步骤
- ✅ 数据库初始化说明
- ✅ 部署验证方法
- ✅ 后续配置清单
- ✅ 更新部署流程
- ✅ 常见问题解决
- ✅ 快速命令参考

---

### 5. Package.json 更新
**文件：** `package.json`

**新增脚本：**
```json
{
  "scripts": {
    "start": "node server/index.js",      // 生产环境启动
    "init-db": "node server/scripts/initDatabase.js"  // 数据库初始化
  }
}
```

---

## 📋 部署架构

```
用户浏览器
    ↓
Nginx (Web 服务器)
  - 静态文件服务 (前端 dist/)
  - 反向代理 (/api/* → 后端)
  - SSL/TLS 证书
    ↓
Node.js + Express (后端服务)
  - 端口: 3000
  - PM2 进程管理
  - 自动重启
    ↓
MongoDB (数据库)
  - 端口: 27017
  - 数据持久化
```

---

## 🚀 部署流程

### 方式一：使用自动部署脚本（推荐）

```bash
# 1. 上传代码到服务器
cd /var/www
git clone <your-repo> easypay
cd easypay

# 2. 配置环境变量
cp .env.example .env
nano .env  # 修改必要配置

# 3. 运行部署脚本
chmod +x deploy.sh
bash deploy.sh

# 4. 配置 Nginx
sudo cp nginx配置示例.conf /etc/nginx/sites-available/easypay
sudo nano /etc/nginx/sites-available/easypay  # 修改域名
sudo ln -s /etc/nginx/sites-available/easypay /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

# 5. 配置 SSL
sudo certbot --nginx -d your-domain.com

# 6. 访问网站
# https://your-domain.com
```

### 方式二：手动部署

参考 `生产环境部署指南.md` 中的详细步骤。

---

## ⚙️ 必须配置的环境变量

**文件：** `.env`

```env
# 环境
NODE_ENV=production

# 服务器配置
PORT=3000

# MongoDB 配置
MONGODB_URI=mongodb://localhost:27017/easypay

# JWT 密钥（必须修改！）
JWT_SECRET=<生成随机字符串>

# 主密钥（必须修改！用于加密钱包私钥）
MASTER_KEY=<生成随机字符串>

# 前端 URL（用于 CORS）
FRONTEND_URL=https://your-domain.com

# 支付回调 URL
PAYMENT_CALLBACK_URL=https://your-domain.com/api/payments/notify
```

**生成安全密钥：**
```bash
# JWT_SECRET
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# MASTER_KEY
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

---

## 📊 数据库初始化

### 自动初始化（推荐）

部署脚本会询问是否初始化数据库，选择 `y` 即可。

### 手动初始化

```bash
npm run init-db
```

**交互式输入：**
1. 管理员用户名（默认：admin）
2. 管理员邮箱（默认：admin@example.com）
3. 管理员密码（默认：admin123）
4. 网站名称（默认：FastPay）

**初始化完成后会显示：**
- ✅ 管理员账号信息
- ✅ 系统配置信息
- ✅ 后续配置步骤提示

---

## 🔧 后续配置（管理后台）

登录管理后台：`https://your-domain.com/login`

### 1. 修改管理员密码 ⚠️ 必须

进入"用户中心" → 修改密码

### 2. 配置支付平台 ⚠️ 必须

进入"系统设置" → "支付配置"
- 商户ID
- API密钥
- 回调地址：`https://your-domain.com/api/payments/notify`
- 启用支付方式（微信/支付宝）

### 3. 添加代付钱包 ⚠️ 必须

进入"代付系统" → "钱包配置"
- 点击"添加钱包"
- 填写钱包名称
- 填写钱包地址
- 填写钱包私钥（会自动加密存储）
- 设置钱包优先级

### 4. 配置能量租赁（推荐）

进入"系统设置" → "能量租赁"

**推荐使用 CatFee API 模式：**
- 启用能量租赁
- 选择"API 模式"
- 填写 CatFee API Key
- 配置能量数量：
  - 首次转账：131000 能量
  - 普通转账：65000 能量

**优势：**
- 成本低（约 3 TRX）
- 速度快（秒级）
- 无需管理租赁地址

### 5. 配置邮件通知（可选）

进入"系统设置" → "邮件配置"
- SMTP 服务器
- SMTP 端口
- 邮箱账号
- 邮箱密码
- 发件人名称

### 6. 配置闪兑钱包（可选）

进入"闪兑系统" → "钱包配置"
- 添加闪兑专用钱包
- 填写地址和私钥
- 设置优先级

---

## 📋 部署检查清单

### 部署前
- [ ] 服务器环境准备完成（Node.js、MongoDB、Nginx）
- [ ] 域名解析配置完成
- [ ] SSL 证书准备完成
- [ ] 代码已上传到服务器

### 部署中
- [ ] 环境变量配置完成（.env）
- [ ] 数据库初始化完成
- [ ] 前端构建完成（dist 目录）
- [ ] Nginx 配置完成
- [ ] 后端服务启动完成（PM2）
- [ ] SSL 证书配置完成

### 部署后
- [ ] 网站可以正常访问（https://your-domain.com）
- [ ] 管理后台可以登录
- [ ] API 接口正常响应
- [ ] 管理员密码已修改
- [ ] 支付平台配置完成
- [ ] 代付钱包配置完成
- [ ] 能量租赁配置完成（推荐）
- [ ] 邮件通知配置完成（可选）

### 功能测试
- [ ] 用户注册/登录功能正常
- [ ] 支付功能测试通过
- [ ] 代付功能测试通过
- [ ] 能量租赁功能正常
- [ ] 闪兑功能正常（如果启用）
- [ ] 工单系统正常
- [ ] 邮件通知正常（如果启用）

---

## 🔄 更新部署

```bash
cd /var/www/easypay

# 拉取最新代码
git pull

# 重新部署
bash deploy.sh
```

或手动更新：

```bash
# 安装新依赖
npm install --production

# 重新构建前端
npm run build

# 重启后端服务
pm2 restart easypay-backend

# 重新加载 Nginx
sudo systemctl reload nginx
```

---

## 📊 服务管理

### PM2 命令

```bash
# 查看状态
pm2 status

# 查看日志
pm2 logs easypay-backend

# 实时日志
pm2 logs easypay-backend --lines 100

# 重启服务
pm2 restart easypay-backend

# 停止服务
pm2 stop easypay-backend

# 删除服务
pm2 delete easypay-backend

# 监控
pm2 monit

# 查看详细信息
pm2 show easypay-backend
```

### Nginx 命令

```bash
# 测试配置
sudo nginx -t

# 重启
sudo systemctl restart nginx

# 重新加载配置（不中断服务）
sudo systemctl reload nginx

# 查看状态
sudo systemctl status nginx

# 查看访问日志
sudo tail -f /var/log/nginx/easypay_access.log

# 查看错误日志
sudo tail -f /var/log/nginx/easypay_error.log
```

### MongoDB 命令

```bash
# 连接数据库
mongosh

# 查看数据库
show dbs

# 切换数据库
use easypay

# 查看集合
show collections

# 查看管理员
db.users.find({ role: 'admin' })

# 查看系统配置
db.settings.find()

# 查看钱包
db.wallets.find()

# 退出
exit
```

---

## 🐛 常见问题

### 问题 1：数据库连接失败

**症状：**
```
Error: connect ECONNREFUSED 127.0.0.1:27017
```

**解决：**
```bash
# 检查 MongoDB 状态
sudo systemctl status mongod

# 启动 MongoDB
sudo systemctl start mongod

# 设置开机自启
sudo systemctl enable mongod

# 检查 .env 中的 MONGODB_URI
```

### 问题 2：无法访问网站

**症状：**
- 浏览器显示"无法访问此网站"
- 或显示 502 Bad Gateway

**解决：**
```bash
# 检查 Nginx 状态
sudo systemctl status nginx

# 检查 Nginx 配置
sudo nginx -t

# 查看错误日志
sudo tail -f /var/log/nginx/easypay_error.log

# 检查后端服务
pm2 status
pm2 logs easypay-backend

# 检查端口监听
sudo netstat -tlnp | grep -E '(80|443|3000)'
```

### 问题 3：API 请求失败

**症状：**
- 前端可以访问，但 API 请求失败
- 控制台显示 CORS 错误

**解决：**
```bash
# 检查后端服务
pm2 status
pm2 logs easypay-backend

# 检查 .env 中的 FRONTEND_URL
# 确保与实际域名一致

# 重启后端服务
pm2 restart easypay-backend
```

### 问题 4：支付回调失败

**症状：**
- 用户支付成功，但订单状态不更新

**解决：**
1. 检查支付平台配置的回调地址是否正确
2. 确保回调地址可以从外网访问
3. 查看后端日志：`pm2 logs easypay-backend`
4. 测试回调接口：`curl https://your-domain.com/api/payments/notify?test=1`

### 问题 5：代付失败

**症状：**
- 订单创建成功，但代付失败

**解决：**
1. 检查钱包配置是否正确
2. 检查钱包余额是否充足
3. 检查能量租赁配置
4. 查看后端日志：`pm2 logs easypay-backend`
5. 测试钱包连接：`node server/scripts/testWallet.js`

---

## 🔒 安全建议

### 1. 修改默认密码
- ⚠️ 立即修改管理员密码
- 使用强密码（至少 12 位，包含大小写字母、数字、特殊字符）

### 2. 保护敏感文件
```bash
# 设置 .env 文件权限
chmod 600 .env

# 确保私钥文件不被访问
# 私钥已加密存储在数据库中
```

### 3. 启用 MongoDB 认证
```bash
# 创建数据库用户
mongosh
use admin
db.createUser({
  user: "easypay_admin",
  pwd: "your-secure-password",
  roles: [ { role: "readWrite", db: "easypay" } ]
})

# 启用认证
sudo nano /etc/mongod.conf
# 添加：
# security:
#   authorization: enabled

# 重启 MongoDB
sudo systemctl restart mongod

# 更新 .env
# MONGODB_URI=mongodb://easypay_admin:your-secure-password@localhost:27017/easypay
```

### 4. 配置防火墙
```bash
# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

### 5. 定期备份
```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup-easypay.sh

# 添加到 crontab（每天凌晨 2 点备份）
sudo crontab -e
# 添加：
# 0 2 * * * /usr/local/bin/backup-easypay.sh >> /var/log/easypay-backup.log 2>&1
```

### 6. 监控日志
```bash
# 定期查看日志
pm2 logs easypay-backend
sudo tail -f /var/log/nginx/easypay_access.log
sudo tail -f /var/log/nginx/easypay_error.log
```

---

## 📞 技术支持

### 文档参考
- **完整部署指南：** `生产环境部署指南.md`
- **快速开始：** `生产部署_快速开始.md`
- **多钱包系统：** `多钱包系统_快速参考.md`
- **能量租赁：** `TRON资源管理指南.md`
- **CatFee 集成：** `CATFEE_集成指南.md`

### 日志位置
- **后端日志：** `pm2 logs easypay-backend`
- **Nginx 访问日志：** `/var/log/nginx/easypay_access.log`
- **Nginx 错误日志：** `/var/log/nginx/easypay_error.log`
- **MongoDB 日志：** `/var/log/mongodb/mongod.log`

---

## 🎉 部署完成！

恭喜！您已经完成了生产环境的部署。

**下一步：**
1. ✅ 登录管理后台
2. ✅ 修改管理员密码
3. ✅ 完成必要配置（支付平台、钱包、能量租赁）
4. ✅ 测试所有功能
5. ✅ 开始使用！

---

**文档版本：** v1.0  
**最后更新：** 2026-02-02  
**适用系统：** Ubuntu 20.04+ / CentOS 7+
