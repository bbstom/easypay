# 实时汇率功能说明

## 功能概述

系统现已支持自动获取实时汇率，使用免费的CoinGecko API，每小时自动更新一次，无需任何配置。

## 特点

✅ **完全免费** - 使用CoinGecko免费API，无需注册或API密钥
✅ **自动更新** - 每小时自动获取最新汇率
✅ **双重保障** - 主API失败时自动切换到Binance备用API
✅ **零配置** - 无需设置，开箱即用
✅ **支持加成** - 可设置汇率加成百分比（如+5%）

## 使用方法

### 1. 启用实时汇率

1. 登录管理后台
2. 进入"汇率设置"标签页
3. 选择"实时汇率（自动更新）"模式
4. 设置汇率加成百分比（可选，如5%）
5. 点击"保存设置"

### 2. 手动刷新汇率

如果需要立即更新汇率（不等待自动更新）：

1. 在"汇率设置"页面
2. 点击"立即刷新"按钮
3. 系统会立即从API获取最新汇率

### 3. 查看汇率信息

在实时模式下，页面会显示：
- 当前USDT汇率
- 当前TRX汇率
- 最后更新时间
- 下次自动更新时间

## 工作原理

### 数据来源

**主API：CoinGecko**
- 接口：`https://api.coingecko.com/api/v3/simple/price`
- 参数：`ids=tether,tron&vs_currencies=cny`
- 优点：免费、稳定、无需注册

**备用API：Binance**
- 接口：`https://api.binance.com/api/v3/ticker/price`
- 用途：当CoinGecko失败时自动切换
- 计算：TRX/USDT价格 × USDT汇率

### 更新机制

1. **服务器启动时**
   - 自动启动汇率更新服务
   - 立即执行一次汇率获取

2. **定时更新**
   - 每60分钟自动更新一次
   - 只在"实时模式"下执行更新
   - 手动模式不会自动更新

3. **汇率计算**
   ```
   实际汇率 = API汇率 × (1 + 加成百分比/100)
   
   例如：
   API汇率: 7.25 CNY
   加成: 5%
   实际汇率 = 7.25 × (1 + 5/100) = 7.6125 CNY
   ```

4. **容错机制**
   - 主API失败 → 自动切换备用API
   - 备用API失败 → 使用缓存汇率
   - 无缓存 → 使用默认汇率（USDT: 7.25, TRX: 1.08）

## 技术实现

### 后端服务

**文件：** `server/services/exchangeRateService.js`

主要功能：
- `startAutoUpdate()` - 启动自动更新服务
- `updateRates()` - 更新汇率到数据库
- `fetchRatesFromAPI()` - 从CoinGecko获取汇率
- `fetchRatesFromBackupAPI()` - 从Binance获取汇率（备用）
- `forceUpdate()` - 手动触发更新
- `getCacheInfo()` - 获取缓存信息

### API接口

**1. 手动刷新汇率**
```
POST /api/settings/refresh-rates
需要管理员权限
```

**2. 获取汇率信息**
```
GET /api/settings/rate-info
需要管理员权限
```

**3. 公开设置（包含汇率）**
```
GET /api/settings/public
无需权限
```

### 前端集成

**文件：** `src/pages/PayPage.jsx`, `src/pages/PayPageTRX.jsx`

汇率获取：
```javascript
const getExchangeRate = (coinType) => {
  if (!settings) return coinType === 'USDT' ? 7.35 : 1.08;
  
  const baseRate = coinType === 'USDT' 
    ? settings.exchangeRateUSDT 
    : settings.exchangeRateTRX;
  const markup = settings.exchangeRateMarkup || 0;
  
  return baseRate * (1 + markup / 100);
};
```

## 测试

### 测试汇率服务

运行测试脚本：
```bash
node server/scripts/testExchangeRate.js
```

输出示例：
```
🔗 连接数据库...
✅ 数据库连接成功

📊 测试汇率获取服务...

1️⃣ 从CoinGecko获取汇率...
✅ 汇率更新成功！
   USDT: 7.2543 CNY (加成后: 7.6170 CNY)
   TRX: 1.0821 CNY (加成后: 1.1362 CNY)

2️⃣ 查看缓存信息...
缓存汇率: { USDT: 7.6170, TRX: 1.1362 }
最后更新: 2026-01-29T12:00:00.000Z
下次更新: 2026-01-29T13:00:00.000Z

✅ 测试完成！
```

### 验证流程

1. **启用实时模式**
   - 后台 → 汇率设置 → 选择"实时汇率"
   - 保存设置

2. **查看服务器日志**
   ```
   🔄 汇率自动更新服务已启动
   🔄 开始更新汇率...
   ✅ 汇率更新成功！
      USDT: 7.2543 CNY (加成后: 7.6170 CNY)
      TRX: 1.0821 CNY (加成后: 1.1362 CNY)
      下次更新: 2026-01-29 13:00:00
   ```

3. **前端验证**
   - 访问USDT代付页面
   - 查看汇率显示是否为最新值
   - 输入金额，验证计算是否正确

## 常见问题

### Q1: 汇率多久更新一次？
A: 每60分钟自动更新一次。可以在后台手动点击"立即刷新"按钮强制更新。

### Q2: 如果API失败怎么办？
A: 系统有三层保障：
1. 主API (CoinGecko)
2. 备用API (Binance)
3. 缓存汇率或默认值

### Q3: 需要API密钥吗？
A: 不需要！使用的都是免费公开API，无需注册或配置。

### Q4: 汇率加成如何设置？
A: 在"汇率设置"中设置加成百分比，例如设置5%，则实际汇率 = API汇率 × 1.05

### Q5: 可以切换回手动模式吗？
A: 可以！随时在后台切换模式。切换到手动模式后，自动更新会停止。

### Q6: 实时汇率会影响已创建的订单吗？
A: 不会！订单创建时会记录当时的汇率，后续汇率变化不影响已有订单。

## 监控建议

建议定期检查：
1. 服务器日志中的汇率更新记录
2. 后台"汇率设置"页面的更新时间
3. 前端页面显示的汇率是否合理

如果发现汇率长时间未更新，可以：
1. 检查服务器网络连接
2. 查看服务器日志中的错误信息
3. 手动点击"立即刷新"按钮
4. 临时切换到手动模式

## 注意事项

⚠️ **网络要求**
- 服务器需要能访问国际API（CoinGecko、Binance）
- 如果服务器在国内，可能需要配置代理

⚠️ **汇率波动**
- 加密货币汇率波动较大
- 建议设置合理的加成百分比以覆盖波动风险

⚠️ **API限制**
- CoinGecko免费API有请求频率限制
- 当前设置为每小时更新一次，不会触发限制

## 升级建议

如果需要更高级的功能，可以考虑：

1. **更频繁的更新**
   - 修改 `updateInterval` 为更短的时间（如30分钟）
   - 注意API限制

2. **更多数据源**
   - 添加更多备用API
   - 实现多源汇率平均

3. **汇率历史记录**
   - 记录每次汇率变化
   - 生成汇率趋势图表

4. **汇率预警**
   - 汇率异常波动时发送通知
   - 自动调整加成百分比
