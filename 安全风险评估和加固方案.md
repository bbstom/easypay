# 安全风险评估和加固方案

## 当前安全状况分析

### ✅ 已实施的安全措施

1. **私钥加密存储**
   - 使用 AES-256-GCM 加密算法
   - PBKDF2 密钥派生（100,000 次迭代）
   - 随机 Salt 和 IV
   - 认证标签验证

2. **主密钥管理**
   - 从环境变量读取（ENCRYPTION_KEY 或 JWT_SECRET）
   - 不在代码中硬编码

3. **数据库存储**
   - 只存储加密后的私钥
   - 不存储明文私钥

### ⚠️ 存在的安全风险

#### 高风险

1. **主密钥泄露风险**
   - `.env` 文件如果被攻击者获取，可以解密所有私钥
   - 环境变量可能通过进程列表泄露
   - 服务器被攻破后，内存中的主密钥可被读取

2. **数据库备份风险**
   - 数据库备份包含加密私钥
   - 如果备份和 `.env` 同时泄露，私钥可被解密

3. **日志泄露风险**
   - 错误日志可能包含敏感信息
   - 调试信息可能暴露私钥

4. **内存泄露风险**
   - 解密后的私钥在内存中明文存在
   - 服务器被攻破后可通过内存转储获取

5. **API 接口风险**
   - 管理员可以通过 API 获取钱包信息
   - 如果管理员账号被盗，可能导致私钥泄露

#### 中风险

6. **文件权限问题**
   - `.env` 文件权限设置不当
   - 日志文件可被其他用户读取

7. **网络传输风险**
   - 虽然使用 HTTPS，但服务器端可能被中间人攻击

8. **依赖库漏洞**
   - Node.js 依赖包可能存在安全漏洞

---

## 安全加固方案

### 方案 1：硬件安全模块（HSM）【最安全】

**实施难度**：高  
**成本**：高  
**安全级别**：★★★★★

使用硬件安全模块存储私钥，私钥永不离开硬件设备。

**优点**：
- 私钥永不以明文形式存在于服务器
- 即使服务器被完全攻破，私钥也无法被提取
- 符合金融级安全标准

**缺点**：
- 需要购买 HSM 设备（成本高）
- 实施复杂度高
- 需要专业知识

**适用场景**：大型企业、高价值资产管理

---

### 方案 2：密钥管理服务（KMS）【推荐】

**实施难度**：中  
**成本**：中  
**安全级别**：★★★★☆

使用云服务商的密钥管理服务（如 AWS KMS、阿里云 KMS）。

**实施步骤**：

1. **注册 KMS 服务**
   ```bash
   # 以阿里云 KMS 为例
   # 1. 开通 KMS 服务
   # 2. 创建主密钥（CMK）
   # 3. 获取 AccessKey
   ```

2. **安装 SDK**
   ```bash
   npm install @alicloud/kms-sdk
   ```

3. **修改加密服务**
   ```javascript
   // server/utils/kmsEncryption.js
   const KMS = require('@alicloud/kms-sdk');
   
   const client = new KMS({
     endpoint: process.env.KMS_ENDPOINT,
     accessKeyId: process.env.KMS_ACCESS_KEY_ID,
     accessKeySecret: process.env.KMS_ACCESS_KEY_SECRET
   });
   
   async function encryptPrivateKey(privateKey) {
     const result = await client.encrypt({
       KeyId: process.env.KMS_KEY_ID,
       Plaintext: Buffer.from(privateKey).toString('base64')
     });
     return result.CiphertextBlob;
   }
   
   async function decryptPrivateKey(ciphertext) {
     const result = await client.decrypt({
       CiphertextBlob: ciphertext
     });
     return Buffer.from(result.Plaintext, 'base64').toString();
   }
   ```

**优点**：
- 主密钥由云服务商管理，不在服务器上
- 支持密钥轮换
- 有审计日志
- 成本相对较低

**缺点**：
- 依赖云服务商
- 需要网络连接
- 有一定成本

---

### 方案 3：多层加密 + 分离存储【平衡方案】

**实施难度**：中  
**成本**：低  
**安全级别**：★★★☆☆

将主密钥分离存储，增加攻击难度。

**实施步骤**：

1. **主密钥分片**
   ```javascript
   // server/utils/keySharding.js
   const crypto = require('crypto');
   
   // 将主密钥分成多个片段
   function shardMasterKey(masterKey, shards = 3) {
     const shares = [];
     const keyBuffer = Buffer.from(masterKey, 'hex');
     
     // 使用 Shamir's Secret Sharing
     // 需要至少 2 个片段才能恢复密钥
     for (let i = 0; i < shards; i++) {
       const share = crypto.randomBytes(32);
       shares.push(share.toString('hex'));
     }
     
     return shares;
   }
   
   // 从片段恢复主密钥
   function recoverMasterKey(shares) {
     // 实现 Shamir's Secret Sharing 恢复算法
     // ...
   }
   ```

2. **分离存储**
   - 片段 1：存储在 `.env` 文件
   - 片段 2：存储在数据库
   - 片段 3：存储在远程服务器或配置中心

3. **启动时组合**
   ```javascript
   // server/index.js
   const share1 = process.env.KEY_SHARE_1;
   const share2 = await getShareFromDatabase();
   const share3 = await getShareFromRemote();
   
   const masterKey = recoverMasterKey([share1, share2, share3]);
   ```

**优点**：
- 攻击者需要同时获取多个存储位置
- 实施成本低
- 不依赖第三方服务

**缺点**：
- 仍然存在内存泄露风险
- 实施复杂度中等

---

### 方案 4：当前方案加固【快速实施】

**实施难度**：低  
**成本**：低  
**安全级别**：★★★☆☆

在现有基础上进行安全加固。

#### 4.1 文件权限加固

```bash
# 设置 .env 文件权限（只有所有者可读）
chmod 600 .env

# 设置日志文件权限
chmod 600 /www/wwwlogs/*.log

# 设置数据库备份权限
chmod 600 /path/to/backup/*
```

#### 4.2 增强主密钥强度

```bash
# 生成更强的主密钥（64字节）
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# 更新 .env
ENCRYPTION_KEY=生成的64字节密钥
```

#### 4.3 禁用私钥导出

```javascript
// server/routes/wallets.js
// 删除或注释掉返回私钥的接口

// ❌ 不要这样做
// router.get('/wallets/:id/private-key', auth, adminOnly, async (req, res) => {
//   const privateKey = decryptPrivateKey(...);
//   res.json({ privateKey });
// });
```

#### 4.4 添加操作审计

```javascript
// server/models/AuditLog.js
const auditLogSchema = new mongoose.Schema({
  userId: String,
  action: String,
  resource: String,
  ip: String,
  userAgent: String,
  timestamp: { type: Date, default: Date.now }
});

// 记录敏感操作
async function logSensitiveOperation(userId, action, resource, req) {
  await AuditLog.create({
    userId,
    action,
    resource,
    ip: req.ip,
    userAgent: req.headers['user-agent']
  });
}
```

#### 4.5 限制管理员权限

```javascript
// server/middleware/auth.js
// 添加 IP 白名单
const ADMIN_IP_WHITELIST = process.env.ADMIN_IP_WHITELIST?.split(',') || [];

function adminIpCheck(req, res, next) {
  if (ADMIN_IP_WHITELIST.length > 0) {
    const clientIp = req.ip;
    if (!ADMIN_IP_WHITELIST.includes(clientIp)) {
      return res.status(403).json({ error: '访问被拒绝' });
    }
  }
  next();
}
```

#### 4.6 内存安全

```javascript
// server/utils/secureMemory.js
// 使用后立即清除敏感数据
function clearSensitiveData(buffer) {
  if (Buffer.isBuffer(buffer)) {
    buffer.fill(0);
  } else if (typeof buffer === 'string') {
    buffer = '\0'.repeat(buffer.length);
  }
}

// 使用示例
const privateKey = decryptPrivateKey(...);
try {
  // 使用私钥
  await doSomething(privateKey);
} finally {
  // 立即清除
  clearSensitiveData(privateKey);
}
```

#### 4.7 数据库加密

```bash
# MongoDB 启用加密
mongod --enableEncryption \
  --encryptionKeyFile /path/to/keyfile \
  --encryptionCipherMode AES256-CBC
```

#### 4.8 定期密钥轮换

```javascript
// server/scripts/rotateEncryptionKey.js
async function rotateEncryptionKey(oldKey, newKey) {
  const wallets = await Wallet.find();
  
  for (const wallet of wallets) {
    // 用旧密钥解密
    const privateKey = decryptPrivateKey(wallet.privateKeyEncrypted, oldKey);
    
    // 用新密钥加密
    wallet.privateKeyEncrypted = encryptPrivateKey(privateKey, newKey);
    await wallet.save();
    
    // 清除内存
    clearSensitiveData(privateKey);
  }
  
  console.log('密钥轮换完成');
}
```

---

## 推荐实施方案

### 短期（立即实施）- 方案 4

1. ✅ 设置文件权限
2. ✅ 生成更强的主密钥
3. ✅ 禁用私钥导出接口
4. ✅ 添加操作审计
5. ✅ 限制管理员 IP
6. ✅ 启用数据库加密

**预计时间**：1-2 天  
**成本**：0 元

### 中期（1-2 周）- 方案 3

1. 实施主密钥分片
2. 分离存储密钥片段
3. 实施内存安全措施
4. 定期密钥轮换

**预计时间**：1-2 周  
**成本**：0 元

### 长期（1-3 个月）- 方案 2

1. 选择 KMS 服务商
2. 迁移到 KMS
3. 实施完整的密钥管理策略
4. 定期安全审计

**预计时间**：1-3 个月  
**成本**：约 100-500 元/月

---

## 安全检查清单

### 服务器安全

- [ ] 启用防火墙，只开放必要端口
- [ ] 禁用 root 登录
- [ ] 使用 SSH 密钥认证
- [ ] 定期更新系统补丁
- [ ] 安装入侵检测系统（IDS）

### 应用安全

- [ ] 使用 HTTPS（已实施）
- [ ] 启用 CORS 限制（已实施）
- [ ] 实施 Rate Limiting
- [ ] 添加 WAF（Web 应用防火墙）
- [ ] 定期安全扫描

### 数据安全

- [ ] 数据库加密
- [ ] 定期备份
- [ ] 备份加密存储
- [ ] 访问控制
- [ ] 审计日志

### 密钥安全

- [ ] 强主密钥（64+ 字节）
- [ ] 密钥分离存储
- [ ] 定期密钥轮换
- [ ] 密钥访问审计
- [ ] 密钥备份和恢复计划

### 监控和响应

- [ ] 实时监控异常访问
- [ ] 告警机制
- [ ] 事件响应计划
- [ ] 定期安全演练
- [ ] 漏洞赏金计划

---

## 应急响应计划

### 如果怀疑私钥泄露

1. **立即行动**
   ```bash
   # 1. 停止服务
   pm2 stop easypay-backend
   
   # 2. 断开网络（如果可能）
   
   # 3. 转移资金到安全地址
   ```

2. **调查分析**
   - 检查访问日志
   - 检查审计日志
   - 分析异常交易

3. **恢复措施**
   - 生成新钱包
   - 转移剩余资金
   - 更新所有密钥
   - 重新部署系统

4. **事后总结**
   - 分析攻击路径
   - 修复安全漏洞
   - 更新安全策略

---

## 总结

**当前风险等级**：中高

**主要风险**：
1. 主密钥泄露可导致所有私钥被解密
2. 服务器被攻破后内存中的私钥可被读取
3. 管理员账号被盗可能导致私钥泄露

**建议**：
1. **立即实施方案 4**（文件权限、审计、IP 限制）
2. **1 周内实施方案 3**（密钥分片、分离存储）
3. **考虑长期迁移到方案 2**（KMS）

**重要提醒**：
- 没有绝对安全的系统
- 安全是一个持续的过程
- 定期审计和更新是关键
- 最小化私钥暴露时间
- 实施多层防御策略
