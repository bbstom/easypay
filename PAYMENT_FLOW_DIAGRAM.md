# 💳 支付和转账流程图

## 完整支付流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户操作流程                                 │
└─────────────────────────────────────────────────────────────────────┘

    用户访问代付页面
           ↓
    选择币种 (USDT/TRX)
           ↓
    输入收款地址 + 数量
           ↓
    选择支付方式 (支付宝/微信)
           ↓
    查看订单详情
           ↓
    点击"立即支付"
           ↓
    跳转到支付网关
           ↓
    完成支付 (扫码/输入密码)
           ↓
    等待转账完成
           ↓
    收到邮件通知 (如提供邮箱)
           ↓
    查看交易哈希


┌─────────────────────────────────────────────────────────────────────┐
│                          系统处理流程                                 │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│  1. 创建订单      │
└────────┬─────────┘
         │
         ↓
┌──────────────────────────────────────────────────────┐
│  • 验证输入参数                                        │
│  • 获取系统设置 (汇率、服务费)                         │
│  • 计算总金额 (CNY)                                   │
│  • 生成订单号 (ORDxxxxxxxxxx)                         │
│  • 保存到数据库                                        │
│    - paymentStatus: 'pending'                        │
│    - transferStatus: 'pending'                       │
│    - status: 'pending'                               │
└────────┬─────────────────────────────────────────────┘
         │
         ↓
┌──────────────────┐
│  2. 调用支付网关  │
└────────┬─────────┘
         │
         ↓
┌──────────────────────────────────────────────────────┐
│  • 构建支付参数                                        │
│  • 生成签名 (MD5/RSA)                                 │
│  • 发送请求到支付网关                                  │
│  • 获取支付链接                                        │
│  • 返回给前端                                          │
└────────┬─────────────────────────────────────────────┘
         │
         ↓
┌──────────────────┐
│  3. 用户支付      │
└────────┬─────────┘
         │
         ↓
┌──────────────────┐
│  4. 支付回调      │
└────────┬─────────┘
         │
         ↓
┌──────────────────────────────────────────────────────┐
│  • 接收支付网关回调                                    │
│  • 验证签名                                            │
│  • 检查订单状态                                        │
│  • 更新订单:                                           │
│    - paymentStatus: 'paid'                           │
│    - paymentTime: now()                              │
│    - status: 'paid'                                  │
│  • 返回 SUCCESS                                       │
└────────┬─────────────────────────────────────────────┘
         │
         ↓
┌──────────────────┐
│  5. 触发自动转账  │
└────────┬─────────┘
         │
         ↓
┌──────────────────────────────────────────────────────┐
│  processTransfer(paymentId)                          │
│                                                       │
│  • 查询订单                                            │
│  • 检查状态 (必须是 pending/failed)                   │
│  • 更新状态: transferStatus = 'processing'           │
│  • 检查钱包余额                                        │
│  • 执行区块链转账:                                     │
│    - USDT: tronService.sendUSDT()                   │
│    - TRX: tronService.sendTRX()                     │
│  • 获取交易哈希 (txHash)                              │
│  • 更新订单:                                           │
│    - txHash: 'xxxxx...'                             │
│    - transferStatus: 'completed'                    │
│    - transferTime: now()                            │
│    - status: 'completed'                            │
│  • 发送邮件通知                                        │
└────────┬─────────────────────────────────────────────┘
         │
         ↓
┌──────────────────┐
│  6. 完成          │
└──────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                          重试机制流程                                 │
└─────────────────────────────────────────────────────────────────────┘

转账失败
    ↓
检查重试次数 < 3 ?
    ↓
  是 ─────→ 等待延迟 (5s/10s/15s)
    │           ↓
    │       重新执行转账
    │           ↓
    │       成功? ──是──→ 完成
    │           ↓
    │          否
    │           ↓
    └───────→ 继续重试
    
    ↓
   否
    ↓
标记为失败
    ↓
管理员可手动重试


┌─────────────────────────────────────────────────────────────────────┐
│                          状态转换图                                   │
└─────────────────────────────────────────────────────────────────────┘

支付状态 (paymentStatus):
    pending → paid → (不变)
       ↓       ↓
    expired  failed

转账状态 (transferStatus):
    pending → processing → completed
       ↓          ↓            ↑
    failed ←──────┘            │
       ↓                       │
    (手动重试) ────────────────┘

订单状态 (status):
    pending → paid → completed
       ↓       ↓         ↑
    expired  failed     │
                ↓       │
            (手动重试)──┘


┌─────────────────────────────────────────────────────────────────────┐
│                          数据流向图                                   │
└─────────────────────────────────────────────────────────────────────┘

┌──────────┐
│  前端     │
└────┬─────┘
     │ POST /api/payments
     │ { payType, amount, address, paymentMethod, email }
     ↓
┌──────────┐
│  后端     │
└────┬─────┘
     │ 1. 创建订单
     │ 2. 调用支付网关
     ↓
┌──────────┐
│ 支付网关  │
└────┬─────┘
     │ 返回支付链接
     ↓
┌──────────┐
│  前端     │ → 跳转到支付页面
└──────────┘
     ↓
┌──────────┐
│  用户     │ → 完成支付
└──────────┘
     ↓
┌──────────┐
│ 支付网关  │
└────┬─────┘
     │ POST /api/payments/notify
     │ { out_trade_no, trade_status, sign, ... }
     ↓
┌──────────┐
│  后端     │
└────┬─────┘
     │ 1. 验证签名
     │ 2. 更新订单状态
     │ 3. 触发转账
     ↓
┌──────────┐
│ TRON网络  │
└────┬─────┘
     │ 返回交易哈希
     ↓
┌──────────┐
│  后端     │
└────┬─────┘
     │ 1. 更新订单
     │ 2. 发送邮件
     ↓
┌──────────┐
│  用户     │ → 收到通知
└──────────┘


┌─────────────────────────────────────────────────────────────────────┐
│                          时间线示例                                   │
└─────────────────────────────────────────────────────────────────────┘

00:00:00  用户创建订单
00:00:01  跳转到支付网关
00:00:30  用户完成支付
00:00:31  收到支付回调
00:00:31  验证签名成功
00:00:31  更新订单状态为"已支付"
00:00:31  触发自动转账
00:00:32  检查钱包余额 ✓
00:00:33  执行区块链转账
00:00:36  获取交易哈希
00:00:36  更新订单状态为"已完成"
00:00:37  发送邮件通知
00:00:38  用户收到邮件

总耗时: 约 38 秒


┌─────────────────────────────────────────────────────────────────────┐
│                          错误处理流程                                 │
└─────────────────────────────────────────────────────────────────────┘

转账失败
    ↓
记录错误日志
    ↓
检查错误类型
    ↓
┌───────────────────────────────────────┐
│                                        │
│  余额不足?                              │
│    ↓                                   │
│   是 → 发送余额预警                     │
│    ↓                                   │
│   否                                   │
│    ↓                                   │
│  网络错误?                              │
│    ↓                                   │
│   是 → 自动重试                         │
│    ↓                                   │
│   否                                   │
│    ↓                                   │
│  地址无效?                              │
│    ↓                                   │
│   是 → 标记失败，不重试                 │
│    ↓                                   │
│   否                                   │
│    ↓                                   │
│  其他错误 → 自动重试                    │
│                                        │
└────────────────────────────────────────┘
    ↓
重试3次后仍失败
    ↓
标记为失败状态
    ↓
管理员在后台查看
    ↓
手动点击"重试"按钮
    ↓
重新执行转账流程


┌─────────────────────────────────────────────────────────────────────┐
│                          监控和告警流程                               │
└─────────────────────────────────────────────────────────────────────┘

定时任务 (每小时)
    ↓
检查钱包余额
    ↓
┌─────────────────────┐
│  TRX < 20?          │ ──是──→ 发送紧急告警
│       ↓             │
│      否             │
│       ↓             │
│  TRX < 50?          │ ──是──→ 发送预警
│       ↓             │
│      否             │
│       ↓             │
│  USDT < 100?        │ ──是──→ 发送预警
│       ↓             │
│      否             │
│       ↓             │
│  余额充足 ✓         │
└─────────────────────┘
    ↓
记录日志
    ↓
在管理后台显示


┌─────────────────────────────────────────────────────────────────────┐
│                          管理员操作流程                               │
└─────────────────────────────────────────────────────────────────────┘

登录管理后台
    ↓
进入财务管理
    ↓
查看钱包状态卡片
    ↓
┌─────────────────────────────────────┐
│  • 钱包地址                          │
│  • TRX 余额: 100.00 TRX             │
│  • USDT 余额: 1000.00 USDT          │
│  • 余额预警 (如有)                   │
│  • [刷新] 按钮                       │
└─────────────────────────────────────┘
    ↓
查看订单列表
    ↓
筛选失败订单
    ↓
找到需要重试的订单
    ↓
点击 [重试] 按钮
    ↓
确认重试
    ↓
系统重新执行转账
    ↓
等待结果
    ↓
刷新页面查看状态


┌─────────────────────────────────────────────────────────────────────┐
│                          关键时间节点                                 │
└─────────────────────────────────────────────────────────────────────┘

• 订单创建: < 1 秒
• 支付网关响应: 1-3 秒
• 用户支付: 10-60 秒 (取决于用户)
• 支付回调: < 1 秒
• 签名验证: < 0.1 秒
• 触发转账: < 0.1 秒
• 区块链转账: 3-5 秒
• 邮件发送: 1-2 秒

总计: 约 15-70 秒 (主要取决于用户支付速度)


┌─────────────────────────────────────────────────────────────────────┐
│                          成功率指标                                   │
└─────────────────────────────────────────────────────────────────────┘

正常情况下:
• 支付成功率: > 95%
• 转账成功率: > 99%
• 首次转账成功率: > 95%
• 重试后成功率: > 99%
• 邮件发送成功率: > 98%

如果低于这些指标，需要检查:
• 钱包余额是否充足
• 网络连接是否正常
• 配置是否正确
• 是否有系统错误
```

## 📊 关键指标监控

### 实时监控
- 钱包 TRX 余额
- 钱包 USDT 余额
- 待处理订单数
- 处理中订单数

### 每日统计
- 总订单数
- 成功订单数
- 失败订单数
- 总收入
- 平均处理时间

### 每周分析
- 成功率趋势
- 失败原因分析
- 手续费统计
- 用户增长情况

## 🎯 优化建议

### 提高成功率
1. 保持充足的钱包余额
2. 质押 TRX 获取能量
3. 优化网络连接
4. 及时处理失败订单

### 降低成本
1. 使用能量租赁服务
2. 批量处理订单
3. 错峰转账
4. 优化手续费设置

### 提升体验
1. 缩短处理时间
2. 实时状态推送
3. 详细的进度提示
4. 友好的错误提示
