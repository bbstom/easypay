# 环境变量配置说明

## 问题

.env 文件中有 3 个密钥参数：`JWT_SECRET`、`MASTER_KEY`、`ENCRYPTION_KEY`，到底应该用哪个？

## 答案

**只需要配置 2 个参数**：

1. **JWT_SECRET** - 用于 JWT 令牌签名（必需）
2. **ENCRYPTION_KEY** - 用于钱包私钥加密（推荐，如果不配置会使用 JWT_SECRET）

**MASTER_KEY 不需要配置**（代码中没有使用）

---

## 详细说明

### 1. JWT_SECRET（必需）

**用途**：
- 用户登录时生成 JWT 令牌
- 验证用户身份
- API 请求认证

**使用位置**：
- `server/routes/auth.js` - 登录注册
- `server/middleware/auth.js` - 身份验证
- `server/routes/payments.js` - 支付回调验证

**推荐长度**：32+ 字符

**示例**：
```env
JWT_SECRET=fastpay_secret_key_2024_secure_token
```

### 2. ENCRYPTION_KEY（推荐）

**用途**：
- 加密钱包私钥
- 解密钱包私钥
- 保护敏感数据

**使用位置**：
- `server/utils/encryption.js` - 加密解密函数
- `server/services/walletService.js` - 钱包管理

**推荐长度**：64+ 字符（128 位十六进制）

**示例**：
```env
ENCRYPTION_KEY=abeb3843dce222ff7ae426438ff5533d9d7729e63a3e92902f39b6d66ddb583863579498041afef8e8bd0a87c540017e7f25f680a8f83bdd3c939b5a48397820
```

### 3. MASTER_KEY（不需要）

**状态**：❌ 代码中未使用

**说明**：这个参数在代码中没有被引用，可以删除。

---

## 推荐配置

### 方案 1：分离密钥（最安全，推荐）

```env
# JWT 令牌签名密钥
JWT_SECRET=fastpay_secret_key_2024_secure_token

# 钱包私钥加密密钥（64字节）
ENCRYPTION_KEY=abeb3843dce222ff7ae426438ff5533d9d7729e63a3e92902f39b6d66ddb583863579498041afef8e8bd0a87c540017e7f25f680a8f83bdd3c939b5a48397820
```

**优点**：
- 两个密钥分离，更安全
- ENCRYPTION_KEY 更长更强
- 即使 JWT_SECRET 泄露，私钥仍然安全

### 方案 2：共用密钥（简单，不推荐）

```env
# JWT 令牌签名密钥（同时用于加密）
JWT_SECRET=abeb3843dce222ff7ae426438ff5533d9d7729e63a3e92902f39b6d66ddb583863579498041afef8e8bd0a87c540017e7f25f680a8f83bdd3c939b5a48397820

# 不配置 ENCRYPTION_KEY，会自动使用 JWT_SECRET
```

**缺点**：
- 一个密钥泄露，所有功能都不安全
- 不符合安全最佳实践

---

## 代码逻辑

### 加密密钥获取逻辑

```javascript
// server/utils/encryption.js
function getMasterKey() {
  // 优先使用 ENCRYPTION_KEY
  const masterKey = process.env.ENCRYPTION_KEY || process.env.JWT_SECRET;
  
  if (!masterKey) {
    throw new Error('未配置加密主密钥（ENCRYPTION_KEY 或 JWT_SECRET）');
  }
  
  return masterKey;
}
```

**优先级**：
1. 如果配置了 `ENCRYPTION_KEY`，使用它
2. 如果没有配置 `ENCRYPTION_KEY`，使用 `JWT_SECRET`
3. 如果都没有配置，抛出错误

---

## 生成密钥

### 生成 JWT_SECRET（32字节）

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 生成 ENCRYPTION_KEY（64字节）

```bash
node server/scripts/generateStrongKey.js
```

或者：

```bash
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

---

## 完整的 .env 配置示例

```env
# 服务器配置
PORT=5000
NODE_ENV=production

# 数据库配置
MONGODB_URI=mongodb://root:password@localhost:27017/fastpay?authSource=admin

# 安全密钥
JWT_SECRET=fastpay_secret_key_2024_secure_token
ENCRYPTION_KEY=abeb3843dce222ff7ae426438ff5533d9d7729e63a3e92902f39b6d66ddb583863579498041afef8e8bd0a87c540017e7f25f680a8f83bdd3c939b5a48397820

# 应用URL
APP_URL=https://kk.vpno.eu.org
FRONTEND_URL=https://kk.vpno.eu.org

# 管理员IP白名单（可选）
ADMIN_IP_WHITELIST=你的IP地址
```

---

## 迁移指南

### 如果你已经有钱包数据

**情况 1：只配置了 JWT_SECRET**

现在的配置：
```env
JWT_SECRET=your_old_secret
```

**不需要修改**！系统会自动使用 JWT_SECRET 来加密解密。

**情况 2：想要升级到更强的密钥**

1. 生成新的 ENCRYPTION_KEY
2. 运行密钥轮换脚本（需要创建）
3. 更新 .env 文件

⚠️ **警告**：直接修改密钥会导致现有钱包无法解密！

### 如果是新系统

直接配置两个密钥即可：

```env
JWT_SECRET=生成的32字节密钥
ENCRYPTION_KEY=生成的64字节密钥
```

---

## 安全建议

### 1. 使用不同的密钥

❌ **不要这样**：
```env
JWT_SECRET=same_key_123
ENCRYPTION_KEY=same_key_123
```

✅ **应该这样**：
```env
JWT_SECRET=jwt_key_abc123...
ENCRYPTION_KEY=encryption_key_xyz789...
```

### 2. 使用足够长的密钥

❌ **不要这样**：
```env
JWT_SECRET=123456
ENCRYPTION_KEY=password
```

✅ **应该这样**：
```env
JWT_SECRET=至少32字符的随机字符串
ENCRYPTION_KEY=至少64字符的随机字符串
```

### 3. 定期轮换密钥

- JWT_SECRET：每 6-12 个月轮换一次
- ENCRYPTION_KEY：每 3-6 个月轮换一次（需要重新加密所有私钥）

### 4. 安全存储

- 不要将 .env 文件提交到 Git
- 设置文件权限为 600
- 备份密钥到安全位置

---

## 常见问题

### Q1: 我应该删除 MASTER_KEY 吗？

**答**：可以删除，代码中没有使用。

### Q2: 如果只配置 JWT_SECRET 会怎样？

**答**：系统会自动使用 JWT_SECRET 来加密私钥，功能正常但不够安全。

### Q3: 可以修改 ENCRYPTION_KEY 吗？

**答**：如果已有钱包数据，直接修改会导致无法解密。需要先运行密钥轮换脚本。

### Q4: JWT_SECRET 和 ENCRYPTION_KEY 可以相同吗？

**答**：可以，但不推荐。最好使用不同的密钥以提高安全性。

### Q5: 密钥长度有要求吗？

**答**：
- JWT_SECRET：最少 32 字符
- ENCRYPTION_KEY：最少 32 字符，推荐 64+ 字符

---

## 快速配置

### 新系统配置（推荐）

```bash
# 1. 生成密钥
node server/scripts/generateStrongKey.js

# 2. 编辑 .env
nano .env

# 3. 添加配置
JWT_SECRET=生成的32字节密钥
ENCRYPTION_KEY=生成的64字节密钥

# 4. 设置权限
chmod 600 .env

# 5. 重启服务
pm2 restart easypay-backend
```

### 现有系统（已有 JWT_SECRET）

```bash
# 1. 生成新密钥
node server/scripts/generateStrongKey.js

# 2. 编辑 .env，添加 ENCRYPTION_KEY
nano .env

# 3. 重启服务
pm2 restart easypay-backend
```

**注意**：如果已有钱包，添加 ENCRYPTION_KEY 后，新钱包会用新密钥加密，旧钱包仍用 JWT_SECRET 解密。

---

## 总结

**必需配置**：
- ✅ JWT_SECRET（32+ 字符）

**推荐配置**：
- ✅ ENCRYPTION_KEY（64+ 字符）

**不需要配置**：
- ❌ MASTER_KEY（代码中未使用）

**最佳实践**：
```env
JWT_SECRET=32字节随机密钥
ENCRYPTION_KEY=64字节随机密钥
```
