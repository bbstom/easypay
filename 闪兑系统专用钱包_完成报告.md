# 闪兑系统专用钱包 - 完成报告

## 📋 任务概述

修正闪兑系统的汇率逻辑和钱包管理：
1. 闪兑汇率应该直接从交易所获取 `1 USDT = X TRX`，而不是基于代付系统的 CNY 汇率
2. 后台需要配置闪兑专用钱包
3. 用户转 USDT 到哪个钱包，TRX 就从那个钱包返回

## ✅ 已完成的工作

### 1. 数据模型更新

#### Settings.js
- 添加 `swapWallets` 字段：存储闪兑专用钱包列表（JSON格式）
- 修改 `swapRateMode` 默认值为 `'realtime'`（推荐实时模式）
- 钱包结构：`{ id, name, address, privateKeyEncrypted, enabled, priority, createdAt }`

#### SwapOrder.js
- 添加 `systemWalletId` 字段：记录使用的闪兑钱包ID
- 用于后续查找钱包配置和发送TRX

### 2. 后端服务更新

#### swapService.js

**新增功能**：
1. `selectSwapWallet()` - 选择可用的闪兑钱包
   - 筛选启用的钱包
   - 按优先级排序
   - 返回优先级最高的钱包

2. `getSwapWalletById(walletId)` - 根据ID获取钱包配置
   - 从 Settings 中解析钱包列表
   - 查找指定ID的钱包

**修改功能**：
1. `checkOrderReceive()` - 使用闪兑钱包ID查找钱包
2. `processSendTRX()` - 从收款钱包发送TRX
3. `initTronWeb()` - 使用闪兑钱包的私钥初始化

**汇率逻辑**：
- 实时模式：从 Binance API 获取 TRX/USDT 交易对价格
- 备用方案：CoinGecko API
- 手动模式：使用管理员设置的固定汇率
- 加成计算：`finalRate = baseRate * (1 - markup / 100)`

### 3. 后端路由更新

#### swap.js

**新增API**：

1. `POST /api/swap/admin/add-wallet` - 添加闪兑钱包
   - 验证私钥格式
   - 获取钱包地址
   - 加密存储私钥
   - 检查地址是否重复

2. `POST /api/swap/admin/toggle-wallet` - 切换钱包启用状态
   - 切换 `enabled` 字段
   - 更新 Settings

3. `POST /api/swap/admin/delete-wallet` - 删除闪兑钱包
   - 从列表中移除
   - 更新 Settings

**修改API**：

1. `POST /api/swap/create` - 创建闪兑订单
   - 使用 `selectSwapWallet()` 选择钱包
   - 记录 `systemWalletId`
   - 显示汇率模式信息

### 4. 前端页面更新

#### SwapSystemPage.jsx

**新增Tab**: `swap-wallets` - 闪兑钱包管理

**功能**：
1. 钱包列表显示
   - 钱包名称、地址、状态
   - 优先级、创建时间
   - 启用/禁用开关
   - 删除按钮

2. 添加钱包表单
   - 钱包名称输入
   - 私钥输入（可显示/隐藏）
   - 优先级设置（1-100）
   - 验证和保存

3. 钱包管理操作
   - `handleAddSwapWallet()` - 添加钱包
   - `handleToggleSwapWallet()` - 切换状态
   - `handleDeleteSwapWallet()` - 删除钱包

**UI优化**：
- 添加说明提示框
- 空状态提示
- 加载状态处理
- 错误提示

#### AdminLayout.jsx
- 在闪兑系统菜单中添加"闪兑钱包"子菜单
- 调整菜单顺序：钱包管理 → 汇率设置 → 限额配置

### 5. 工作流程

#### 用户创建闪兑订单：
```
1. 用户填写兑换金额和接收地址
2. 系统获取实时汇率（从 Binance）
3. 系统选择优先级最高的闪兑钱包
4. 创建订单，显示收款地址（闪兑钱包地址）
5. 用户转 USDT 到该地址
```

#### 系统处理订单：
```
1. 监控服务检测到 USDT 转入
2. 确认金额匹配（允许±1%误差）
3. 从同一个钱包发送 TRX 到用户地址
4. 更新订单状态为完成
5. 发送邮件通知（如果提供了邮箱）
```

## 📊 数据结构

### 闪兑钱包配置
```json
{
  "id": "1738425600000",
  "name": "闪兑钱包1",
  "address": "TXxx...xxx",
  "privateKeyEncrypted": "encrypted_key",
  "enabled": true,
  "priority": 90,
  "createdAt": "2026-02-01T10:00:00.000Z"
}
```

### 闪兑订单
```json
{
  "orderNumber": "SWAP-xxx-xxx",
  "userAddress": "TYyy...yyy",
  "fromAmount": 100,
  "toAmount": 670,
  "exchangeRate": 6.7,
  "systemWalletAddress": "TXxx...xxx",
  "systemWalletId": "1738425600000",
  "status": "completed"
}
```

## 🎯 关键特性

### 1. 汇率独立性
- ✅ 闪兑汇率完全独立于代付汇率
- ✅ 直接从交易所获取 TRX/USDT 价格
- ✅ 不依赖 CNY 汇率计算

### 2. 钱包隔离
- ✅ 闪兑使用专用钱包
- ✅ 与代付钱包完全分离
- ✅ 支持多钱包配置

### 3. 资金流转
- ✅ 用户转 USDT → 闪兑钱包A
- ✅ 闪兑钱包A → 转 TRX 给用户
- ✅ 资金流向清晰可追溯

### 4. 优先级管理
- ✅ 支持设置钱包优先级
- ✅ 自动选择优先级最高的钱包
- ✅ 灵活的钱包调度策略

## 🔧 技术实现

### 汇率获取
```javascript
// 实时模式：从 Binance 获取
const response = await axios.get('https://api.binance.com/api/v3/ticker/price', {
  params: { symbol: 'TRXUSDT' }
});
const rate = parseFloat(response.data.price);

// 备用：CoinGecko
const response = await axios.get('https://api.coingecko.com/api/v3/simple/price', {
  params: { ids: 'tether,tron', vs_currencies: 'usd' }
});
```

### 钱包选择
```javascript
// 筛选启用的钱包
const enabledWallets = swapWallets.filter(w => w.enabled);

// 按优先级排序
enabledWallets.sort((a, b) => (b.priority || 50) - (a.priority || 50));

// 选择第一个
const selectedWallet = enabledWallets[0];
```

### 资金监控
```javascript
// 监控 USDT 转入
const transactions = await getUSDTTransactions(
  tronWeb, 
  order.systemWalletAddress,
  order.createdAt
);

// 匹配订单
if (tx.from === order.userAddress && amountMatches) {
  // 发送 TRX
  await sendTRX(tronWeb, order.userAddress, order.toAmount);
}
```

## 📱 用户界面

### 后台 - 闪兑钱包管理
```
┌─────────────────────────────────────────────┐
│ 闪兑钱包管理                    [+ 添加钱包] │
├─────────────────────────────────────────────┤
│ 💡 闪兑钱包说明：                            │
│ • 用户转 USDT 到哪个钱包，TRX 就从那个钱包返回│
│ • 请确保钱包有足够的 TRX 余额用于闪兑        │
│ • 可以配置多个钱包，系统会按优先级选择       │
├─────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────┐ │
│ │ 闪兑钱包1          [已启用] 优先级: 90  │ │
│ │ TXxx...xxx                              │ │
│ │ 创建时间: 2026-02-01 10:00:00           │ │
│ │                          [开关] [删除]  │ │
│ └─────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────┐ │
│ │ 闪兑钱包2          [已禁用] 优先级: 50  │ │
│ │ TYyy...yyy                              │ │
│ │ 创建时间: 2026-02-01 11:00:00           │ │
│ │                          [开关] [删除]  │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

### 用户端 - 闪兑页面
```
┌─────────────────────────────────────────────┐
│ USDT 闪兑 TRX                                │
├─────────────────────────────────────────────┤
│ 当前汇率: 1 USDT = 6.7 TRX        [刷新]    │
│ * 已包含 2% 服务费                           │
├─────────────────────────────────────────────┤
│ 您支付                                       │
│ [100] USDT                                   │
│                                              │
│ 您将收到                                     │
│ [656.6] TRX                                  │
│                                              │
│ 接收地址（TRON）                             │
│ [T开头的TRON地址]                            │
│                                              │
│ [创建兑换订单]                               │
└─────────────────────────────────────────────┘
```

## 🔐 安全性

1. **私钥加密**：所有私钥使用 AES-256-CBC 加密存储
2. **权限控制**：只有管理员可以管理闪兑钱包
3. **地址验证**：添加钱包时验证私钥格式和地址
4. **重复检查**：防止添加重复的钱包地址
5. **资金隔离**：闪兑钱包与代付钱包完全分离

## 📝 相关文件

### 后端
- `server/models/Settings.js` - 添加 swapWallets 字段
- `server/models/SwapOrder.js` - 添加 systemWalletId 字段
- `server/services/swapService.js` - 钱包选择和管理逻辑
- `server/routes/swap.js` - 钱包管理API

### 前端
- `src/pages/SwapSystemPage.jsx` - 闪兑钱包管理界面
- `src/components/AdminLayout.jsx` - 菜单配置

## 🚀 使用指南

### 1. 配置闪兑钱包

1. 登录管理后台
2. 进入"闪兑系统" → "闪兑钱包"
3. 点击"添加钱包"
4. 填写钱包名称、私钥、优先级
5. 保存

### 2. 设置汇率

1. 进入"闪兑系统" → "汇率设置"
2. 选择"实时汇率"模式（推荐）
3. 设置汇率加成（如 2%）
4. 保存设置

### 3. 配置限额

1. 进入"闪兑系统" → "限额配置"
2. 设置最小/最大兑换金额
3. 设置订单超时时间
4. 保存设置

### 4. 用户使用

1. 用户访问闪兑页面
2. 输入兑换金额和接收地址
3. 创建订单
4. 转 USDT 到指定地址
5. 系统自动发送 TRX

## ⚠️ 注意事项

1. **钱包余额**：确保闪兑钱包有足够的 TRX 余额
2. **能量带宽**：确保钱包有足够的能量和带宽
3. **汇率模式**：推荐使用实时模式，汇率更准确
4. **优先级**：数值越大优先级越高（1-100）
5. **监控服务**：确保闪兑监控服务正常运行

## 🎯 完成状态

✅ 数据模型更新
✅ 后端服务实现
✅ API接口开发
✅ 前端界面开发
✅ 汇率逻辑修正
✅ 钱包管理功能
✅ 安全性加固
✅ 无编译错误

---

**完成时间**: 2026-02-01
**状态**: ✅ 已完成并测试通过
