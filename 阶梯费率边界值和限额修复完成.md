# 阶梯费率边界值和限额修复完成

## 修复时间
2026-02-04

## 问题描述
用户反馈阶梯费率存在两个问题：
1. **边界值匹配问题**：例如第一阶梯设置为 51-100，输入 51-99 计算正确，但输入 100 时计算不正确
2. **超限额提示缺失**：当用户输入金额超过所有规则的最大值时，没有给出提示，且最大值应根据规则自动计算

## 修复内容

### 1. 前端修复 - USDT 代付页面 (`src/pages/PayPage.jsx`)
✅ **已完成**（在之前的修复中）

- 修改匹配逻辑：从 `amt < rule.maxAmount` 改为 `amt <= rule.maxAmount`
- 添加 `getMaxAmount()` 函数：自动获取所有规则中的最大限额（排除 999999 这种无限大值）
- 添加 `checkAmountLimit()` 函数：检查用户输入是否超出限额
- 在输入框下方添加红色警告提示，显示超出限额信息
- 修改提交按钮的 `disabled` 属性，当超出限额时禁用按钮

### 2. 前端修复 - TRX 代付页面 (`src/pages/PayPageTRX.jsx`)
✅ **本次完成**

#### 修改内容：
1. **添加限额警告 UI**（第 467-473 行）
```jsx
{/* 限额警告提示 */}
{checkAmountLimit() && (
  <div className="mt-2 text-sm text-red-600 font-bold bg-red-50 px-3 py-2 rounded-lg">
    {checkAmountLimit()}
  </div>
)}
```

2. **修改提交按钮禁用条件**（第 527 行）
```jsx
disabled={!amount || !address || paymentLoading || checkAmountLimit()}
```

#### 已有功能（之前已实现）：
- `getMaxAmount()` 函数：自动计算最大限额
- `checkAmountLimit()` 函数：检查是否超出限额
- 阶梯费率匹配逻辑：使用 `<=` 包含边界值

### 3. 后端修复 - 订单创建接口 (`server/routes/payments.js`)
✅ **本次完成**

#### 修改内容（第 28-45 行）：
1. **添加限额验证**
```javascript
// 检查是否超出最大限额
const maxAmounts = rules
  .map(rule => rule.maxAmount)
  .filter(max => max < 999999);

if (maxAmounts.length > 0) {
  const maxLimit = Math.max(...maxAmounts);
  if (amt > maxLimit) {
    return res.status(400).json({ 
      error: `代付金额超出限额！最大支持 ${maxLimit} ${payType}` 
    });
  }
}
```

2. **修改边界值匹配逻辑**
```javascript
// 从 amt < rule.maxAmount 改为 amt <= rule.maxAmount
const matchedRule = rules.find(rule => 
  amt >= rule.minAmount && amt <= rule.maxAmount
);
```

## 修复效果

### 边界值匹配
- **修复前**：阶梯 51-100，输入 100 时无法匹配到规则
- **修复后**：阶梯 51-100，输入 100 时正确匹配到该规则

### 限额提示
- **修复前**：超出限额时没有提示，可以提交订单
- **修复后**：
  - 前端：输入框下方显示红色警告 "当前代付金额超出限额！最大支持 XXX TRX/USDT"
  - 前端：提交按钮自动禁用
  - 后端：即使前端绕过，后端也会返回错误提示

### 自动限额计算
- 系统自动从所有阶梯规则中提取最大值（排除 999999 这种无限大值）
- 例如规则为：1-50、51-100、101-200，系统自动识别最大限额为 200
- 用户输入 201 时，提示 "当前代付金额超出限额！最大支持 200 TRX"

## 测试建议

### 测试场景 1：边界值匹配
1. 后台设置阶梯费率：51-100 TRX，固定费用 10 CNY
2. 前台输入 100 TRX
3. **预期结果**：正确匹配到该规则，服务费显示 10 CNY

### 测试场景 2：超出限额提示
1. 后台设置阶梯费率：1-50、51-100、101-200
2. 前台输入 201 TRX
3. **预期结果**：
   - 输入框下方显示红色警告："当前代付金额超出限额！最大支持 200 TRX"
   - 提交按钮变为灰色禁用状态

### 测试场景 3：后端限额验证
1. 使用 API 工具（如 Postman）直接调用后端接口
2. 发送超出限额的订单（例如 201 TRX）
3. **预期结果**：返回 400 错误，错误信息："代付金额超出限额！最大支持 200 TRX"

## 部署说明

### 前端部署
```bash
# 重新编译前端
npm run build

# 如果使用宝塔面板，编译后的文件在 dist/ 目录
# 确保 Nginx 配置正确指向 dist/ 目录
```

### 后端部署
```bash
# 重启 PM2 进程
pm2 restart easypay

# 查看日志确认重启成功
pm2 logs easypay
```

## 相关文件
- `src/pages/PayPage.jsx` - USDT 代付页面（之前已修复）
- `src/pages/PayPageTRX.jsx` - TRX 代付页面（本次修复）
- `server/routes/payments.js` - 订单创建接口（本次修复）

## 注意事项
1. 边界值现在使用 `<=` 判断，确保最大值能被正确匹配
2. 限额计算会自动排除 999999 这种表示"无限大"的值
3. 前后端都有限额验证，确保安全性
4. 限额提示会根据配置的规则自动变化，无需手动设置

## 完成状态
✅ **全部完成**
- ✅ USDT 代付页面边界值修复
- ✅ USDT 代付页面限额提示
- ✅ TRX 代付页面边界值修复
- ✅ TRX 代付页面限额提示
- ✅ 后端边界值修复
- ✅ 后端限额验证
