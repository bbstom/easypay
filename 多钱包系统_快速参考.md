# 多钱包系统 - 快速参考指南

## 🎯 核心问题解决确认

### ✅ 问题：代付使用旧钱包地址
**状态：** 已解决

**原因：** 代付系统使用 Settings 中的旧单钱包配置

**解决方案：**
- 代付逻辑已更新为使用多钱包系统
- 通过钱包选择器自动选择最优钱包
- Settings 模型已清理旧字段

**验证：**
```bash
node server/scripts/verifyMultiWalletSystem.js
```

---

## 📊 当前系统状态

### 多钱包配置
- **钱包数量：** 1 个
- **钱包名称：** TRX
- **钱包地址：** TTY9B985W7DMuLyUP7oqoncamBJ3DkuTRX
- **TRX 余额：** 308.34
- **USDT 余额：** 137.00
- **状态：** ✅ 启用

### Settings 配置
- **旧单钱包配置：** ✅ 已清理
- **API 节点：** 多节点支持
- **能量租赁：** 已启用

### 代付系统
- **使用钱包选择器：** ✅ 是
- **使用多钱包转账：** ✅ 是
- **记录钱包信息：** ✅ 是

---

## 🔄 代付流程（简化版）

```
支付成功 → 钱包选择器 → 检查能量 → 租赁能量（如需要）→ 转账 → 更新订单
```

**关键点：**
1. 自动选择最优钱包（基于优先级、余额、负载、健康状态）
2. 自动检测能量需求（首次转账 131k，正常 65k）
3. 自动租赁能量（如果启用且不足）
4. 记录使用的钱包信息到订单

---

## 🛠️ 常用操作

### 1. 添加新钱包

**方式 1：管理后台**
- 登录管理后台
- 进入"代付系统" → "钱包配置"
- 点击"添加钱包"
- 填写钱包信息并保存

**方式 2：数据库直接添加**
```javascript
const Wallet = require('./server/models/Wallet');
const { encryptPrivateKey, getMasterKey } = require('./server/utils/encryption');

const wallet = await Wallet.create({
  name: '钱包名称',
  address: 'T...',
  privateKeyEncrypted: encryptPrivateKey(privateKey, getMasterKey()),
  enabled: true,
  priority: 50
});
```

### 2. 更新钱包余额

**自动更新：** 每次转账后自动更新

**手动更新：**
```bash
node server/scripts/refreshWallets.js
```

### 3. 查看钱包状态

```bash
node server/scripts/listWallets.js
```

### 4. 测试完整流程

```bash
node server/scripts/testCompletePaymentFlow.js
```

### 5. 检查订单状态

```bash
node server/scripts/checkOrderStatus.js <订单号>
```

---

## 🔍 故障排查

### 问题：代付失败

**检查步骤：**

1. **检查钱包余额**
   ```bash
   node server/scripts/listWallets.js
   ```
   - TRX 余额是否充足（至少 50 TRX）
   - USDT 余额是否充足

2. **检查钱包状态**
   - 钱包是否启用（enabled: true）
   - 健康状态是否正常（status: healthy）

3. **检查能量配置**
   - 能量租赁是否启用
   - 租赁地址是否正确（转账模式）
   - API Key 是否正确（CatFee 模式）

4. **查看日志**
   - 服务器控制台输出
   - 查找错误信息

### 问题：钱包选择不符合预期

**调整优先级：**
- 优先级范围：1-100
- 数值越高，优先级越高
- 在管理后台修改钱包优先级

**评分规则：**
- 优先级：40 分
- 余额充足度：30 分
- 负载均衡：20 分
- 健康状态：10 分

### 问题：能量租赁失败

**转账模式：**
- 检查租赁地址是否正确
- 检查 TRX 余额是否充足
- 检查等待时间设置（建议 30 秒）

**CatFee 模式：**
- 检查 API Key 格式（api_key:api_secret）
- 检查 API URL 是否正确
- 检查网络连接

---

## 📝 配置文件位置

### 数据库模型
- `server/models/Wallet.js` - 钱包模型
- `server/models/Payment.js` - 订单模型
- `server/models/Settings.js` - 系统配置

### 核心服务
- `server/services/walletSelector.js` - 钱包选择器
- `server/services/tronService.js` - TRON 转账服务
- `server/services/catfeeService.js` - CatFee 能量服务

### 路由
- `server/routes/payments.js` - 代付路由（核心）
- `server/routes/wallets.js` - 钱包管理路由

### 测试脚本
- `server/scripts/verifyMultiWalletSystem.js` - 系统验证
- `server/scripts/testCompletePaymentFlow.js` - 完整流程测试
- `server/scripts/listWallets.js` - 查看钱包列表
- `server/scripts/refreshWallets.js` - 刷新钱包余额

---

## ⚡ 性能优化建议

### 1. 能量管理
- **推荐：** 使用 CatFee API 模式（更快、更稳定）
- **配置：** 首次转账 131k 能量，正常转账 65k 能量
- **成本：** 约 3 TRX/次（比直接支付 gas 节省 70-80%）

### 2. 钱包配置
- **数量：** 建议 2-3 个钱包（负载均衡）
- **余额：** 每个钱包保持 100+ TRX，200+ USDT
- **优先级：** 根据余额和使用频率调整

### 3. 监控预警
- **TRX 预警：** < 50 TRX
- **USDT 预警：** < 100 USDT
- **能量预警：** < 50,000

---

## 🔐 安全建议

### 1. 私钥管理
- ✅ 私钥已加密存储
- ✅ 使用主密钥加密（环境变量）
- ⚠️ 定期备份数据库
- ⚠️ 不要在日志中输出私钥

### 2. 钱包隔离
- 建议使用专用钱包进行代付
- 不要使用个人钱包或交易所钱包
- 定期转出收益到安全钱包

### 3. 访问控制
- 钱包管理仅限管理员
- API 接口需要认证
- 定期审计操作日志

---

## 📞 技术支持

### 相关文档
- [多钱包系统设计方案](./多钱包系统设计方案.md)
- [多钱包系统问题修复总结](./多钱包系统_问题修复总结.md)
- [能量租赁功能说明](./能量租赁功能说明.md)

### 常见问题
- 代付失败：检查余额和能量
- 钱包选择：调整优先级
- 能量租赁：检查配置和余额

---

**最后更新：** 2026-02-02  
**系统版本：** 多钱包系统 v2.0  
**状态：** ✅ 生产就绪
