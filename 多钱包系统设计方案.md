# 多钱包系统设计方案

## 项目概述

实现高级多钱包管理系统，支持：
- ✅ 自由添加/删除钱包
- ✅ 智能选择最优钱包
- ✅ 自动健康检查
- ✅ 失败自动切换
- ✅ 余额监控预警
- ✅ 使用统计分析

## 核心功能

### 1. 钱包管理
- 添加钱包（名称、私钥）
- 编辑钱包信息
- 启用/禁用钱包
- 删除钱包
- 设置优先级

### 2. 智能调度
- **余额优先**: 选择余额充足的钱包
- **负载均衡**: 分散使用频率
- **健康检查**: 自动排除故障钱包
- **失败重试**: 自动切换到备用钱包

### 3. 监控面板
- 实时余额显示
- 使用统计
- 健康状态
- 交易历史

### 4. 预警系统
- 余额不足预警
- 能量不足预警
- 钱包异常预警

## 数据模型设计

### Wallet 模型

```javascript
{
  _id: ObjectId,
  name: String,              // 钱包名称（如：主钱包、备用钱包1）
  address: String,           // 钱包地址
  privateKeyEncrypted: String, // 加密的私钥
  enabled: Boolean,          // 是否启用
  priority: Number,          // 优先级（1-100，数字越大优先级越高）
  
  // 余额信息
  balance: {
    trx: Number,            // TRX 余额
    usdt: Number,           // USDT 余额
    lastUpdated: Date       // 最后更新时间
  },
  
  // 资源信息
  resources: {
    energy: {
      available: Number,    // 可用能量
      limit: Number,        // 能量限制
      used: Number          // 已用能量
    },
    bandwidth: {
      available: Number,    // 可用带宽
      limit: Number,
      used: Number
    },
    lastUpdated: Date
  },
  
  // 使用统计
  stats: {
    totalTransactions: Number,  // 总交易数
    successCount: Number,       // 成功次数
    failCount: Number,          // 失败次数
    lastUsedAt: Date,           // 最后使用时间
    totalAmount: {
      trx: Number,
      usdt: Number
    }
  },
  
  // 健康状态
  health: {
    status: String,        // 'healthy', 'warning', 'error', 'disabled'
    lastCheckAt: Date,     // 最后检查时间
    errorMessage: String,  // 错误信息
    consecutiveFailures: Number  // 连续失败次数
  },
  
  // 预警设置
  alerts: {
    minTrxBalance: Number,   // TRX 最低余额预警
    minUsdtBalance: Number,  // USDT 最低余额预警
    minEnergy: Number,       // 最低能量预警
    enabled: Boolean         // 是否启用预警
  },
  
  createdAt: Date,
  updatedAt: Date
}
```

### Payment 模型扩展

```javascript
{
  // ... 现有字段
  
  // 新增字段
  walletId: ObjectId,        // 使用的钱包ID
  walletAddress: String,     // 钱包地址（冗余，便于查询）
  walletName: String,        // 钱包名称（冗余）
}
```

## 智能调度算法

### 选择钱包的优先级

```
1. 过滤条件（必须满足）
   - enabled = true
   - health.status != 'error'
   - balance.trx >= 需要的金额 + 手续费
   - balance.usdt >= 需要的金额（如果是USDT转账）

2. 评分系统（0-100分）
   - 优先级权重：40%
   - 余额充足度：30%
   - 负载均衡：20%
   - 健康状态：10%

3. 选择得分最高的钱包
```

### 评分计算

```javascript
function calculateScore(wallet, transferAmount, transferType) {
  let score = 0;
  
  // 1. 优先级得分（40分）
  score += (wallet.priority / 100) * 40;
  
  // 2. 余额充足度（30分）
  const balance = transferType === 'USDT' ? wallet.balance.usdt : wallet.balance.trx;
  const sufficiency = balance / (transferAmount * 10); // 余额是需求的10倍得满分
  score += Math.min(sufficiency, 1) * 30;
  
  // 3. 负载均衡（20分）
  const hoursSinceLastUse = (Date.now() - wallet.stats.lastUsedAt) / (1000 * 60 * 60);
  const loadScore = Math.min(hoursSinceLastUse / 24, 1); // 24小时未用得满分
  score += loadScore * 20;
  
  // 4. 健康状态（10分）
  const healthScore = wallet.health.status === 'healthy' ? 1 : 
                     wallet.health.status === 'warning' ? 0.5 : 0;
  score += healthScore * 10;
  
  return score;
}
```

## API 设计

### 钱包管理 API

```
GET    /api/wallets              获取钱包列表
POST   /api/wallets              添加钱包
GET    /api/wallets/:id          获取钱包详情
PUT    /api/wallets/:id          更新钱包
DELETE /api/wallets/:id          删除钱包
POST   /api/wallets/:id/enable   启用钱包
POST   /api/wallets/:id/disable  禁用钱包
POST   /api/wallets/:id/refresh  刷新钱包状态
GET    /api/wallets/:id/stats    获取钱包统计
```

### 钱包操作 API

```
POST   /api/wallets/validate     验证私钥
POST   /api/wallets/select       选择最优钱包
GET    /api/wallets/health       健康检查
POST   /api/wallets/refresh-all  刷新所有钱包
```

## 服务层设计

### WalletService

```javascript
class WalletService {
  // 钱包管理
  async createWallet(data)
  async updateWallet(id, data)
  async deleteWallet(id)
  async getWallet(id)
  async listWallets(filter)
  
  // 钱包操作
  async enableWallet(id)
  async disableWallet(id)
  async validatePrivateKey(privateKey)
  
  // 状态更新
  async refreshWalletBalance(id)
  async refreshWalletResources(id)
  async refreshAllWallets()
  
  // 健康检查
  async checkWalletHealth(id)
  async checkAllWalletsHealth()
  
  // 统计
  async getWalletStats(id)
  async updateWalletStats(id, transaction)
}
```

### WalletSelector

```javascript
class WalletSelector {
  // 智能选择
  async selectBestWallet(amount, type, options)
  
  // 评分系统
  calculateScore(wallet, amount, type)
  
  // 过滤
  filterAvailableWallets(wallets, amount, type)
  
  // 排序
  sortWalletsByScore(wallets, scores)
}
```

### TronService 改造

```javascript
class TronService {
  constructor() {
    this.walletInstances = new Map(); // walletId -> TronWeb实例
  }
  
  // 获取或创建钱包实例
  async getWalletInstance(walletId)
  
  // 使用指定钱包转账
  async sendUSDTWithWallet(walletId, toAddress, amount)
  async sendTRXWithWallet(walletId, toAddress, amount)
  
  // 获取钱包状态
  async getWalletBalance(walletId)
  async getWalletResources(walletId)
}
```

## 前端界面设计

### 1. 钱包列表页面

```
┌─────────────────────────────────────────────────────┐
│ 钱包管理                          [+ 添加钱包]      │
├─────────────────────────────────────────────────────┤
│                                                     │
│ ┌─────────────────────────────────────────────┐   │
│ │ 主钱包                    [✓ 启用] [编辑]   │   │
│ │ TXxx...xxx                                   │   │
│ │ TRX: 1,234.56  USDT: 5,678.90               │   │
│ │ 能量: 50,000   带宽: 5,000                  │   │
│ │ 状态: 健康 ● | 优先级: 90 | 使用: 123次    │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
│ ┌─────────────────────────────────────────────┐   │
│ │ 备用钱包1                 [✗ 禁用] [编辑]   │   │
│ │ TYyy...yyy                                   │   │
│ │ TRX: 234.56    USDT: 1,234.90               │   │
│ │ 能量: 20,000   带宽: 2,000                  │   │
│ │ 状态: 警告 ⚠ | 优先级: 50 | 使用: 45次     │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 2. 添加/编辑钱包对话框

```
┌─────────────────────────────────────┐
│ 添加钱包                    [×]     │
├─────────────────────────────────────┤
│                                     │
│ 钱包名称                            │
│ [主钱包___________________]         │
│                                     │
│ 私钥（64位十六进制）                │
│ [**********************] [👁]       │
│                                     │
│ 优先级（1-100）                     │
│ [90_____] ━━━━━━━━━━━━━━━━         │
│                                     │
│ 预警设置                            │
│ TRX 最低余额: [50____] TRX         │
│ USDT 最低余额: [100___] USDT       │
│ 最低能量: [50000_] 能量             │
│                                     │
│ [☑] 启用此钱包                      │
│ [☑] 启用余额预警                    │
│                                     │
│         [取消]  [验证并保存]        │
└─────────────────────────────────────┘
```

### 3. 钱包详情页面

```
┌─────────────────────────────────────────────────────┐
│ ← 返回   主钱包                    [刷新] [编辑]      │
├─────────────────────────────────────────────────────┤
│                                                     │
│ 基本信息                                             │
│ ┌─────────────────────────────────────────────┐     │
│ │ 地址: TXxx...xxx                [复制]      │      │
│ │ 状态: ● 健康                                │   │
│ │ 优先级: 90                                  │   │
│ │ 创建时间: 2025-01-30 10:00:00              │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
│ 余额信息                                            │
│ ┌─────────────────────────────────────────────┐   │
│ │ TRX:  1,234.56  [正常]                      │   │
│ │ USDT: 5,678.90  [正常]                      │   │
│ │ 最后更新: 2分钟前                           │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
│ 资源信息                                            │
│ ┌─────────────────────────────────────────────┐   │
│ │ 能量: 50,000 / 100,000  [50%] ━━━━━━━━     │   │
│ │ 带宽: 5,000 / 10,000    [50%] ━━━━━━━━     │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
│ 使用统计                                            │
│ ┌─────────────────────────────────────────────┐   │
│ │ 总交易: 123 笔                              │   │
│ │ 成功: 120 笔 | 失败: 3 笔                   │   │
│ │ 成功率: 97.6%                               │   │
│ │ 最后使用: 5分钟前                           │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
│ 最近交易                                            │
│ ┌─────────────────────────────────────────────┐   │
│ │ 2025-01-30 14:30  USDT  100.00  成功 ✓     │   │
│ │ 2025-01-30 14:25  TRX   50.00   成功 ✓     │   │
│ │ 2025-01-30 14:20  USDT  200.00  失败 ✗     │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │
└─────────────────────────────────────────────────────┘
```

│ 余额信息                                            │
│ ┌─────────────────────────────────────────────┐   │
│ │ TRX:  1,234.56  [正常]                      │   │
│ │ USDT: 5,678.90  [正常]                      │   │
│ │ 最后更新: 2分钟前                           │   │
│ └─────────────────────────────────────────────┘   │


│ 使用统计                                            │
│ ┌─────────────────────────────────────────────┐   │
│ │ 总交易: 123 笔                              │   │
│ │ 成功: 120 笔 | 失败: 3 笔                   │   │
│ │ 成功率: 97.6%                               │   │
│ │ 最后使用: 5分钟前                           │   │
│ └─────────────────────────────────────────────┘   │

│ 最近交易                                            │
│ ┌─────────────────────────────────────────────┐   │
│ │ 2025-01-30 14:30  USDT  100.00  成功 ✓     │   │
│ │ 2025-01-30 14:25  TRX   50.00   成功 ✓     │   │
│ │ 2025-01-30 14:20  USDT  200.00  失败 ✗     │   │
│ └─────────────────────────────────────────────┘   │
│                                                     │


## 实施步骤

### 阶段 1: 数据模型和基础服务（第1天）
1. ✅ 创建 Wallet 模型
2. ✅ 创建 WalletService
3. ✅ 实现基础 CRUD 操作
4. ✅ 数据迁移脚本（从旧的单钱包迁移）

### 阶段 2: 智能调度系统（第2天）
1. ✅ 实现 WalletSelector
2. ✅ 实现评分算法
3. ✅ 实现健康检查
4. ✅ 改造 TronService

### 阶段 3: API 接口（第3天）
1. ✅ 实现钱包管理 API
2. ✅ 实现钱包操作 API
3. ✅ 集成到转账流程
4. ✅ 添加日志记录

### 阶段 4: 前端界面（第4-5天）
1. ✅ 钱包列表页面
2. ✅ 添加/编辑钱包
3. ✅ 钱包详情页面
4. ✅ 状态监控面板

### 阶段 5: 测试和优化（第6-7天）
1. ✅ 单元测试
2. ✅ 集成测试
3. ✅ 性能优化
4. ✅ 文档编写

## 兼容性处理

### 向后兼容
- 保留 Settings 中的旧钱包配置
- 首次启动时自动迁移到新的 Wallet 模型
- 如果没有配置多钱包，使用默认钱包

### 迁移策略
```javascript
// 首次启动时执行
async function migrateToMultiWallet() {
  const settings = await Settings.findOne();
  const walletCount = await Wallet.countDocuments();
  
  // 如果已有钱包，跳过迁移
  if (walletCount > 0) return;
  
  // 如果有旧的钱包配置，迁移
  if (settings.tronPrivateKeyEncrypted) {
    await Wallet.create({
      name: '默认钱包',
      address: settings.tronWalletAddress,
      privateKeyEncrypted: settings.tronPrivateKeyEncrypted,
      enabled: true,
      priority: 100
    });
  }
}
```

## 安全考虑

1. **私钥加密**: 使用 AES-256-GCM 加密存储
2. **权限控制**: 只有管理员可以管理钱包
3. **操作日志**: 记录所有钱包操作
4. **敏感信息**: 前端不显示完整私钥
5. **API 保护**: 所有 API 需要认证

## 性能优化

1. **缓存**: 缓存钱包余额和资源信息（5分钟）
2. **批量更新**: 定时批量刷新所有钱包状态
3. **异步处理**: 健康检查异步执行
4. **索引**: 为常用查询字段添加索引

## 监控和告警

1. **余额监控**: 定时检查余额，低于阈值发送告警
2. **健康监控**: 定时健康检查，异常时告警
3. **使用统计**: 记录每个钱包的使用情况
4. **性能监控**: 监控选择钱包的耗时

## 文档

1. ✅ 设计文档（本文档）
2. ✅ API 文档
3. ✅ 用户手册
4. ✅ 运维手册
5. ✅ 故障排查指南

## 预期效果

- ✅ 支持无限数量钱包
- ✅ 自动选择最优钱包
- ✅ 失败自动切换
- ✅ 实时监控预警
- ✅ 提高系统可用性
- ✅ 降低单点故障风险
- ✅ 提升转账成功率

## 开始实施

准备好了吗？我会按照以上计划逐步实施。

第一步：创建 Wallet 数据模型和基础服务。

是否开始？
