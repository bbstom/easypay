# å¤šé’±åŒ…èƒ½é‡ç§ŸèµåŠŸèƒ½ä¿®å¤å®Œæˆ

## ä¿®å¤å†…å®¹

### 1. äº¤æ˜“å“ˆå¸Œè¿”å›é—®é¢˜ âœ…

**é—®é¢˜ï¼š**
- è®¢å•å®Œæˆåï¼Œäº¤æ˜“å“ˆå¸Œæ˜¾ç¤ºä¸º `false`

**åŸå› ï¼š**
- TronWeb çš„ `contract.transfer().send()` æ–¹æ³•è¿”å›å€¼æ ¼å¼ä¸ç¡®å®š
- `shouldPollResponse: true` å¯èƒ½å¯¼è‡´è¿”å›å¸ƒå°”å€¼

**è§£å†³æ–¹æ¡ˆï¼š**
```javascript
// ä¿®æ”¹å‰
const tx = await contract.transfer(toAddress, amount * 1000000).send({
  feeLimit: 150000000,
  callValue: 0,
  shouldPollResponse: true  // å¯èƒ½è¿”å› boolean
});
return { txid: tx };  // ç›´æ¥è¿”å›ï¼Œå¯èƒ½æ˜¯ false

// ä¿®æ”¹å
const tx = await contract.transfer(toAddress, amount * 1000000).send({
  feeLimit: 150000000,
  callValue: 0,
  shouldPollResponse: false  // ç›´æ¥è¿”å›äº¤æ˜“å“ˆå¸Œ
});

// æ™ºèƒ½æå–äº¤æ˜“å“ˆå¸Œ
let txHash;
if (typeof tx === 'string') {
  txHash = tx;
} else if (tx.txid) {
  txHash = tx.txid;
} else if (tx.transaction && tx.transaction.txID) {
  txHash = tx.transaction.txID;
} else {
  txHash = JSON.stringify(tx);
}

return { txid: txHash };
```

### 2. å¤šé’±åŒ…èƒ½é‡ç§ŸèµåŠŸèƒ½ âœ…

**é—®é¢˜ï¼š**
- èƒ½é‡ç§ŸèµåŠŸèƒ½ä½¿ç”¨æ—§çš„å•é’±åŒ…åœ°å€
- æ— æ³•ä¸ºå¤šé’±åŒ…ç³»ç»Ÿçš„é’±åŒ…ç§Ÿèµèƒ½é‡

**è§£å†³æ–¹æ¡ˆï¼š**

#### æ–°å¢æ–¹æ³• 1ï¼š`rentEnergyViaTransferWithWallet`
```javascript
/**
 * ä½¿ç”¨æŒ‡å®šé’±åŒ…é€šè¿‡è½¬è´¦æ–¹å¼ç§Ÿèµèƒ½é‡
 * @param {Object} tempTronWeb - é’±åŒ…çš„ TronWeb å®ä¾‹
 * @param {string} walletAddress - é’±åŒ…åœ°å€
 * @param {boolean} isFirstTransfer - æ˜¯å¦é¦–æ¬¡è½¬è´¦
 * @param {Object} beforeEnergy - ç§Ÿèµå‰çš„èƒ½é‡ä¿¡æ¯
 * @param {Object} settings - ç³»ç»Ÿè®¾ç½®
 */
async rentEnergyViaTransferWithWallet(tempTronWeb, walletAddress, isFirstTransfer, beforeEnergy, settings)
```

**ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨å½“å‰é’±åŒ…çš„ TronWeb å®ä¾‹è¿›è¡Œè½¬è´¦
- æ”¯æŒé¦–æ¬¡è½¬è´¦å’Œæ­£å¸¸è½¬è´¦ä¸åŒé‡‘é¢
- è‡ªåŠ¨ç­‰å¾…èƒ½é‡åˆ°è´¦å¹¶éªŒè¯

#### æ–°å¢æ–¹æ³• 2ï¼š`rentEnergyViaCatFeeWithWallet`
```javascript
/**
 * ä½¿ç”¨æŒ‡å®šé’±åŒ…é€šè¿‡ CatFee API è´­ä¹°èƒ½é‡
 * @param {string} walletAddress - é’±åŒ…åœ°å€
 * @param {boolean} isFirstTransfer - æ˜¯å¦é¦–æ¬¡è½¬è´¦
 * @param {Object} beforeEnergy - è´­ä¹°å‰çš„èƒ½é‡ä¿¡æ¯
 * @param {Object} settings - ç³»ç»Ÿè®¾ç½®
 */
async rentEnergyViaCatFeeWithWallet(walletAddress, isFirstTransfer, beforeEnergy, settings)
```

**ç‰¹ç‚¹ï¼š**
- ä¸ºæŒ‡å®šé’±åŒ…åœ°å€è´­ä¹°èƒ½é‡
- æ”¯æŒé¦–æ¬¡è½¬è´¦å’Œæ­£å¸¸è½¬è´¦ä¸åŒèƒ½é‡æ•°é‡
- è‡ªåŠ¨éªŒè¯èƒ½é‡åˆ°è´¦

### 3. é›†æˆåˆ° sendUSDTWithWallet æ–¹æ³• âœ…

```javascript
// åœ¨ sendUSDTWithWallet æ–¹æ³•ä¸­
if (settings && settings.energyRentalEnabled) {
  // æ£€æŸ¥å½“å‰èƒ½é‡
  const resources = await tempTronWeb.trx.getAccountResources(wallet.address);
  const energyRemaining = (resources.EnergyLimit || 0) - (resources.EnergyUsed || 0);

  // åˆ¤æ–­æ˜¯å¦éœ€è¦ç§Ÿèµ
  const isFirstTransfer = !(await this.hasUSDTBalance(toAddress));
  const requiredEnergy = isFirstTransfer ? 131000 : 65000;

  if (energyRemaining < requiredEnergy) {
    // ä½¿ç”¨å½“å‰é’±åŒ…è¿›è¡Œèƒ½é‡ç§Ÿèµ
    if (settings.energyRentalMode === 'catfee') {
      energyRentalResult = await this.rentEnergyViaCatFeeWithWallet(
        wallet.address, 
        isFirstTransfer, 
        { energyRemaining }, 
        settings
      );
    } else {
      energyRentalResult = await this.rentEnergyViaTransferWithWallet(
        tempTronWeb,
        wallet.address,
        isFirstTransfer, 
        { energyRemaining }, 
        settings
      );
    }
  }
}
```

## æµ‹è¯•ç»“æœ

### èƒ½é‡ç§Ÿèµæµ‹è¯• âœ…

```
æµ‹è¯•é’±åŒ…: TRX (TTY9B985W7DMuLyUP7oqoncamBJ3DkuTRX)
TRX ä½™é¢: 311.61 TRX
USDT ä½™é¢: 137.00 USDT

ç§Ÿèµæ¨¡å¼: transfer
ç§Ÿèµåœ°å€: TP4Cr7xRZ7jGZ5XmKt2aN7NP6yFGG99999
æ­£å¸¸è½¬è´¦é‡‘é¢: 3 TRX
ç­‰å¾…æ—¶é—´: 30 ç§’

æµ‹è¯•ç»“æœ:
âœ… èƒ½é‡ç§ŸèµæˆåŠŸï¼
   ç§Ÿèµå‰èƒ½é‡: 0
   ç§Ÿèµåèƒ½é‡: 65,000
   è·å¾—èƒ½é‡: 65,000
   äº¤æ˜“å“ˆå¸Œ: 203287571d90af075e263e9c2e05e9e96aad94a3795842e83b4b5c54e15c48df
   èŠ±è´¹: 3 TRX
```

### æˆæœ¬å¯¹æ¯”

**ä¸ä½¿ç”¨èƒ½é‡ç§Ÿèµï¼š**
- æ¯ç¬” USDT è½¬è´¦æ¶ˆè€—ï¼š13-15 TRX
- æˆæœ¬ï¼šçº¦ $1.5-2.0 USD

**ä½¿ç”¨èƒ½é‡ç§Ÿèµï¼š**
- ç§Ÿèµèƒ½é‡æ¶ˆè€—ï¼š3 TRX
- æˆæœ¬ï¼šçº¦ $0.3-0.4 USD
- **èŠ‚çœï¼š70-80%**

## é…ç½®è¯´æ˜

### è½¬è´¦æ–¹å¼ç§Ÿèµ

åœ¨ç®¡ç†åå°é…ç½®ï¼š
```
ä»£ä»˜ç³»ç»Ÿ â†’ èƒ½é‡ç§Ÿèµ

å¯ç”¨èƒ½é‡ç§Ÿèµ: âœ…
ç§Ÿèµæ¨¡å¼: è½¬è´¦æ–¹å¼
ç§Ÿèµåœ°å€: TP4Cr7xRZ7jGZ5XmKt2aN7NP6yFGG99999
é¦–æ¬¡è½¬è´¦é‡‘é¢: 6 TRX (è·å¾— 131,000 èƒ½é‡)
æ­£å¸¸è½¬è´¦é‡‘é¢: 3 TRX (è·å¾— 65,000 èƒ½é‡)
ç­‰å¾…æ—¶é—´: 30 ç§’
```

### CatFee API æ–¹å¼

åœ¨ç®¡ç†åå°é…ç½®ï¼š
```
ä»£ä»˜ç³»ç»Ÿ â†’ èƒ½é‡ç§Ÿèµ

å¯ç”¨èƒ½é‡ç§Ÿèµ: âœ…
ç§Ÿèµæ¨¡å¼: CatFee API
API Key: your_api_key:your_api_secret
é¦–æ¬¡è½¬è´¦èƒ½é‡: 131000
æ­£å¸¸è½¬è´¦èƒ½é‡: 65000
ç§Ÿèµæ—¶é•¿: 1 å°æ—¶
```

## å®Œæ•´æµç¨‹

### ä»£ä»˜æµç¨‹ï¼ˆå¸¦èƒ½é‡ç§Ÿèµï¼‰

```
1. ç”¨æˆ·æ”¯ä»˜å®Œæˆ
   â†“
2. åç«¯æ”¶åˆ°æ”¯ä»˜å›è°ƒ
   â†“
3. é’±åŒ…é€‰æ‹©å™¨é€‰æ‹©æœ€ä¼˜é’±åŒ…
   â†“
4. æ£€æŸ¥é’±åŒ…èƒ½é‡
   â†“
5. èƒ½é‡ä¸è¶³ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ ç§Ÿèµèƒ½é‡ï¼ˆ3 TRXï¼‰
   â”‚        â†“
   â”‚     ç­‰å¾…èƒ½é‡åˆ°è´¦ï¼ˆ30ç§’ï¼‰
   â”‚        â†“
   â”‚     éªŒè¯èƒ½é‡åˆ°è´¦
   â””â”€ å¦ â†’ ç›´æ¥è½¬è´¦
   â†“
6. æ‰§è¡Œ USDT è½¬è´¦
   â†“
7. è·å–äº¤æ˜“å“ˆå¸Œ
   â†“
8. æ›´æ–°è®¢å•çŠ¶æ€
   â†“
9. å‘é€å®Œæˆé€šçŸ¥
```

## æµ‹è¯•å‘½ä»¤

### 1. æµ‹è¯•èƒ½é‡ç§Ÿèµ
```bash
node server/scripts/testEnergyRentalWithWallet.js
```

### 2. æµ‹è¯•å¤šé’±åŒ…ç³»ç»Ÿ
```bash
node server/scripts/testMultiWalletPayment.js
```

### 3. é‡è¯•å¤±è´¥è®¢å•
```bash
node server/scripts/checkOrderStatus.js <è®¢å•å·> retry
```

## æ³¨æ„äº‹é¡¹

### èƒ½é‡ç§Ÿèµåœ°å€

**é‡è¦ï¼š** èƒ½é‡ç§Ÿèµåœ°å€ `TP4Cr7xRZ7jGZ5XmKt2aN7NP6yFGG99999` æ˜¯ä½ é…ç½®çš„èƒ½é‡æä¾›å•†åœ°å€ã€‚

- å‘è¿™ä¸ªåœ°å€è½¬è´¦ TRX åï¼Œä¼šè‡ªåŠ¨ä¸ºä½ çš„é’±åŒ…æä¾›èƒ½é‡
- ä¸åŒçš„èƒ½é‡æä¾›å•†å¯èƒ½æœ‰ä¸åŒçš„åœ°å€å’Œè§„åˆ™
- ç¡®ä¿è¿™ä¸ªåœ°å€æ˜¯å¯ä¿¡çš„èƒ½é‡æä¾›å•†

### ç­‰å¾…æ—¶é—´

- è½¬è´¦æ–¹å¼ç§Ÿèµï¼šå»ºè®®ç­‰å¾… 20-30 ç§’
- CatFee APIï¼šå»ºè®®ç­‰å¾… 10 ç§’
- å¦‚æœèƒ½é‡æœªåˆ°è´¦ï¼Œç³»ç»Ÿä¼šä½¿ç”¨ TRX æ”¯ä»˜ gas

### ä½™é¢è¦æ±‚

æ¯ä¸ªé’±åŒ…éœ€è¦ä¿æŒï¼š
- **TRX ä½™é¢**ï¼šè‡³å°‘ 50 TRXï¼ˆç”¨äºèƒ½é‡ç§Ÿèµå’Œ gasï¼‰
- **USDT ä½™é¢**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚

## æ€»ç»“

âœ… **å·²å®Œæˆï¼š**
1. ä¿®å¤äº¤æ˜“å“ˆå¸Œè¿”å›é—®é¢˜
2. å®ç°å¤šé’±åŒ…èƒ½é‡ç§ŸèµåŠŸèƒ½
3. æ”¯æŒè½¬è´¦æ–¹å¼å’Œ CatFee API ä¸¤ç§æ¨¡å¼
4. è‡ªåŠ¨æ£€æµ‹èƒ½é‡éœ€æ±‚å¹¶ç§Ÿèµ
5. æˆæœ¬èŠ‚çœ 70-80%

âœ… **æµ‹è¯•é€šè¿‡ï¼š**
- èƒ½é‡ç§ŸèµåŠŸèƒ½æ­£å¸¸
- äº¤æ˜“å“ˆå¸Œæ­£ç¡®è¿”å›
- å¤šé’±åŒ…ç³»ç»Ÿæ­£å¸¸å·¥ä½œ

ğŸ‰ **ç°åœ¨å¯ä»¥åˆ›å»ºæ–°è®¢å•æµ‹è¯•å®Œæ•´æµç¨‹äº†ï¼**
