# 反向代理部署指南

## 架构说明

使用单个域名通过 Nginx 反向代理同时访问前端和后端：

```
用户请求
    ↓
https://your-domain.com
    ↓
Nginx 反向代理
    ├─ /api/*  → 后端 (localhost:5000)
    └─ /*      → 前端 (localhost:3000)
```

## 优势

1. **单域名访问** - 用户只需要记住一个域名
2. **无跨域问题** - 前后端同域，不需要CORS配置
3. **统一SSL证书** - 只需要为一个域名配置HTTPS
4. **简化部署** - 支付回调、API调用都使用同一个域名

## 部署步骤

### 1. 安装 Nginx

**Ubuntu/Debian**:
```bash
sudo apt update
sudo apt install nginx
```

**CentOS/RHEL**:
```bash
sudo yum install nginx
```

### 2. 配置 Nginx

创建配置文件：
```bash
sudo nano /etc/nginx/sites-available/fastpay
```

粘贴以下配置（替换 `your-domain.com` 为你的实际域名）：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 日志
    access_log /var/log/nginx/fastpay_access.log;
    error_log /var/log/nginx/fastpay_error.log;
    
    # 最大上传大小
    client_max_body_size 10M;

    # API 后端代理
    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 前端代理
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 3. 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/fastpay /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 4. 配置 SSL（推荐）

使用 Let's Encrypt 免费证书：

```bash
# 安装 certbot
sudo apt install certbot python3-certbot-nginx

# 自动配置 SSL
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

### 5. 更新项目配置

**修改 `.env` 文件**:
```env
APP_URL=https://your-domain.com
```

**重启后端服务**:
```bash
# 如果使用 PM2
pm2 restart all

# 或者直接重启
npm run server
```

### 6. 验证配置

**测试前端访问**:
```bash
curl https://your-domain.com
```

**测试后端API**:
```bash
curl https://your-domain.com/api/settings/public
```

**测试支付回调**:
```bash
curl -X POST https://your-domain.com/api/payments/notify \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "test=1"
```

## 生产环境优化

### 1. 使用 PM2 管理进程

```bash
# 安装 PM2
npm install -g pm2

# 启动后端
cd /path/to/project
pm2 start server/index.js --name fastpay-backend

# 启动前端（生产环境应该构建后使用静态文件）
pm2 start npm --name fastpay-frontend -- run client

# 保存配置
pm2 save

# 开机自启
pm2 startup
```

### 2. 前端生产构建

生产环境建议构建前端为静态文件：

```bash
# 构建前端
npm run build

# 修改 Nginx 配置，直接服务静态文件
location / {
    root /path/to/project/dist;
    try_files $uri $uri/ /index.html;
}
```

完整的生产环境 Nginx 配置：

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL 优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 日志
    access_log /var/log/nginx/fastpay_access.log;
    error_log /var/log/nginx/fastpay_error.log;
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/json;
    
    # API 后端代理
    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 前端静态文件
    location / {
        root /path/to/project/dist;
        try_files $uri $uri/ /index.html;
        
        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }
}

# HTTP 跳转到 HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 3. 防火墙配置

```bash
# 允许 HTTP 和 HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 确保后端端口不对外开放（只允许本地访问）
sudo ufw deny 5000/tcp
```

## 常见问题

### Q1: 支付回调URL是什么？
A: `https://your-domain.com/api/payments/notify`

### Q2: 前端如何调用后端API？
A: 直接使用相对路径 `/api/xxx`，Nginx 会自动转发到后端

### Q3: 需要配置CORS吗？
A: 不需要，因为前后端同域

### Q4: 如何查看 Nginx 日志？
A: 
```bash
# 访问日志
sudo tail -f /var/log/nginx/fastpay_access.log

# 错误日志
sudo tail -f /var/log/nginx/fastpay_error.log
```

### Q5: 如何重启服务？
A:
```bash
# 重启 Nginx
sudo systemctl restart nginx

# 重启后端（PM2）
pm2 restart fastpay-backend

# 重启前端（PM2）
pm2 restart fastpay-frontend
```

## 监控和维护

### 1. 设置监控

```bash
# 查看 PM2 进程
pm2 list

# 查看日志
pm2 logs

# 查看资源使用
pm2 monit
```

### 2. 定期备份

```bash
# 备份数据库
mongodump --uri="mongodb://root:password@localhost:27017/fastpay?authSource=admin" --out=/backup/$(date +%Y%m%d)

# 备份代码
tar -czf /backup/fastpay-$(date +%Y%m%d).tar.gz /path/to/project
```

### 3. 日志轮转

创建 `/etc/logrotate.d/fastpay`:
```
/var/log/nginx/fastpay_*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

## 总结

使用这个配置后：

1. ✅ 用户访问 `https://your-domain.com` 看到前端页面
2. ✅ 前端调用 `/api/xxx` 自动转发到后端
3. ✅ 支付平台回调 `https://your-domain.com/api/payments/notify` 正常工作
4. ✅ 无跨域问题
5. ✅ 统一的 SSL 证书
6. ✅ 简化的部署和维护

---

**最后更新**: 2026年2月1日
