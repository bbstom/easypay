# CatFee API 测试指南

## 测试脚本说明

测试脚本位置：`server/scripts/testCatfeeApi.js`

## 功能说明

该脚本会自动测试以下功能：

1. ✅ **数据库连接** - 验证数据库连接是否正常
2. ✅ **配置读取** - 读取后台配置的 API URL 和 API Key
3. ✅ **账户余额查询** - 查询 CatFee 账户余额
4. ✅ **能量价格查询** - 查询购买能量的价格
5. ⚠️ **购买能量测试** - 实际购买能量（可选，需要确认）
6. ✅ **订单状态查询** - 查询购买订单的状态

## 使用方法

### 1. 基础测试（推荐）

只测试余额和价格查询，不会实际购买能量：

```bash
cd /www/wwwroot/kk.vpno.eu.org/easypay
node server/scripts/testCatfeeApi.js
```

### 2. 完整测试（包含购买）

测试实际购买能量功能（需要提供接收地址）：

```bash
node server/scripts/testCatfeeApi.js TYourTronAddressHere
```

**注意：** 此操作会实际购买能量并消耗账户余额，脚本会要求你确认。

### 3. 查看帮助

```bash
node server/scripts/testCatfeeApi.js --help
```

## 测试输出示例

### 成功输出

```
============================================================
  连接数据库
============================================================

✅ 数据库连接成功

============================================================
  读取配置
============================================================

ℹ️  API URL: https://nile.catfee.io
✅ API Key: abc12345...
✅ API Secret: xyz67890...

============================================================
  测试 1: 获取账户余额
============================================================

✅ 账户余额查询成功
ℹ️  余额: 100.5 TRX
完整响应: {
  "code": "0",
  "msg": "",
  "data": {
    "balance": "100.5",
    "currency": "TRX"
  }
}

============================================================
  测试 2: 获取能量价格
============================================================

✅ 能量价格查询成功
ℹ️  能量数量: 65000
ℹ️  租赁时长: 1h
ℹ️  价格: 1.2 TRX
完整响应: {
  "code": "0",
  "msg": "",
  "data": {
    "price": "1.2",
    "quantity": "65000",
    "duration": "1h"
  }
}

============================================================
  测试 3: 购买能量（需要确认）
============================================================

⚠️  此操作会实际购买能量并消耗余额
ℹ️  测试地址: TYourAddress...
ℹ️  能量数量: 65000
ℹ️  租赁时长: 1h

是否继续购买能量？(yes/no): yes

✅ 能量购买成功！
ℹ️  订单号: ORDER123456
ℹ️  能量数量: 65000
ℹ️  接收地址: TYourAddress...

============================================================
  查询订单状态
============================================================

✅ 订单状态查询成功
ℹ️  订单状态: SUCCESS

✅ 测试完成
```

### 错误输出示例

#### 未配置 API Key

```
❌ 未配置 CatFee API Key
⚠️  请在后台配置 CatFee API Key
```

#### API Key 格式错误

```
❌ API Key 格式错误
⚠️  正确格式: api_key:api_secret
```

#### API 调用失败

```
❌ 账户余额查询失败: Request failed with status code 401
错误详情: {
  "code": "401",
  "msg": "Invalid API Key"
}
```

## 常见问题

### 1. 测试环境 vs 生产环境

**测试环境（Nile）：**
- API URL: `https://nile.catfee.io`
- 使用测试币，不消耗真实资金
- 适合开发和调试

**生产环境：**
- API URL: `https://api.catfee.io`
- 使用真实 TRX，会消耗账户余额
- 适合正式使用

### 2. 如何获取测试币？

如果使用测试环境，需要先领取测试币：

1. 访问 [Nile Faucet](https://nileex.io/join/getJoinPage)
2. 输入你的 Nile 测试网地址
3. 每天可领取最多 2000 TRX 测试币

### 3. API Key 在哪里获取？

**生产环境：**
1. 访问 [catfee.io](https://catfee.io)
2. 注册并登录
3. 进入个人中心 → API → API 配置
4. 复制 API Key 和 API Secret

**测试环境：**
1. 访问 [nile.catfee.io](https://nile.catfee.io)
2. 注册并登录（与生产环境账号不互通）
3. 进入个人中心 → API → API 配置
4. 复制 API Key 和 API Secret

### 4. 如何配置 API Key？

在后台配置：
1. 登录管理后台
2. 进入 **支付系统** → **能量租赁**
3. 选择 **CatFee API（推荐）** 模式
4. 选择环境（生产/测试）
5. 输入 API Key（格式：`api_key:api_secret`）
6. 保存配置

### 5. 测试失败怎么办？

**检查清单：**
- [ ] 数据库是否正常运行？
- [ ] 是否已在后台配置 API Key？
- [ ] API Key 格式是否正确（包含冒号）？
- [ ] API URL 是否正确？
- [ ] 网络是否可以访问 CatFee API？
- [ ] 测试环境是否有足够的测试币？
- [ ] 生产环境是否有足够的余额？

## 测试建议

### 开发阶段
1. 使用测试环境（`https://nile.catfee.io`）
2. 先领取测试币
3. 运行基础测试验证配置
4. 使用测试地址进行购买测试

### 上线前
1. 切换到生产环境（`https://api.catfee.io`）
2. 充值账户余额
3. 运行基础测试验证配置
4. 使用真实地址进行小额购买测试
5. 确认订单状态正常

### 生产环境
1. 定期检查账户余额
2. 监控 API 调用日志
3. 设置余额预警

## 相关文档

- [CatFee API 文档](https://docs.catfee.io/getting-started/buy-energy-via-api-on-catfee/api-overview)
- [API节点和能量租赁配置说明.md](./API节点和能量租赁配置说明.md)

## 技术支持

如遇到问题，请联系：
- CatFee 官方客服：[@CatFee_James](https://t.me/CatFee_James)
- CatFee 文档：https://docs.catfee.io

---

**更新日期：** 2026-02-03
