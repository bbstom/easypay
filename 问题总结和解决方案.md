# é—®é¢˜æ€»ç»“å’Œè§£å†³æ–¹æ¡ˆ

## é—®é¢˜ 1: åå°ç”¨æˆ·ç®¡ç†çœ‹ä¸åˆ°æ•°æ®

### å¯èƒ½åŸå› 

1. **API è¯·æ±‚å¤±è´¥**
   - æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
   - æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸ

2. **æƒé™é—®é¢˜**
   - å½“å‰ç™»å½•ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜
   - Token è¿‡æœŸæˆ–æ— æ•ˆ

3. **æ•°æ®åº“ä¸­æ²¡æœ‰ç”¨æˆ·**
   - é€šè¿‡ Bot åˆ›å»ºçš„ç”¨æˆ·å¯èƒ½æ²¡æœ‰æ­£ç¡®ä¿å­˜

### æ’æŸ¥æ­¥éª¤

#### 1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°
æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ï¼š
- Console æ ‡ç­¾ï¼šæ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
- Network æ ‡ç­¾ï¼šæŸ¥çœ‹ `/api/users` è¯·æ±‚
  - çŠ¶æ€ç æ˜¯å¦ä¸º 200
  - å“åº”å†…å®¹æ˜¯ä»€ä¹ˆ

#### 2. æ£€æŸ¥æ•°æ®åº“ä¸­çš„ç”¨æˆ·
è¿è¡Œä»¥ä¸‹è„šæœ¬ï¼š

```bash
node -e "
const mongoose = require('mongoose');
require('dotenv').config();

mongoose.connect(process.env.MONGODB_URI).then(async () => {
  const User = require('./server/models/User');
  const users = await User.find().select('username email telegramId role createdAt');
  console.log('æ€»ç”¨æˆ·æ•°:', users.length);
  console.log('\\nç”¨æˆ·åˆ—è¡¨:');
  users.forEach((u, i) => {
    console.log(\`\${i+1}. \${u.username} - \${u.email} - TG:\${u.telegramId || 'æ— '} - \${u.role}\`);
  });
  process.exit(0);
});
"
```

#### 3. æ£€æŸ¥å½“å‰ç™»å½•ç”¨æˆ·æƒé™
```bash
# æŸ¥çœ‹å½“å‰ token å¯¹åº”çš„ç”¨æˆ·
# åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
localStorage.getItem('token')

# ç„¶åè§£ç  JWT token æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
```

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: ç¡®ä¿æœ‰ç®¡ç†å‘˜è´¦æˆ·
```bash
# è¿è¡Œåˆ›å»ºç®¡ç†å‘˜è„šæœ¬
node server/scripts/createNewAdmin.js
```

#### æ–¹æ¡ˆ 2: æ£€æŸ¥ API è·¯ç”±
ç¡®ä¿ `server/index.js` ä¸­æ³¨å†Œäº†ç”¨æˆ·è·¯ç”±ï¼š
```javascript
app.use('/api/users', require('./routes/users'));
```

#### æ–¹æ¡ˆ 3: ä¿®å¤ç”¨æˆ·æŸ¥è¯¢
å¦‚æœç”¨æˆ·å­˜åœ¨ä½†æ˜¾ç¤ºä¸å‡ºæ¥ï¼Œå¯èƒ½æ˜¯æŸ¥è¯¢é€»è¾‘é—®é¢˜ã€‚

---

## é—®é¢˜ 2: ç½‘ç«™ TG ç™»å½•åŠŸèƒ½æœªå®ç°

### ç°çŠ¶
âŒ **TG ç™»å½•åŠŸèƒ½å°šæœªå®ç°**

æ ¹æ®ä»£ç æ£€æŸ¥ï¼Œç›®å‰æ²¡æœ‰å®ç° Telegram Login Widget åŠŸèƒ½ã€‚

### å®ç°æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: Telegram Login Widgetï¼ˆæ¨èï¼‰

è¿™æ˜¯ Telegram å®˜æ–¹æä¾›çš„ç½‘ç«™ç™»å½•æ–¹æ¡ˆã€‚

##### 1. é…ç½® Bot
åœ¨ BotFather ä¸­è®¾ç½®åŸŸåï¼š
```
/setdomain
é€‰æ‹©ä½ çš„ Bot
è¾“å…¥åŸŸåï¼škk.vpno.eu.org
```

##### 2. å‰ç«¯å®ç°

åœ¨ç™»å½•é¡µé¢æ·»åŠ  Telegram Login Widgetï¼š

```jsx
// src/pages/LoginPage.jsx
import { useEffect } from 'react';

function TelegramLoginButton() {
  useEffect(() => {
    // åŠ è½½ Telegram Widget è„šæœ¬
    const script = document.createElement('script');
    script.src = 'https://telegram.org/js/telegram-widget.js?22';
    script.setAttribute('data-telegram-login', 'YOUR_BOT_USERNAME');
    script.setAttribute('data-size', 'large');
    script.setAttribute('data-auth-url', `${window.location.origin}/api/auth/telegram/callback`);
    script.setAttribute('data-request-access', 'write');
    script.async = true;
    
    const container = document.getElementById('telegram-login-container');
    if (container) {
      container.appendChild(script);
    }

    return () => {
      if (container && script.parentNode) {
        container.removeChild(script);
      }
    };
  }, []);

  return <div id="telegram-login-container"></div>;
}
```

##### 3. åç«¯å®ç°

åˆ›å»º Telegram è®¤è¯è·¯ç”±ï¼š

```javascript
// server/routes/auth.js
const express = require('express');
const crypto = require('crypto');
const jwt = require('jsonwebtoken');
const User = require('../models/User');

const router = express.Router();

// Telegram ç™»å½•å›è°ƒ
router.get('/telegram/callback', async (req, res) => {
  try {
    const { id, first_name, last_name, username, photo_url, auth_date, hash } = req.query;

    // éªŒè¯æ•°æ®
    if (!verifyTelegramAuth(req.query)) {
      return res.status(400).send('Invalid authentication data');
    }

    // æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    let user = await User.findOne({ telegramId: id });

    if (!user) {
      // åˆ›å»ºæ–°ç”¨æˆ·
      user = await User.create({
        username: username || \`tg_\${id}\`,
        email: \`\${id}@telegram.user\`,
        password: crypto.randomBytes(32).toString('hex'), // éšæœºå¯†ç 
        telegramId: id,
        telegramUsername: username,
        telegramFirstName: first_name,
        telegramLastName: last_name,
        telegramPhotoUrl: photo_url,
        telegramBound: true,
        source: 'telegram',
        role: 'user'
      });
    } else {
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      user.telegramUsername = username;
      user.telegramFirstName = first_name;
      user.telegramLastName = last_name;
      user.telegramPhotoUrl = photo_url;
      user.telegramBound = true;
      await user.save();
    }

    // ç”Ÿæˆ JWT token
    const token = jwt.sign(
      { userId: user._id, role: user.role },
      process.env.JWT_SECRET,
      { expiresIn: '7d' }
    );

    // é‡å®šå‘åˆ°å‰ç«¯ï¼Œå¸¦ä¸Š token
    res.redirect(\`/?token=\${token}\`);
  } catch (error) {
    console.error('Telegram ç™»å½•å¤±è´¥:', error);
    res.status(500).send('Login failed');
  }
});

// éªŒè¯ Telegram æ•°æ®
function verifyTelegramAuth(data) {
  const { hash, ...authData } = data;
  
  // åˆ›å»ºæ•°æ®å­—ç¬¦ä¸²
  const dataCheckString = Object.keys(authData)
    .sort()
    .map(key => \`\${key}=\${authData[key]}\`)
    .join('\\n');

  // è®¡ç®— hash
  const secretKey = crypto
    .createHash('sha256')
    .update(process.env.TELEGRAM_BOT_TOKEN)
    .digest();

  const calculatedHash = crypto
    .createHmac('sha256', secretKey)
    .update(dataCheckString)
    .digest('hex');

  // éªŒè¯ hash
  if (calculatedHash !== hash) {
    return false;
  }

  // éªŒè¯æ—¶é—´ï¼ˆæ•°æ®ä¸èƒ½è¶…è¿‡ 1 å¤©ï¼‰
  const authDate = parseInt(authData.auth_date);
  const currentTime = Math.floor(Date.now() / 1000);
  if (currentTime - authDate > 86400) {
    return false;
  }

  return true;
}

module.exports = router;
```

##### 4. æ³¨å†Œè·¯ç”±

åœ¨ `server/index.js` ä¸­ï¼š
```javascript
app.use('/api/auth', require('./routes/auth'));
```

##### 5. å‰ç«¯å¤„ç† Token

```jsx
// src/App.jsx
useEffect(() => {
  // ä» URL è·å– token
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');
  
  if (token) {
    localStorage.setItem('token', token);
    // æ¸…é™¤ URL ä¸­çš„ token
    window.history.replaceState({}, document.title, '/');
    // é‡å®šå‘åˆ°ç”¨æˆ·ä¸­å¿ƒ
    navigate('/user');
  }
}, []);
```

#### æ–¹æ¡ˆ B: ç®€åŒ–ç‰ˆï¼ˆç»‘å®šç æ–¹å¼ï¼‰

å¦‚æœä¸æƒ³ä½¿ç”¨ Telegram Login Widgetï¼Œå¯ä»¥ä½¿ç”¨ç»‘å®šç æ–¹å¼ï¼š

1. ç”¨æˆ·åœ¨ç½‘ç«™ç”Ÿæˆç»‘å®šç 
2. ç”¨æˆ·åœ¨ Bot ä¸­è¾“å…¥ç»‘å®šç 
3. Bot éªŒè¯ç»‘å®šç å¹¶ç»‘å®šè´¦æˆ·

è¿™ä¸ªæ–¹æ¡ˆå·²ç»åœ¨è®¾è®¡æ–‡æ¡£ä¸­æåˆ°ï¼Œä½†è¿˜æ²¡æœ‰å®ç°ã€‚

---

## å¿«é€Ÿä¿®å¤å»ºè®®

### ä¼˜å…ˆçº§ 1: ä¿®å¤ç”¨æˆ·ç®¡ç†æ˜¾ç¤ºé—®é¢˜

1. **æ£€æŸ¥æ•°æ®åº“**
   ```bash
   node test-menu-config.js
   ```
   æŸ¥çœ‹æ˜¯å¦æœ‰ç”¨æˆ·æ•°æ®

2. **æ£€æŸ¥ API**
   åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
   ```
   http://localhost:5000/api/users
   ```
   ï¼ˆéœ€è¦å…ˆç™»å½•è·å– tokenï¼‰

3. **æŸ¥çœ‹æ—¥å¿—**
   ```bash
   pm2 logs easypay --lines 100
   ```

### ä¼˜å…ˆçº§ 2: å®ç° TG ç™»å½•ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ TG ç™»å½•åŠŸèƒ½ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ–¹æ¡ˆ A å®ç°ã€‚

---

## æµ‹è¯•è„šæœ¬

### æ£€æŸ¥ç”¨æˆ·æ•°æ®
åˆ›å»º `test-users.js`ï¼š

\`\`\`javascript
const mongoose = require('mongoose');
require('dotenv').config();

async function testUsers() {
  try {
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ\\n');

    const User = require('./server/models/User');
    const users = await User.find().select('username email telegramId role status createdAt');

    console.log('ğŸ“Š ç”¨æˆ·ç»Ÿè®¡:');
    console.log('  æ€»ç”¨æˆ·æ•°:', users.length);
    console.log('  ç®¡ç†å‘˜æ•°:', users.filter(u => u.role === 'admin').length);
    console.log('  TG ç”¨æˆ·æ•°:', users.filter(u => u.telegramId).length);
    console.log('  æ´»è·ƒç”¨æˆ·:', users.filter(u => u.status === 'active').length);

    console.log('\\nğŸ“‹ ç”¨æˆ·åˆ—è¡¨:');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    users.forEach((u, i) => {
      const tgInfo = u.telegramId ? \`TG:\${u.telegramId}\` : 'æ— TG';
      const roleIcon = u.role === 'admin' ? 'ğŸ‘‘' : 'ğŸ‘¤';
      const statusIcon = u.status === 'active' ? 'âœ…' : 'âŒ';
      console.log(\`\${i+1}. \${roleIcon} \${u.username} - \${u.email}\`);
      console.log(\`   \${tgInfo} - \${statusIcon} \${u.status} - \${u.createdAt.toLocaleDateString()}\`);
    });

    console.log('\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    await mongoose.disconnect();
    console.log('\\nâœ… æµ‹è¯•å®Œæˆ\\n');
  } catch (error) {
    console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
    process.exit(1);
  }
}

testUsers();
\`\`\`

è¿è¡Œï¼š
```bash
node test-users.js
```

---

## æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… Bot ç”¨æˆ·ç³»ç»Ÿå·²å®ç°
- âœ… åå°ç”¨æˆ·ç®¡ç†å·²å®ç°
- âŒ ç½‘ç«™ TG ç™»å½•æœªå®ç°
- âš ï¸  ç”¨æˆ·ç®¡ç†æ˜¾ç¤ºé—®é¢˜éœ€è¦æ’æŸ¥

### ä¸‹ä¸€æ­¥
1. è¿è¡Œ `test-users.js` æ£€æŸ¥ç”¨æˆ·æ•°æ®
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
3. å¦‚éœ€ TG ç™»å½•ï¼Œå®ç°æ–¹æ¡ˆ A
4. æµ‹è¯•ç”¨æˆ·ç®¡ç†åŠŸèƒ½

---

**åˆ›å»ºæ—¶é—´ï¼š** 2026-02-05  
**çŠ¶æ€ï¼š** å¾…å¤„ç†
