# 多钱包系统 - 架构图

## 🏗️ 系统整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端界面                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  用户下单    │  │  管理后台    │  │  钱包管理    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         后端 API                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 支付路由     │  │ 钱包路由     │  │ 订单路由     │          │
│  │ /payments    │  │ /wallets     │  │ /orders      │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       核心服务层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 钱包选择器   │  │ TRON 服务    │  │ 能量服务     │          │
│  │ Selector     │  │ TronService  │  │ CatFee       │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         数据层                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Wallet 模型  │  │ Payment 模型 │  │ Settings 模型│          │
│  │ (多钱包)     │  │ (订单)       │  │ (系统配置)   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      区块链网络                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ TRON 主网    │  │ API 节点     │  │ 能量租赁商   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 代付流程详细图

```
用户支付成功
    │
    ▼
┌─────────────────────────────────────┐
│  支付回调（GET/POST）                │
│  - 验证签名                          │
│  - 更新订单状态为 'paid'             │
│  - 发送支付成功邮件（第一封）        │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  调用 processTransfer()              │
│  - 异步执行代付                      │
│  - 支持重试机制（最多3次）           │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  钱包选择器 (WalletSelector)         │
│                                      │
│  评分因素：                          │
│  ├─ 优先级 (40分)                    │
│  ├─ 余额充足度 (30分)                │
│  ├─ 负载均衡 (20分)                  │
│  └─ 健康状态 (10分)                  │
│                                      │
│  选择最高分钱包 ✓                    │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  检查能量需求                        │
│                                      │
│  目标地址有 USDT？                   │
│  ├─ 是 → 需要 65,000 能量            │
│  └─ 否 → 需要 131,000 能量（首次）   │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  能量充足？                          │
└─────────────────────────────────────┘
    │                    │
    │ 否                 │ 是
    ▼                    │
┌─────────────────────────────────────┐
│  租赁能量                            │
│                                      │
│  模式选择：                          │
│  ├─ 转账模式                         │
│  │  └─ 发送 TRX 到租赁地址           │
│  │     等待 30 秒                    │
│  │                                   │
│  └─ CatFee API 模式                  │
│     └─ 调用 API 购买能量             │
│        等待 10 秒                    │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  执行转账                            │
│  sendUSDTWithWallet() 或             │
│  sendTRXWithWallet()                 │
│                                      │
│  - 创建临时 TronWeb 实例             │
│  - 使用钱包私钥签名                  │
│  - 发送交易到区块链                  │
│  - 提取交易哈希                      │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  更新订单状态                        │
│  - status: 'completed'               │
│  - txHash: 交易哈希                  │
│  - walletId: 使用的钱包 ID           │
│  - walletName: 钱包名称              │
│  - transferTime: 完成时间            │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  更新钱包余额（异步）                │
│  - 查询链上余额                      │
│  - 更新数据库                        │
│  - 更新统计信息                      │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  发送代付完成邮件（第二封）          │
│  - 包含交易哈希                      │
│  - 包含区块链浏览器链接              │
└─────────────────────────────────────┘
    │
    ▼
   完成 ✓
```

---

## 🎯 钱包选择算法

```
┌─────────────────────────────────────┐
│  获取所有启用的钱包                  │
│  WHERE enabled = true                │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  过滤符合条件的钱包                  │
│                                      │
│  条件：                              │
│  ✓ 健康状态 ≠ error                  │
│  ✓ TRX 余额 ≥ 预估手续费             │
│  ✓ USDT 余额 ≥ 转账金额（USDT转账）  │
│  ✓ TRX 余额 ≥ 金额+手续费（TRX转账） │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  计算每个钱包的得分                  │
│                                      │
│  1. 优先级得分 (40分)                │
│     score = (priority / 100) × 40   │
│                                      │
│  2. 余额充足度 (30分)                │
│     sufficiency = 余额 / (需求×10)  │
│     score = min(sufficiency, 1) × 30│
│                                      │
│  3. 负载均衡 (20分)                  │
│     hours = 距上次使用的小时数       │
│     score = min(hours/24, 1) × 20   │
│                                      │
│  4. 健康状态 (10分)                  │
│     healthy → 10分                   │
│     warning → 5分                    │
│     error → 0分                      │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  按得分排序                          │
│  选择最高分的钱包                    │
└─────────────────────────────────────┘
    │
    ▼
   返回选中的钱包 ✓
```

---

## 🔋 能量租赁流程

### 转账模式

```
检测到能量不足
    │
    ▼
┌─────────────────────────────────────┐
│  确定租赁金额                        │
│  - 首次转账: 20 TRX (默认)           │
│  - 正常转账: 10 TRX (默认)           │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  发送 TRX 到租赁地址                 │
│  使用当前钱包的 TronWeb 实例         │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  等待能量到账                        │
│  默认等待 30 秒                      │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  检查能量是否到账                    │
│  - 查询账户资源                      │
│  - 计算能量增量                      │
└─────────────────────────────────────┘
    │
    ▼
   返回租赁结果 ✓
```

### CatFee API 模式

```
检测到能量不足
    │
    ▼
┌─────────────────────────────────────┐
│  确定购买数量                        │
│  - 首次转账: 131,000 能量            │
│  - 正常转账: 65,000 能量             │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  调用 CatFee API                     │
│  POST /api/v1/energy/buy             │
│  {                                   │
│    address: "钱包地址",              │
│    amount: 65000,                    │
│    period: "1h"                      │
│  }                                   │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  等待能量到账                        │
│  默认等待 10 秒                      │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│  检查能量是否到账                    │
│  - 查询账户资源                      │
│  - 计算能量增量                      │
└─────────────────────────────────────┘
    │
    ▼
   返回购买结果 ✓
```

---

## 💾 数据模型关系

```
┌─────────────────────────────────────┐
│           Wallet (钱包)              │
├─────────────────────────────────────┤
│ _id                                  │
│ name                                 │
│ address                              │
│ privateKeyEncrypted                  │
│ enabled                              │
│ priority                             │
│ balance { trx, usdt }                │
│ resources { energy, bandwidth }      │
│ stats { total, success, fail }       │
│ health { status, lastCheck }         │
└─────────────────────────────────────┘
            │
            │ 1:N
            ▼
┌─────────────────────────────────────┐
│          Payment (订单)              │
├─────────────────────────────────────┤
│ _id                                  │
│ userId                               │
│ payType (USDT/TRX)                   │
│ amount                               │
│ address                              │
│ platformOrderId                      │
│ paymentStatus                        │
│ transferStatus                       │
│ txHash                               │
│ walletId ────────────────────────┐   │
│ walletName                       │   │
│ createdAt                        │   │
└──────────────────────────────────┼───┘
                                   │
                                   │ 引用
                                   │
                                   └─→ Wallet._id

┌─────────────────────────────────────┐
│         Settings (系统配置)          │
├─────────────────────────────────────┤
│ siteName                             │
│ feeType, feeUSDT, feeTRX             │
│ exchangeRateMode                     │
│ paymentApiUrl, paymentApiKey         │
│ tronApiNodes (JSON)                  │
│ energyRentalEnabled                  │
│ energyRentalMode                     │
│ catfeeApiKey                         │
│ smtpHost, smtpUser, smtpPass         │
└─────────────────────────────────────┘
```

---

## 🔐 安全架构

```
┌─────────────────────────────────────┐
│          应用层安全                  │
│  - JWT 认证                          │
│  - 角色权限控制                      │
│  - API 限流                          │
└─────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────┐
│          数据层安全                  │
│  - 私钥加密存储                      │
│  - 主密钥环境变量                    │
│  - 敏感数据脱敏                      │
└─────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────┐
│          传输层安全                  │
│  - HTTPS 加密                        │
│  - 签名验证                          │
│  - 防重放攻击                        │
└─────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────┐
│          区块链层安全                │
│  - 私钥本地签名                      │
│  - 交易确认验证                      │
│  - 余额实时检查                      │
└─────────────────────────────────────┘
```

---

## 📊 监控与预警

```
┌─────────────────────────────────────┐
│          钱包健康监控                │
│                                      │
│  定期检查：                          │
│  ├─ 余额监控                         │
│  │  ├─ TRX < 50 → 预警              │
│  │  └─ USDT < 100 → 预警            │
│  │                                   │
│  ├─ 资源监控                         │
│  │  └─ 能量 < 50k → 预警            │
│  │                                   │
│  ├─ 交易监控                         │
│  │  └─ 连续失败 3 次 → 禁用         │
│  │                                   │
│  └─ 网络监控                         │
│     └─ API 节点响应时间              │
└─────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────┐
│          预警通知                    │
│  - 邮件通知                          │
│  - 日志记录                          │
│  - 状态更新                          │
└─────────────────────────────────────┘
```

---

## 🚀 性能优化

```
┌─────────────────────────────────────┐
│          并发处理                    │
│  - 异步转账处理                      │
│  - 队列机制                          │
│  - 重试机制                          │
└─────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────┐
│          缓存策略                    │
│  - 钱包余额缓存                      │
│  - API 节点状态缓存                  │
│  - 汇率缓存                          │
└─────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────┐
│          负载均衡                    │
│  - 多钱包分散负载                    │
│  - 智能选择算法                      │
│  - 健康检查                          │
└─────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────┐
│          成本优化                    │
│  - 能量租赁（节省 70-80%）           │
│  - 批量处理                          │
│  - 资源复用                          │
└─────────────────────────────────────┘
```

---

**文档版本：** v2.0  
**最后更新：** 2026-02-02  
**适用系统：** 多钱包代付系统
