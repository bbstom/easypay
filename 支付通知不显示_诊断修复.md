# æ”¯ä»˜é€šçŸ¥ä¸æ˜¾ç¤º - è¯Šæ–­ä¸ä¿®å¤

## ğŸ” é—®é¢˜ç°è±¡

ç”¨æˆ·å®Œæˆæ”¯ä»˜åï¼Œåœç•™åœ¨æ‰«ç æ”¯ä»˜çª—å£ï¼Œä¸ä¼šå¼¹å‡º"æ”¯ä»˜æˆåŠŸï¼Œæ­£åœ¨å®Œæˆä»£ä»˜"çš„é€šçŸ¥ã€‚

---

## ğŸ“Š å½“å‰å®ç°åˆ†æ

### å‰ç«¯è½®è¯¢é€»è¾‘ï¼ˆPayPage.jsxï¼‰

```javascript
const startPollingOrderStatus = (orderId) => {
  let paymentNotified = false;
  
  const interval = setInterval(async () => {
    const { data } = await axios.get(`/api/payments/order/${orderId}`);
    
    // æ”¯ä»˜å®Œæˆï¼ˆç¬¬ä¸€ä¸ªé€šçŸ¥ï¼‰
    if (data.paymentStatus === 'paid' && !paymentNotified) {
      paymentNotified = true;
      showNotification(
        'æ”¯ä»˜æˆåŠŸ', 
        'æ‚¨çš„è®¢å•æ”¯ä»˜å·²ç¡®è®¤ï¼\næ­£åœ¨å¤„ç† USDT ä»£ä»˜ï¼Œè¯·ç¨å€™...', 
        'success'
      );
    }
    
    // ä»£ä»˜å®Œæˆï¼ˆç¬¬äºŒä¸ªé€šçŸ¥ï¼‰
    if (data.status === 'completed') {
      clearInterval(interval);
      showNotification('USDT ä»£ä»˜å®Œæˆ', '...', 'success');
      setShowPayment(false);
    }
  }, 3000); // æ¯3ç§’æŸ¥è¯¢ä¸€æ¬¡
};
```

### åç«¯æ”¯ä»˜å›è°ƒï¼ˆpayments.jsï¼‰

```javascript
// æ›´æ–°æ”¯ä»˜çŠ¶æ€
if (trade_status === 'TRADE_SUCCESS') {
  payment.paymentStatus = 'paid';  // âœ… è®¾ç½® paymentStatus
  payment.paymentTime = new Date();
  payment.status = 'paid';         // âœ… è®¾ç½® status
  await payment.save();
  
  // å¼‚æ­¥æ‰§è¡Œä»£ä»˜
  processTransfer(payment._id).catch(err => {
    console.error('ä»£ä»˜å¤±è´¥:', err);
  });
  
  res.send('success');
}
```

---

## ğŸ¯ å¯èƒ½çš„é—®é¢˜

### 1. è½®è¯¢æœªå¯åŠ¨

**æ£€æŸ¥ç‚¹ï¼š** `startPollingOrderStatus` æ˜¯å¦è¢«è°ƒç”¨ï¼Ÿ

åœ¨ `handleSubmit` å‡½æ•°ä¸­ï¼š
```javascript
// æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç 
setPaymentUrl(data.paymentUrl);
setCurrentOrderId(data.orderId);
setShowPayment(true);

// å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€
startPollingOrderStatus(data.orderId);  // âœ… å·²è°ƒç”¨
```

**ç»“è®ºï¼š** è½®è¯¢å·²æ­£ç¡®å¯åŠ¨ âœ…

---

### 2. è®¢å•æŸ¥è¯¢æ¥å£é—®é¢˜

**æ£€æŸ¥ç‚¹ï¼š** `/api/payments/order/:orderId` æ¥å£æ˜¯å¦æ­£å¸¸ï¼Ÿ

è®©æˆ‘æ£€æŸ¥è¿™ä¸ªæ¥å£çš„å®ç°...

---

### 3. æ§åˆ¶å°æ—¥å¿—æ£€æŸ¥

**éœ€è¦æ£€æŸ¥çš„æ—¥å¿—ï¼š**

1. **å‰ç«¯æ§åˆ¶å°ï¼ˆæµè§ˆå™¨ F12ï¼‰ï¼š**
   ```
   ğŸ”„ å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€: ORD...
   ğŸ“Š è®¢å•çŠ¶æ€: { paymentStatus: 'paid', ... }
   âœ… æ”¯ä»˜æˆåŠŸï¼Œæ˜¾ç¤ºé€šçŸ¥
   ```

2. **åç«¯æ§åˆ¶å°ï¼ˆæœåŠ¡å™¨ï¼‰ï¼š**
   ```
   æ”¶åˆ°æ”¯ä»˜å›è°ƒï¼ˆGETï¼‰: { ... }
   âœ… æ”¯ä»˜æˆåŠŸï¼Œè®¢å•: ...
   ğŸ”„ å¼€å§‹æ‰§è¡Œ USDT ä»£ä»˜: ...
   ```

---

## ğŸ”§ è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ£€æŸ¥è®¢å•æŸ¥è¯¢æ¥å£

```bash
# æŸ¥çœ‹æœ€è¿‘çš„è®¢å•
node -e "require('dotenv').config(); const mongoose = require('mongoose'); const Payment = require('./server/models/Payment'); mongoose.connect(process.env.MONGODB_URI).then(async () => { const p = await Payment.findOne().sort({ createdAt: -1 }); console.log('æœ€è¿‘è®¢å•:'); console.log('è®¢å•å·:', p.platformOrderId); console.log('paymentStatus:', p.paymentStatus); console.log('transferStatus:', p.transferStatus); console.log('status:', p.status); await mongoose.disconnect(); });"
```

### æ­¥éª¤ 2ï¼šæ‰‹åŠ¨æµ‹è¯•è®¢å•æŸ¥è¯¢æ¥å£

```bash
# æ›¿æ¢ YOUR_ORDER_ID ä¸ºå®é™…è®¢å•å·
curl http://localhost:3000/api/payments/order/YOUR_ORDER_ID
```

**é¢„æœŸå“åº”ï¼š**
```json
{
  "platformOrderId": "ORD...",
  "paymentStatus": "paid",
  "transferStatus": "completed",
  "status": "completed",
  "payType": "USDT",
  "amount": 4,
  "txHash": "..."
}
```

### æ­¥éª¤ 3ï¼šæ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Console æ ‡ç­¾
3. åˆ›å»ºè®¢å•å¹¶æ”¯ä»˜
4. æŸ¥çœ‹æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š
   - `ğŸ”„ å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€`
   - `ğŸ“Š è®¢å•çŠ¶æ€`
   - `âœ… æ”¯ä»˜æˆåŠŸï¼Œæ˜¾ç¤ºé€šçŸ¥`

### æ­¥éª¤ 4ï¼šæ£€æŸ¥ç½‘ç»œè¯·æ±‚

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. ç­›é€‰ XHR è¯·æ±‚
4. æŸ¥çœ‹æ˜¯å¦æœ‰å®šæœŸçš„ `/api/payments/order/...` è¯·æ±‚
5. æ£€æŸ¥å“åº”æ•°æ®

---

## âœ… å¯èƒ½çš„ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šå¢å¼ºæ—¥å¿—è¾“å‡º

åœ¨ `PayPage.jsx` çš„è½®è¯¢å‡½æ•°ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—ï¼š

```javascript
const startPollingOrderStatus = (orderId) => {
  let paymentNotified = false;
  
  console.log('ğŸ”„ å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€:', orderId);
  console.log('ğŸ“ è½®è¯¢ URL:', `/api/payments/order/${orderId}`);
  
  const interval = setInterval(async () => {
    try {
      console.log('â° æ‰§è¡Œè½®è¯¢æŸ¥è¯¢...');
      const { data } = await axios.get(`/api/payments/order/${orderId}`);
      
      console.log('ğŸ“Š è®¢å•çŠ¶æ€:', {
        orderId: data.platformOrderId,
        paymentStatus: data.paymentStatus,
        transferStatus: data.transferStatus,
        status: data.status,
        paymentNotified: paymentNotified
      });
      
      // æ”¯ä»˜å®Œæˆï¼ˆç¬¬ä¸€ä¸ªé€šçŸ¥ï¼‰
      if (data.paymentStatus === 'paid' && !paymentNotified) {
        paymentNotified = true;
        console.log('âœ… æ”¯ä»˜æˆåŠŸï¼Œæ˜¾ç¤ºé€šçŸ¥');
        console.log('ğŸ“¢ è°ƒç”¨ showNotification...');
        showNotification(
          'æ”¯ä»˜æˆåŠŸ', 
          `æ‚¨çš„è®¢å•æ”¯ä»˜å·²ç¡®è®¤ï¼\næ­£åœ¨å¤„ç† ${data.payType} ä»£ä»˜ï¼Œè¯·ç¨å€™...`, 
          'success'
        );
      }
      
      // ä»£ä»˜å®Œæˆï¼ˆç¬¬äºŒä¸ªé€šçŸ¥ï¼‰
      if (data.status === 'completed') {
        clearInterval(interval);
        console.log('âœ… ä»£ä»˜å®Œæˆï¼Œæ˜¾ç¤ºé€šçŸ¥');
        showNotification(
          `${data.payType} ä»£ä»˜å®Œæˆ`, 
          `${data.amount} ${data.payType} å·²æˆåŠŸè½¬è´¦åˆ°æ‚¨çš„åœ°å€ï¼`, 
          'success'
        );
        setShowPayment(false);
      }
    } catch (error) {
      console.error('âŒ æŸ¥è¯¢è®¢å•çŠ¶æ€å¤±è´¥:', error);
      console.error('é”™è¯¯è¯¦æƒ…:', error.response?.data || error.message);
    }
  }, 3000);
  
  // 5åˆ†é’Ÿååœæ­¢è½®è¯¢
  setTimeout(() => {
    clearInterval(interval);
    console.log('â±ï¸ è½®è¯¢è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰ï¼Œåœæ­¢æŸ¥è¯¢');
  }, 300000);
};
```

### ä¿®å¤ 2ï¼šç¡®ä¿é€šçŸ¥ç»„ä»¶æ­£ç¡®æ¸²æŸ“

æ£€æŸ¥ `showNotification` å‡½æ•°ï¼š

```javascript
const showNotification = (title, message, type) => {
  console.log('ğŸ“¢ æ˜¾ç¤ºé€šçŸ¥:', { title, message, type });
  setNotification({ title, message, type });
  console.log('âœ… é€šçŸ¥çŠ¶æ€å·²æ›´æ–°');
};
```

### ä¿®å¤ 3ï¼šæ·»åŠ è½®è¯¢çŠ¶æ€æŒ‡ç¤ºå™¨

åœ¨æ”¯ä»˜çª—å£ä¸­æ˜¾ç¤ºè½®è¯¢çŠ¶æ€ï¼š

```jsx
{showPayment && (
  <div className="fixed inset-0 z-50 flex items-center justify-center">
    <div className="bg-white rounded-2xl p-8 max-w-md w-full">
      <h3>æ‰«ç æ”¯ä»˜</h3>
      <img src={paymentUrl} alt="æ”¯ä»˜äºŒç»´ç " />
      
      {/* æ·»åŠ è½®è¯¢çŠ¶æ€æŒ‡ç¤º */}
      <div className="mt-4 text-center text-sm text-gray-500">
        <div className="flex items-center justify-center gap-2">
          <div className="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
          <span>æ­£åœ¨ç›‘å¬æ”¯ä»˜çŠ¶æ€...</span>
        </div>
      </div>
    </div>
  </div>
)}
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šè½®è¯¢è¯·æ±‚è¢«æ‹¦æˆª

**ç—‡çŠ¶ï¼š** Network æ ‡ç­¾ä¸­çœ‹ä¸åˆ°è½®è¯¢è¯·æ±‚

**åŸå› ï¼š** 
- CORS é—®é¢˜
- ä»£ç†é…ç½®é—®é¢˜
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³ï¼š**
```javascript
// åœ¨ axios è¯·æ±‚ä¸­æ·»åŠ å®Œæ•´ URL
const { data } = await axios.get(`${window.location.origin}/api/payments/order/${orderId}`);
```

### é—®é¢˜ 2ï¼šè®¢å•å·ä¸åŒ¹é…

**ç—‡çŠ¶ï¼š** æŸ¥è¯¢è¿”å› 404

**åŸå› ï¼š** 
- `currentOrderId` å’Œå®é™…è®¢å•å·ä¸ä¸€è‡´
- è®¢å•å·æ ¼å¼é—®é¢˜

**è§£å†³ï¼š**
```javascript
// åœ¨åˆ›å»ºè®¢å•åç«‹å³æ‰“å°
console.log('åˆ›å»ºçš„è®¢å•å·:', data.orderId);
console.log('å¼€å§‹è½®è¯¢è®¢å•å·:', data.orderId);
```

### é—®é¢˜ 3ï¼šé€šçŸ¥ç»„ä»¶è¢«é®æŒ¡

**ç—‡çŠ¶ï¼š** é€šçŸ¥å·²è§¦å‘ä½†çœ‹ä¸åˆ°

**åŸå› ï¼š** 
- z-index å¤ªä½
- è¢«å…¶ä»–å…ƒç´ é®æŒ¡

**è§£å†³ï¼š**
```jsx
{notification && (
  <div className="fixed inset-0 z-[9999] flex items-center justify-center">
    {/* é€šçŸ¥å†…å®¹ */}
  </div>
)}
```

### é—®é¢˜ 4ï¼šæ”¯ä»˜å›è°ƒæœªè§¦å‘

**ç—‡çŠ¶ï¼š** `paymentStatus` ä¸€ç›´æ˜¯ `pending`

**åŸå› ï¼š** 
- æ”¯ä»˜å¹³å°å›è°ƒ URL é…ç½®é”™è¯¯
- å›è°ƒç­¾åéªŒè¯å¤±è´¥
- æœåŠ¡å™¨æœªæ”¶åˆ°å›è°ƒ

**è§£å†³ï¼š**
1. æ£€æŸ¥æ”¯ä»˜å¹³å°é…ç½®çš„å›è°ƒ URL
2. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—æ˜¯å¦æ”¶åˆ°å›è°ƒ
3. æµ‹è¯•å›è°ƒæ¥å£ï¼š
   ```bash
   curl "http://your-domain.com/api/payments/notify?out_trade_no=ORD...&trade_status=TRADE_SUCCESS&sign=..."
   ```

---

## ğŸ” å®æ—¶è¯Šæ–­è„šæœ¬

åˆ›å»ºä¸€ä¸ªæµ‹è¯•è„šæœ¬æ¥æ¨¡æ‹Ÿæ•´ä¸ªæµç¨‹ï¼š

```javascript
// test-payment-notification.js
const axios = require('axios');

async function testPaymentFlow() {
  const baseURL = 'http://localhost:3000';
  
  console.log('1ï¸âƒ£ åˆ›å»ºè®¢å•...');
  const createRes = await axios.post(`${baseURL}/api/payments`, {
    payType: 'USDT',
    amount: 1,
    address: 'TTest123...',
    paymentMethod: 'wechat',
    totalCNY: 10
  });
  
  const orderId = createRes.data.orderId;
  console.log('âœ… è®¢å•åˆ›å»ºæˆåŠŸ:', orderId);
  
  console.log('\n2ï¸âƒ£ æ¨¡æ‹Ÿæ”¯ä»˜å›è°ƒ...');
  await axios.get(`${baseURL}/api/payments/notify`, {
    params: {
      out_trade_no: orderId,
      trade_status: 'TRADE_SUCCESS',
      sign: 'test'
    }
  });
  console.log('âœ… æ”¯ä»˜å›è°ƒæˆåŠŸ');
  
  console.log('\n3ï¸âƒ£ æŸ¥è¯¢è®¢å•çŠ¶æ€...');
  for (let i = 0; i < 5; i++) {
    await new Promise(resolve => setTimeout(resolve, 3000));
    const statusRes = await axios.get(`${baseURL}/api/payments/order/${orderId}`);
    console.log(`æŸ¥è¯¢ ${i+1}:`, {
      paymentStatus: statusRes.data.paymentStatus,
      transferStatus: statusRes.data.transferStatus,
      status: statusRes.data.status
    });
    
    if (statusRes.data.status === 'completed') {
      console.log('âœ… ä»£ä»˜å®Œæˆï¼');
      break;
    }
  }
}

testPaymentFlow().catch(console.error);
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### å‰ç«¯æ£€æŸ¥
- [ ] æµè§ˆå™¨æ§åˆ¶å°æœ‰ "ğŸ”„ å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€" æ—¥å¿—
- [ ] Network æ ‡ç­¾æœ‰å®šæœŸçš„ `/api/payments/order/...` è¯·æ±‚
- [ ] è¯·æ±‚è¿”å›æ­£ç¡®çš„è®¢å•æ•°æ®
- [ ] `paymentStatus` ä» `pending` å˜ä¸º `paid`
- [ ] é€šçŸ¥ç»„ä»¶çš„ z-index è¶³å¤Ÿé«˜ï¼ˆ9999ï¼‰

### åç«¯æ£€æŸ¥
- [ ] æœåŠ¡å™¨æ—¥å¿—æœ‰ "æ”¶åˆ°æ”¯ä»˜å›è°ƒ" æ—¥å¿—
- [ ] è®¢å•çŠ¶æ€æ­£ç¡®æ›´æ–°ä¸º `paid`
- [ ] ä»£ä»˜æµç¨‹æ­£å¸¸æ‰§è¡Œ
- [ ] è®¢å•æŸ¥è¯¢æ¥å£è¿”å›æ­£ç¡®æ•°æ®

### é…ç½®æ£€æŸ¥
- [ ] æ”¯ä»˜å¹³å°å›è°ƒ URL é…ç½®æ­£ç¡®
- [ ] å›è°ƒç­¾åéªŒè¯é€šè¿‡
- [ ] ä»£ç†/åå‘ä»£ç†é…ç½®æ­£ç¡®

---

## ğŸ¯ æ¨èè§£å†³æ–¹æ¡ˆ

åŸºäºåˆ†æï¼Œæœ€å¯èƒ½çš„é—®é¢˜æ˜¯ï¼š

1. **è½®è¯¢æ—¥å¿—ä¸è¶³** - æ— æ³•åˆ¤æ–­é—®é¢˜å‡ºåœ¨å“ªé‡Œ
2. **é€šçŸ¥ç»„ä»¶ z-index** - å¯èƒ½è¢«é®æŒ¡
3. **æ”¯ä»˜å›è°ƒé—®é¢˜** - çŠ¶æ€æœªæ›´æ–°

**ç«‹å³æ‰§è¡Œï¼š**

1. æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼ˆä¿®å¤ 1ï¼‰
2. æé«˜é€šçŸ¥ z-index åˆ° 9999
3. æµ‹è¯•æ”¯ä»˜å›è°ƒæ˜¯å¦æ­£å¸¸

---

**è¯Šæ–­æ—¶é—´ï¼š** 2026-02-02  
**é—®é¢˜çº§åˆ«ï¼š** ğŸŸ¡ ä¸­ä¼˜å…ˆçº§  
**å»ºè®®æ“ä½œï¼š** æ·»åŠ æ—¥å¿—åé‡æ–°æµ‹è¯•
