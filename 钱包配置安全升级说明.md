# 🔒 钱包配置安全升级说明

## 📋 更新内容

### 1. 独立的钱包配置页面

**新增页面**: `/wallet` (钱包配置)

- ✅ 独立的钱包配置菜单
- ✅ 可视化配置界面
- ✅ 实时钱包余额显示
- ✅ 私钥验证功能
- ✅ 连接测试功能

### 2. 私钥加密存储 🔐

**加密方式**: AES-256-GCM

**安全特性**:
- ✅ 使用 PBKDF2 密钥派生（100,000次迭代）
- ✅ 随机 Salt 和 IV
- ✅ 认证标签验证
- ✅ 只在后端存储和解密
- ✅ 前端永远不会看到明文私钥

**加密流程**:
```
明文私钥 → PBKDF2派生密钥 → AES-256-GCM加密 → 存储到数据库
```

**解密流程**:
```
数据库加密数据 → PBKDF2派生密钥 → AES-256-GCM解密 → 明文私钥（仅在服务器内存）
```

### 3. 配置分离

**移除**: 系统设置中的 TRON 配置标签

**新增**: 独立的钱包配置页面

**优势**:
- 更清晰的功能分类
- 更好的安全隔离
- 更专业的配置界面

---

## 🆕 新增文件

### 后端

1. **server/utils/encryption.js** - 加密工具
   - `encryptPrivateKey()` - 加密私钥
   - `decryptPrivateKey()` - 解密私钥
   - `isValidPrivateKey()` - 验证私钥格式
   - `getMasterKey()` - 获取主密钥

2. **server/routes/wallet.js** - 钱包配置 API
   - `GET /api/wallet/config` - 获取钱包配置
   - `PUT /api/wallet/config` - 更新钱包配置
   - `POST /api/wallet/test` - 测试钱包连接
   - `GET /api/wallet/balance` - 获取钱包余额
   - `POST /api/wallet/validate-key` - 验证私钥

3. **server/scripts/migratePrivateKey.js** - 私钥迁移脚本

### 前端

1. **src/pages/WalletConfigPage.jsx** - 钱包配置页面
   - 钱包状态监控
   - 私钥配置（加密存储）
   - 转账配置
   - 余额预警设置

---

## 📝 修改的文件

### 后端

1. **server/models/Settings.js**
   - 移除: `tronPrivateKey` (明文)
   - 新增: `tronPrivateKeyEncrypted` (加密)
   - 新增: `tronWalletAddress` (钱包地址)
   - 新增: `walletAutoTransferEnabled` (自动转账开关)
   - 新增: `walletMaxRetryCount` (最大重试次数)
   - 新增: `walletMinTRXBalance` (TRX最低余额)
   - 新增: `walletMinUSDTBalance` (USDT最低余额)

2. **server/services/tronService.js**
   - 更新: 使用加密私钥初始化

3. **server/index.js**
   - 新增: 钱包路由

### 前端

1. **src/App.jsx**
   - 新增: 钱包配置路由

2. **src/components/AdminLayout.jsx**
   - 新增: 钱包配置菜单项
   - 移除: 系统设置中的 TRON 配置子项

3. **src/pages/SettingsPage.jsx**
   - 移除: TRON 配置标签

---

## 🚀 使用指南

### 1. 配置钱包（新用户）

1. 登录管理后台
2. 点击左侧菜单 "钱包配置"
3. 选择 TRON 网络（主网/测试网）
4. 输入钱包私钥
5. 点击 "验证私钥" 确认格式正确
6. 配置转账参数（自动转账、重试次数、余额预警）
7. 点击 "保存配置"
8. 点击 "测试连接" 验证配置

### 2. 迁移现有私钥（老用户）

如果您之前已经配置了私钥，需要运行迁移脚本：

```bash
node server/scripts/migratePrivateKey.js
```

**迁移过程**:
1. 读取数据库中的明文私钥
2. 使用 AES-256-GCM 加密
3. 保存加密后的私钥
4. 删除明文私钥字段
5. 保存钱包地址

**注意**: 迁移脚本会自动检测是否已迁移，可以安全地多次运行。

### 3. 查看钱包状态

在钱包配置页面顶部，可以看到：
- 钱包地址
- TRX 余额
- USDT 余额
- 余额预警（如有）

点击 "刷新" 按钮可以更新余额。

---

## 🔒 安全说明

### 1. 私钥加密

**加密算法**: AES-256-GCM
- 256位密钥长度
- GCM 模式提供认证加密
- 防止篡改和伪造

**密钥派生**: PBKDF2
- 100,000次迭代
- SHA-512 哈希
- 64字节随机 Salt
- 防止暴力破解

### 2. 主密钥管理

主密钥从环境变量获取：
1. 优先使用 `ENCRYPTION_KEY`
2. 如果未设置，使用 `JWT_SECRET`

**建议**: 在 `.env` 文件中设置独立的 `ENCRYPTION_KEY`

```env
# 加密主密钥（建议64位十六进制字符串）
ENCRYPTION_KEY=your_64_character_hex_string_here
```

生成主密钥：
```javascript
const crypto = require('crypto');
console.log(crypto.randomBytes(32).toString('hex'));
```

### 3. 安全最佳实践

✅ **推荐做法**:
- 使用独立的 `ENCRYPTION_KEY`
- 定期备份加密后的私钥
- 使用专用钱包，不要与个人资产混用
- 定期更换钱包（可选）
- 限制管理员账户数量

⚠️ **注意事项**:
- 不要将 `.env` 文件提交到 Git
- 不要在日志中输出私钥
- 不要在前端显示私钥
- 不要通过不安全的渠道传输私钥

---

## 🔄 数据库字段变更

### Settings 模型

**移除字段**:
```javascript
tronPrivateKey: String  // 明文私钥（不安全）
```

**新增字段**:
```javascript
tronPrivateKeyEncrypted: String  // 加密后的私钥
tronWalletAddress: String        // 钱包地址（用于显示）
walletAutoTransferEnabled: Boolean  // 是否启用自动转账
walletMaxRetryCount: Number      // 最大重试次数
walletMinTRXBalance: Number      // TRX最低余额预警
walletMinUSDTBalance: Number     // USDT最低余额预警
```

---

## 📊 功能对比

### 之前（不安全）

```
系统设置 → TRON配置
  ├─ TRON API URL
  └─ 钱包私钥（明文存储）❌
```

**问题**:
- 私钥明文存储在数据库
- 与其他配置混在一起
- 没有验证功能
- 没有测试功能

### 现在（安全）

```
钱包配置（独立页面）
  ├─ 钱包状态监控
  │  ├─ 钱包地址
  │  ├─ TRX 余额
  │  └─ USDT 余额
  ├─ 基本配置
  │  ├─ TRON API URL
  │  └─ 钱包私钥（AES-256-GCM加密）✅
  ├─ 转账配置
  │  ├─ 自动转账开关
  │  ├─ 最大重试次数
  │  ├─ TRX 余额预警
  │  └─ USDT 余额预警
  └─ 功能按钮
     ├─ 验证私钥
     ├─ 测试连接
     └─ 保存配置
```

**优势**:
- ✅ 私钥加密存储
- ✅ 独立配置页面
- ✅ 实时余额监控
- ✅ 私钥验证功能
- ✅ 连接测试功能
- ✅ 更多配置选项

---

## 🎯 API 接口

### 钱包配置 API

#### 1. 获取钱包配置
```http
GET /api/wallet/config
Authorization: Bearer <token>
```

**响应**:
```json
{
  "tronApiUrl": "https://api.trongrid.io",
  "tronWalletAddress": "TXxxxxxxxxxx",
  "hasPrivateKey": true,
  "walletAutoTransferEnabled": true,
  "walletMaxRetryCount": 3,
  "walletMinTRXBalance": 50,
  "walletMinUSDTBalance": 100
}
```

#### 2. 更新钱包配置
```http
PUT /api/wallet/config
Authorization: Bearer <token>
Content-Type: application/json

{
  "tronApiUrl": "https://api.trongrid.io",
  "tronPrivateKey": "64位十六进制私钥",
  "walletAutoTransferEnabled": true,
  "walletMaxRetryCount": 3,
  "walletMinTRXBalance": 50,
  "walletMinUSDTBalance": 100
}
```

#### 3. 测试钱包连接
```http
POST /api/wallet/test
Authorization: Bearer <token>
```

#### 4. 获取钱包余额
```http
GET /api/wallet/balance
Authorization: Bearer <token>
```

#### 5. 验证私钥
```http
POST /api/wallet/validate-key
Authorization: Bearer <token>
Content-Type: application/json

{
  "privateKey": "64位十六进制私钥"
}
```

---

## ✅ 检查清单

### 部署前检查

- [ ] 已设置 `ENCRYPTION_KEY` 环境变量
- [ ] 已运行私钥迁移脚本（如果是老用户）
- [ ] 已在钱包配置页面测试连接
- [ ] 已验证钱包余额显示正常
- [ ] 已测试完整的支付和转账流程

### 安全检查

- [ ] `.env` 文件未提交到 Git
- [ ] 数据库中私钥已加密
- [ ] 前端无法访问明文私钥
- [ ] 日志中不包含私钥信息
- [ ] 只有管理员可以访问钱包配置

---

## 🐛 故障排查

### 问题 1: 迁移脚本失败

**可能原因**:
- 未设置 `ENCRYPTION_KEY` 或 `JWT_SECRET`
- 数据库连接失败
- 私钥格式错误

**解决方法**:
1. 检查 `.env` 文件配置
2. 确认数据库连接正常
3. 验证私钥格式（64位十六进制）

### 问题 2: 钱包初始化失败

**可能原因**:
- 主密钥错误
- 加密数据损坏
- 网络连接问题

**解决方法**:
1. 确认 `ENCRYPTION_KEY` 未更改
2. 检查数据库中的加密数据
3. 测试 TRON 网络连接

### 问题 3: 无法保存配置

**可能原因**:
- 私钥格式错误
- 权限不足
- 网络问题

**解决方法**:
1. 使用 "验证私钥" 功能检查格式
2. 确认是管理员账户
3. 检查网络连接

---

## 📚 相关文档

- [加密货币自动转账完成报告](./加密货币自动转账_完成报告.md)
- [快速开始指南](./QUICK_START_CRYPTO.md)
- [部署检查清单](./DEPLOYMENT_CHECKLIST.md)

---

## 🎉 总结

### 主要改进

1. ✅ **安全性大幅提升**
   - 私钥使用 AES-256-GCM 加密
   - PBKDF2 密钥派生
   - 前端永远不会看到明文私钥

2. ✅ **用户体验优化**
   - 独立的钱包配置页面
   - 可视化配置界面
   - 实时余额监控
   - 私钥验证功能

3. ✅ **功能更完善**
   - 自动转账开关
   - 重试次数配置
   - 余额预警设置
   - 连接测试功能

### 安全保障

- 🔒 AES-256-GCM 加密算法
- 🔒 PBKDF2 密钥派生（100,000次迭代）
- 🔒 随机 Salt 和 IV
- 🔒 认证标签验证
- 🔒 只在后端处理私钥

**您的私钥现在更安全了！** 🎉

---

*文档创建时间: 2026-01-29*
*版本: 2.0.0*
