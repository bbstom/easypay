# Telegram ç™»å½•è‡ªåŠ¨æ³¨å†Œè¯´æ˜

## âœ… åŠŸèƒ½ç¡®è®¤

**æ–°ç”¨æˆ·å¯ä»¥ç›´æ¥ç™»å½•ï¼Œä¸éœ€è¦å…ˆåœ¨ Bot ä¸­ `/start`ï¼**

## ğŸ”„ å·¥ä½œæµç¨‹

### å½“å‰å®ç°ï¼ˆå·²æ”¯æŒè‡ªåŠ¨æ³¨å†Œï¼‰

```
1. æ–°ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢
   â†“
2. ç‚¹å‡»"æ‰“å¼€ Telegram åº”ç”¨ç™»å½•"
   â†“
3. Telegram åº”ç”¨æ‰“å¼€ï¼Œæ˜¾ç¤ºç¡®è®¤æ¶ˆæ¯
   â†“
4. ç”¨æˆ·ç‚¹å‡»"âœ… ç¡®è®¤ç™»å½•"
   â†“
5. Bot è°ƒç”¨ confirm-qr-login API
   â†“
6. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   â”œâ”€ ä¸å­˜åœ¨ â†’ è‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ· âœ…
   â””â”€ å·²å­˜åœ¨ â†’ æ›´æ–°ç”¨æˆ·ä¿¡æ¯
   â†“
7. å­˜å‚¨ç™»å½•æ•°æ®
   â†“
8. å‰ç«¯æ£€æµ‹åˆ°ç™»å½•æˆåŠŸ
   â†“
9. è°ƒç”¨ qr-login-complete API
   â†“
10. å†æ¬¡æ£€æŸ¥ç”¨æˆ·ï¼ˆåŒé‡ä¿é™©ï¼‰
   â”œâ”€ ä¸å­˜åœ¨ â†’ è‡ªåŠ¨åˆ›å»ºï¼ˆå¤‡ç”¨é€»è¾‘ï¼‰âœ…
   â””â”€ å·²å­˜åœ¨ â†’ ç»§ç»­
   â†“
11. ç”Ÿæˆ JWT token
   â†“
12. è¿”å›ç»™å‰ç«¯
   â†“
13. è‡ªåŠ¨è·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒ
```

## ğŸ“ è‡ªåŠ¨åˆ›å»ºç”¨æˆ·çš„ä½ç½®

### 1. confirm-qr-login APIï¼ˆä¸»è¦ï¼‰

**æ–‡ä»¶ï¼š** `server/routes/auth.js`

```javascript
// æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
let user = await User.findOne({ telegramId: telegramId.toString() });

if (!user) {
  const crypto = require('crypto');
  user = new User({
    username: username || `tg_${telegramId}`,
    email: `${telegramId}@telegram.user`,
    telegramId: telegramId.toString(),
    telegramUsername: username,
    telegramFirstName: firstName,
    telegramLastName: lastName,
    telegramPhotoUrl: photoUrl,
    password: crypto.randomBytes(32).toString('hex')
  });
  await user.save();
  console.log('âœ… åˆ›å»ºæ–°ç”¨æˆ·:', user.username);
}
```

**è§¦å‘æ—¶æœºï¼š** ç”¨æˆ·åœ¨ Telegram ä¸­ç‚¹å‡»"ç¡®è®¤ç™»å½•"æ—¶

### 2. qr-login-complete APIï¼ˆå¤‡ç”¨ï¼‰

**æ–‡ä»¶ï¼š** `server/routes/auth.js`

```javascript
// æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
let user = await User.findOne({ telegramId: userData.id.toString() });

if (!user) {
  // å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»ºï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼Œä½†ä½œä¸ºå¤‡ç”¨ï¼‰
  const crypto = require('crypto');
  user = new User({
    username: userData.username || `tg_${userData.id}`,
    email: `${userData.id}@telegram.user`,
    telegramId: userData.id.toString(),
    telegramUsername: userData.username,
    telegramFirstName: userData.first_name,
    telegramLastName: userData.last_name,
    telegramPhotoUrl: userData.photo_url,
    password: crypto.randomBytes(32).toString('hex')
  });
  await user.save();
  console.log('âœ… è‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ·:', user.username);
}
```

**è§¦å‘æ—¶æœºï¼š** å‰ç«¯è°ƒç”¨ complete API æ—¶ï¼ˆä½œä¸ºåŒé‡ä¿é™©ï¼‰

## ğŸ¯ ç”¨æˆ·ä½“éªŒ

### æ–°ç”¨æˆ·é¦–æ¬¡ç™»å½•

1. **æ— éœ€æ³¨å†Œ** - ç‚¹å‡»ç™»å½•å³å¯
2. **æ— éœ€å¡«å†™ä¿¡æ¯** - è‡ªåŠ¨ä» Telegram è·å–
3. **æ— éœ€éªŒè¯é‚®ç®±** - ä½¿ç”¨ Telegram èº«ä»½éªŒè¯
4. **æ— éœ€è®°ä½å¯†ç ** - ä½¿ç”¨ Telegram ç™»å½•

### è‡ªåŠ¨åˆ›å»ºçš„ç”¨æˆ·ä¿¡æ¯

```javascript
{
  username: 'telegram_username' æˆ– 'tg_123456789',
  email: '123456789@telegram.user',
  telegramId: '123456789',
  telegramUsername: 'telegram_username',
  telegramFirstName: 'First',
  telegramLastName: 'Last',
  telegramPhotoUrl: 'https://...',
  password: 'éšæœºç”Ÿæˆçš„32å­—èŠ‚å¯†ç ',
  role: 'user',
  createdAt: Date.now()
}
```

## ğŸ” ä¸ Bot /start çš„åŒºåˆ«

### é€šè¿‡ç½‘ç«™ç™»å½•ï¼ˆæ¨èï¼‰

```
ä¼˜ç‚¹ï¼š
âœ… æ— éœ€å…ˆè®¿é—® Bot
âœ… ç›´æ¥åœ¨ç½‘ç«™ä¸Šå®Œæˆ
âœ… ç”¨æˆ·ä½“éªŒæ›´å¥½
âœ… æµç¨‹æ›´ç®€å•

æµç¨‹ï¼š
ç½‘ç«™ç™»å½• â†’ Telegram ç¡®è®¤ â†’ è‡ªåŠ¨åˆ›å»ºç”¨æˆ· â†’ ç™»å½•æˆåŠŸ
```

### é€šè¿‡ Bot /start

```
ä¼˜ç‚¹ï¼š
âœ… å¯ä»¥çœ‹åˆ°æ¬¢è¿æ¶ˆæ¯
âœ… å¯ä»¥äº†è§£ Bot åŠŸèƒ½
âœ… å¯ä»¥ç›´æ¥åœ¨ Bot ä¸­æ“ä½œ

æµç¨‹ï¼š
è®¿é—® Bot â†’ /start â†’ åˆ›å»ºç”¨æˆ· â†’ ç½‘ç«™ç™»å½• â†’ ç™»å½•æˆåŠŸ
```

## ğŸ“Š ä¸¤ç§æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | ç½‘ç«™ç™»å½• | Bot /start |
|------|---------|-----------|
| éœ€è¦å…ˆè®¿é—® Bot | âŒ ä¸éœ€è¦ | âœ… éœ€è¦ |
| è‡ªåŠ¨åˆ›å»ºç”¨æˆ· | âœ… æ˜¯ | âœ… æ˜¯ |
| ç”¨æˆ·ä½“éªŒ | â­â­â­â­â­ | â­â­â­â­ |
| æµç¨‹æ­¥éª¤ | 3 æ­¥ | 4 æ­¥ |
| æ¨èç¨‹åº¦ | â­â­â­â­â­ | â­â­â­ |

## ğŸ‰ æ€»ç»“

### å½“å‰å®ç°çš„ä¼˜åŠ¿

1. âœ… **æ–°ç”¨æˆ·å¯ä»¥ç›´æ¥ç™»å½•** - æ— éœ€å…ˆåœ¨ Bot ä¸­ /start
2. âœ… **è‡ªåŠ¨åˆ›å»ºç”¨æˆ·** - åœ¨ä¸¤ä¸ªåœ°æ–¹éƒ½æœ‰åˆ›å»ºé€»è¾‘
3. âœ… **åŒé‡ä¿é™©** - confirm å’Œ complete éƒ½ä¼šæ£€æŸ¥å¹¶åˆ›å»º
4. âœ… **ç”¨æˆ·ä½“éªŒå¥½** - æµç¨‹ç®€å•ï¼Œæ­¥éª¤å°‘

### ç”¨æˆ·åªéœ€è¦

1. è®¿é—®ç½‘ç«™ç™»å½•é¡µé¢
2. ç‚¹å‡»"æ‰“å¼€ Telegram åº”ç”¨ç™»å½•"
3. åœ¨ Telegram ä¸­ç‚¹å‡»"ç¡®è®¤ç™»å½•"
4. è‡ªåŠ¨å®Œæˆæ³¨å†Œå’Œç™»å½•

**å°±è¿™ä¹ˆç®€å•ï¼** ğŸ‰

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªåˆ›å»ºç”¨æˆ·çš„åœ°æ–¹ï¼Ÿ

1. **confirm-qr-loginï¼ˆä¸»è¦ï¼‰**
   - Bot è°ƒç”¨æ—¶åˆ›å»º
   - ç¡®ä¿ç”¨æˆ·åœ¨ç¡®è®¤ç™»å½•æ—¶å°±å·²åˆ›å»º
   - è¿™æ˜¯ä¸»è¦çš„åˆ›å»ºé€»è¾‘

2. **qr-login-completeï¼ˆå¤‡ç”¨ï¼‰**
   - å‰ç«¯è°ƒç”¨æ—¶æ£€æŸ¥
   - å¦‚æœ confirm å¤±è´¥ï¼Œè¿™é‡Œä½œä¸ºå¤‡ç”¨
   - åŒé‡ä¿é™©ï¼Œç¡®ä¿ä¸ä¼šå‡ºç°ç”¨æˆ·ä¸å­˜åœ¨çš„æƒ…å†µ

### ä¸ºä»€ä¹ˆä¸éœ€è¦å…ˆ /startï¼Ÿ

å› ä¸ºï¼š
1. âœ… ç™»å½•æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºç”¨æˆ·
2. âœ… ä» Telegram è·å–æ‰€æœ‰å¿…è¦ä¿¡æ¯
3. âœ… ä¸éœ€è¦ç”¨æˆ·æ‰‹åŠ¨å¡«å†™ä»»ä½•ä¿¡æ¯
4. âœ… Telegram èº«ä»½éªŒè¯å·²ç»è¶³å¤Ÿå®‰å…¨

### ä»€ä¹ˆæ—¶å€™éœ€è¦ /startï¼Ÿ

åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µï¼š
- ç”¨æˆ·æƒ³å…ˆäº†è§£ Bot åŠŸèƒ½
- ç”¨æˆ·æƒ³ç›´æ¥åœ¨ Bot ä¸­æ“ä½œ
- ç”¨æˆ·æƒ³çœ‹æ¬¢è¿æ¶ˆæ¯

ä½†è¿™äº›éƒ½æ˜¯**å¯é€‰çš„**ï¼Œä¸æ˜¯å¿…éœ€çš„ï¼

## ğŸ“ ä¿®æ”¹è®°å½•

### æœ€æ–°ä¿®æ”¹ï¼ˆ2026-02-06ï¼‰

**æ–‡ä»¶ï¼š** `server/routes/auth.js`

**ä¿®æ”¹å†…å®¹ï¼š**
- åœ¨ `qr-login-complete` API ä¸­æ·»åŠ è‡ªåŠ¨åˆ›å»ºç”¨æˆ·çš„é€»è¾‘
- ä» `return 404` æ”¹ä¸ºè‡ªåŠ¨åˆ›å»ºç”¨æˆ·
- ä½œä¸ºåŒé‡ä¿é™©ï¼Œç¡®ä¿ç”¨æˆ·ä¸€å®šå­˜åœ¨

**ä¿®æ”¹å‰ï¼š**
```javascript
const user = await User.findOne({ telegramId: userData.id.toString() });
if (!user) {
  return res.status(404).json({ error: 'ç”¨æˆ·ä¸å­˜åœ¨' });
}
```

**ä¿®æ”¹åï¼š**
```javascript
let user = await User.findOne({ telegramId: userData.id.toString() });
if (!user) {
  // è‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ·
  user = new User({ /* ... */ });
  await user.save();
  console.log('âœ… è‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ·:', user.username);
}
```

## ğŸš€ éƒ¨ç½²

```bash
# é‡å¯åç«¯
pm2 restart easypay-backend

# æŸ¥çœ‹æ—¥å¿—
pm2 logs easypay-backend
```

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•æ–°ç”¨æˆ·ç›´æ¥ç™»å½•

1. ä½¿ç”¨ä¸€ä¸ªä»æœªè®¿é—®è¿‡ Bot çš„ Telegram è´¦å·
2. è®¿é—®ç½‘ç«™ç™»å½•é¡µé¢
3. ç‚¹å‡»"æ‰“å¼€ Telegram åº”ç”¨ç™»å½•"
4. åœ¨ Telegram ä¸­ç‚¹å‡»"ç¡®è®¤ç™»å½•"
5. åº”è¯¥è‡ªåŠ¨åˆ›å»ºç”¨æˆ·å¹¶ç™»å½•æˆåŠŸ

### é¢„æœŸæ—¥å¿—

```
ğŸ” æ”¶åˆ°ç™»å½•ç¡®è®¤è¯·æ±‚: { token: 'xxx', telegramId: '123456789' }
âœ… åˆ›å»ºæ–°ç”¨æˆ·: tg_123456789
âœ… ç™»å½•æ•°æ®å·²å­˜å‚¨: { token: 'xxx', sessionCount: 1 }
âœ… æ£€æµ‹åˆ°ç™»å½•æˆåŠŸ: { token: 'xxx', telegramId: '123456789' }
âœ… æ‰«ç ç™»å½•å®Œæˆ: { userId: 'xxx', username: 'tg_123456789' }
```

ç°åœ¨æ–°ç”¨æˆ·å¯ä»¥ç›´æ¥ç™»å½•ï¼Œæ— éœ€ä»»ä½•é¢å¤–æ­¥éª¤ï¼ğŸ‰
