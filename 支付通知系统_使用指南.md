# 支付通知系统使用指南

## 当前状态

### ✅ 已完成
1. **支付回调正常工作**
   - 支付平台使用 GET 请求回调
   - 返回 "success"（小写）
   - 订单支付状态正确更新

2. **通知系统已实现**
   - 支付成功通知
   - 代付完成通知
   - 代付失败通知
   - 优雅的居中弹窗设计

3. **订单状态轮询**
   - 每 3 秒查询一次
   - 5 分钟后自动停止
   - 实时更新订单状态

### ❌ 当前问题
**钱包余额不足导致代付失败**

```
钱包地址: TP4Cr7xRZ7jGZ5XmKt2aN7NP6yFGG99999
TRX 余额: 0.265 TRX  ❌ (需要至少 10-20 TRX)
USDT 余额: 1.580 USDT ❌ (需要 2 USDT)
```

## 通知系统工作流程

### 1. 用户支付流程

```
用户提交订单
    ↓
显示支付二维码
    ↓
用户扫码支付
    ↓
支付平台回调（GET请求）
    ↓
更新订单状态为 "paid"
    ↓
前端轮询检测到支付成功
    ↓
🔔 显示通知："支付成功，正在处理代付"
    ↓
后端执行代付转账
    ↓
前端继续轮询订单状态
    ↓
检测到代付完成/失败
    ↓
🔔 显示通知："代付完成" 或 "代付失败"
```

### 2. 通知类型

#### 通知 1: 支付成功
```
标题: 支付成功
内容: 您的订单支付已确认！
     正在处理 USDT 代付，请稍候...
类型: 成功（蓝色/绿色）
触发: paymentStatus === 'paid'
```

#### 通知 2: 代付完成
```
标题: USDT 代付完成
内容: 2 USDT 已成功转账到您的地址！
     
     交易哈希：abc123...xyz789
     
     点击历史订单可查看详情
类型: 成功（蓝色/绿色）
触发: status === 'completed'
```

#### 通知 3: 代付失败
```
标题: USDT 代付失败
内容: 转账失败，请联系客服处理。
     
     可能原因：
     • 钱包余额不足
     • 网络拥堵
     
     请联系客服处理或稍后重试
类型: 错误（红色）
触发: status === 'failed'
```

## 解决当前问题

### 步骤 1: 充值钱包

**充值 USDT:**
```
钱包地址: TP4Cr7xRZ7jGZ5XmKt2aN7NP6yFGG99999
建议充值: 100 USDT 或更多
网络: TRC20
```

**充值 TRX:**
```
钱包地址: TP4Cr7xRZ7jGZ5XmKt2aN7NP6yFGG99999
建议充值: 100 TRX 或更多
用途: 支付 gas 费用
```

### 步骤 2: 验证充值

```bash
# 检查钱包余额
node server/scripts/testWallet.js
```

期望输出：
```
💰 TRX 余额: 100+ TRX  ✅
💵 USDT 余额: 100+ USDT ✅
✅ 状态: 就绪
```

### 步骤 3: 重试失败的订单

**方法 1: 使用脚本**
```bash
node server/scripts/checkOrderStatus.js ORD1770025130619CL6KPC2
```

**方法 2: 管理后台**
1. 登录管理后台
2. 进入"财务管理"
3. 找到失败的订单
4. 点击"重试"按钮

### 步骤 4: 测试新订单

1. 打开前端页面
2. 输入收款地址和金额
3. 选择支付方式
4. 点击"立即支付"
5. 扫码支付
6. **观察通知**：
   - 第一个通知：支付成功
   - 第二个通知：代付完成（或失败）

## 调试通知系统

### 查看浏览器控制台

打开浏览器开发者工具（F12），查看控制台输出：

```javascript
// 开始轮询
🔄 开始轮询订单状态: ORD1770025130619CL6KPC2

// 每3秒输出一次
📊 订单状态: {
  orderId: "ORD1770025130619CL6KPC2",
  paymentStatus: "paid",
  transferStatus: "processing",
  status: "paid"
}

// 支付成功
✅ 支付成功，显示通知

// 代付完成
✅ 代付完成，显示通知

// 或代付失败
❌ 代付失败，显示通知
```

### 常见问题

**Q: 为什么没有看到通知？**
A: 检查：
1. 浏览器控制台是否有错误
2. 是否关闭了支付二维码弹窗（轮询会继续）
3. 网络是否正常

**Q: 通知显示后如何关闭？**
A: 点击"知道了"按钮手动关闭

**Q: 轮询会持续多久？**
A: 最多 5 分钟，之后自动停止

## 优化建议

### 1. 启用能量租赁

进入：代付系统 → 能量租赁

**优势:**
- 降低 TRX 消耗 70-80%
- 每笔 USDT 转账只需 3-5 TRX（vs 13-30 TRX）

### 2. 设置余额预警

在管理后台设置：
- TRX 余额低于 50 时发送邮件提醒
- USDT 余额低于 100 时发送邮件提醒

### 3. 自动充值

考虑设置自动充值机制：
- 当余额低于阈值时自动从主钱包转账
- 或使用第三方充值服务

## 测试清单

- [ ] 钱包已充值（TRX ≥ 100, USDT ≥ 100）
- [ ] 钱包状态检查通过
- [ ] 创建测试订单
- [ ] 完成支付
- [ ] 看到"支付成功"通知
- [ ] 看到"代付完成"通知
- [ ] 在历史订单中看到交易哈希
- [ ] 在 TronScan 上验证交易

## 总结

✅ **通知系统已完整实现**
- 支付成功通知
- 代付完成通知
- 代付失败通知（含详细原因）

❌ **当前唯一问题：钱包余额不足**
- 充值后即可正常使用
- 建议启用能量租赁降低成本

📝 **下一步操作**
1. 充值钱包（TRX + USDT）
2. 重试失败的订单
3. 测试新订单
4. 验证通知系统
