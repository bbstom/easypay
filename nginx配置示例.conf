# ==================== EasyPay Nginx 配置示例 ====================
# 适用于生产环境的完整配置
# 
# 配置说明：
# 1. 用户只能访问 443 端口（HTTPS）
# 2. 80 端口自动跳转到 443
# 3. 后端 5000 端口不对外开放，只监听 127.0.0.1
# 4. 所有 /api 请求代理到后端
# 5. 其他请求服务前端静态文件
#
# 使用方法：
# 1. 替换 your-domain.com 为你的域名
# 2. 替换 SSL 证书路径
# 3. 替换项目路径
# 4. 保存到 /etc/nginx/sites-available/easypay.conf
# 5. 创建软链接：ln -s /etc/nginx/sites-available/easypay.conf /etc/nginx/sites-enabled/
# 6. 测试配置：nginx -t
# 7. 重载配置：nginx -s reload

# ==================== HTTP 自动跳转到 HTTPS ====================
server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com www.your-domain.com;
    
    # 自动跳转到 HTTPS
    return 301 https://$server_name$request_uri;
}

# ==================== HTTPS 主配置 ====================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # ==================== SSL 证书配置 ====================
    ssl_certificate /path/to/your/fullchain.pem;
    ssl_certificate_key /path/to/your/privkey.pem;
    
    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # ==================== 日志配置 ====================
    access_log /var/log/nginx/easypay_access.log;
    error_log /var/log/nginx/easypay_error.log;
    
    # ==================== 基础配置 ====================
    # 客户端最大上传大小
    client_max_body_size 10M;
    
    # 客户端请求体缓冲大小
    client_body_buffer_size 128k;
    
    # 隐藏 Nginx 版本号
    server_tokens off;
    
    # ==================== 后端 API 代理 ====================
    # 所有 /api 开头的请求转发到后端
    # 示例：https://your-domain.com/api/users -> http://127.0.0.1:5000/api/users
    location /api {
        # 代理到后端（后端监听 127.0.0.1:5000，不对外开放）
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        
        # 传递真实 IP 和 Host
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 禁用缓存（API 请求不应该被缓存）
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
        
        # WebSocket 支持（如果需要）
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # ==================== 前端静态文件 ====================
    # 生产环境：直接服务构建后的静态文件
    location / {
        # 前端构建后的静态文件目录
        root /path/to/easypay/dist;
        
        # 支持 React Router 的 History 模式
        try_files $uri $uri/ /index.html;
        
        # 默认首页
        index index.html;
        
        # 静态资源缓存（图片、字体、CSS、JS）
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|webp)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        
        # HTML 文件不缓存（确保更新后立即生效）
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
        }
    }
    
    # ==================== 安全头部配置 ====================
    # 防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # XSS 防护
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 内容类型嗅探防护
    add_header X-Content-Type-Options "nosniff" always;
    
    # HSTS（强制 HTTPS，有效期 1 年）
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # CSP（内容安全策略，根据需要调整）
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;
    
    # Referrer 策略
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # ==================== 禁止访问敏感文件 ====================
    # 禁止访问 .env 等配置文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # 禁止访问备份文件
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ==================== Gzip 压缩 ====================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";
}

# ==================== 宝塔面板用户注意 ====================
# 如果使用宝塔面板，可以通过以下步骤配置：
#
# 1. 添加站点
#    - 域名：your-domain.com
#    - 根目录：/path/to/easypay/dist
#    - PHP 版本：纯静态
#
# 2. 配置反向代理
#    - 进入站点设置 -> 反向代理
#    - 添加反向代理：
#      * 代理名称：backend-api
#      * 目标 URL：http://127.0.0.1:5000
#      * 发送域名：$host
#      * 代理目录：/api
#
# 3. 配置 SSL
#    - 进入站点设置 -> SSL
#    - 申请 Let's Encrypt 免费证书
#    - 开启强制 HTTPS
#
# 4. 配置伪静态（支持 React Router）
#    - 进入站点设置 -> 伪静态
#    - 添加规则：
#      location / {
#          try_files $uri $uri/ /index.html;
#      }

# ==================== 重要提示 ====================
# 1. 后端配置
#    - 后端应该监听 127.0.0.1:5000（不对外开放）
#    - 在 server/index.js 中：app.listen(5000, '127.0.0.1')
#
# 2. 环境变量配置
#    - APP_URL=https://your-domain.com
#    - FRONTEND_URL=https://your-domain.com
#    - API_URL=https://your-domain.com
#    - 不要包含端口号
#
# 3. 防火墙配置
#    - 只开放 80 和 443 端口
#    - 不要开放 5000 端口给外部访问
#    - ufw allow 80/tcp
#    - ufw allow 443/tcp
#
# 4. 支付回调地址
#    - 配置为：https://your-domain.com/api/payments/callback
#    - 支付平台会通过 443 端口访问
#
# 5. Telegram Webhook
#    - 配置为：https://your-domain.com/api/telegram/webhook
#    - Telegram 会通过 443 端口访问
#
# 6. PM2 配置
#    - 确保后端通过 PM2 启动
#    - pm2 start ecosystem.config.js
#    - pm2 save
#    - pm2 startup
