# 密码问题诊断和修复

## 当前状态

✅ Nginx 反向代理已工作（API 可访问）  
❌ 登录失败，提示"邮箱或密码错误"（401 错误）

---

## 快速诊断

### 步骤 1：检查用户和密码

```bash
cd /www/wwwroot/kk.vpno.eu.org/easypay
node server/scripts/checkUserPassword.js
```

这个脚本会：
1. 列出所有用户
2. 测试常见的密码组合
3. 告诉你哪个账号密码是正确的

---

### 步骤 2：重置密码（如果需要）

如果所有密码都不对，运行：

```bash
node server/scripts/resetPassword.js
```

按提示操作：
1. 选择要重置的用户邮箱
2. 输入新密码（至少 6 位）
3. 记住新密码

---

## 可能的原因

### 原因 1：数据库中有多个用户

初始化脚本创建了 `kailsay@gmail.com`，但可能还有旧的 `admin@fastpay.com` 账号。

**解决方案**：
- 使用 `checkUserPassword.js` 查看所有用户
- 尝试用不同的账号登录
- 或者删除旧账号，只保留一个

### 原因 2：密码在保存时被加密

用户模型使用 bcrypt 加密密码。如果密码保存过程有问题，可能导致验证失败。

**解决方案**：
- 使用 `resetPassword.js` 重新设置密码
- 新密码会被正确加密

### 原因 3：数据库连接到了错误的数据库

检查 `.env` 中的 `MONGODB_URI` 是否正确。

---

## 测试登录的账号组合

尝试以下组合：

1. **邮箱**: `kailsay@gmail.com`  
   **密码**: `specter1234`

2. **邮箱**: `admin@fastpay.com`  
   **密码**: `admin123`

3. **邮箱**: `kailsay@gmail.com`  
   **密码**: `admin123`

---

## 创建新的管理员账号

如果以上都不行，创建一个全新的管理员账号：

```bash
node server/scripts/createNewAdmin.js
```

---

## 验证步骤

### 1. 命令行测试

```bash
# 检查用户
node server/scripts/checkUserPassword.js

# 测试登录 API
curl -X POST https://kk.vpno.eu.org/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"kailsay@gmail.com","password":"specter1234"}'
```

### 2. 浏览器测试

1. 访问 `https://kk.vpno.eu.org`
2. 打开开发者工具（F12）
3. 尝试登录
4. 查看 Network 标签中的 `login` 请求
5. 查看 Response 内容

---

## 后端日志检查

查看后端是否有错误信息：

```bash
pm2 logs easypay-backend --lines 50
```

关注：
- 数据库连接错误
- 密码验证错误
- JWT 相关错误

---

## 快速修复流程

```bash
# 1. 进入项目目录
cd /www/wwwroot/kk.vpno.eu.org/easypay

# 2. 检查用户和密码
node server/scripts/checkUserPassword.js

# 3. 如果密码不对，重置密码
node server/scripts/resetPassword.js

# 4. 测试登录
curl -X POST https://kk.vpno.eu.org/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"你的邮箱","password":"你的新密码"}'

# 5. 浏览器登录测试
```

---

## 成功标志

✅ `checkUserPassword.js` 显示密码正确  
✅ curl 测试返回 token  
✅ 浏览器可以成功登录  
✅ 可以看到"管理后台"按钮
