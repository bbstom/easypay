# 钱包显示问题排查指南

## 问题描述
前端钱包列表显示异常，无法点击查看详情。

## 排查步骤

### 步骤1: 检查后端API数据
```bash
node server/scripts/testWalletApi.js
```

这个脚本会：
- 测试钱包列表API
- 测试钱包详情API
- 验证所有字段是否存在
- 显示完整的数据结构

**预期结果**：所有字段都应该显示 ✅

### 步骤2: 清理前端缓存
```bash
# 停止前端服务 (Ctrl+C)

# 删除 Vite 缓存
rmdir /s /q node_modules\.vite

# 重启前端
npm run dev
```

### 步骤3: 清理浏览器缓存
1. 打开浏览器开发者工具 (F12)
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

或者：
- Chrome: `Ctrl + Shift + Delete` → 清除"缓存的图片和文件"
- 强制刷新: `Ctrl + F5`

### 步骤4: 检查浏览器控制台错误
1. 打开开发者工具 (F12)
2. 切换到 Console 标签
3. 刷新页面
4. 查看是否有红色错误信息

**常见错误**：
- `Cannot read properties of undefined` - 说明数据结构有问题
- `wallet.health is undefined` - 后端返回的数据不完整
- `404 Not Found` - API路由问题

### 步骤5: 检查网络请求
1. 开发者工具 → Network 标签
2. 刷新页面
3. 找到 `/api/wallets` 请求
4. 查看 Response 标签，确认返回的数据结构

**检查项**：
```json
{
  "success": true,
  "wallets": [
    {
      "_id": "...",
      "name": "...",
      "address": "...",
      "enabled": true,
      "priority": 50,
      "balance": {
        "trx": 0,
        "usdt": 0
      },
      "resources": {
        "energy": { "available": 0, "limit": 0 },
        "bandwidth": { "available": 0, "limit": 0 }
      },
      "stats": {
        "totalTransactions": 0,
        "successCount": 0,
        "failCount": 0
      },
      "health": {
        "status": "healthy"
      },
      "status": "healthy",
      "usageCount": 0,
      "alerts": {
        "minTrxBalance": 50,
        "minUsdtBalance": 100
      }
    }
  ]
}
```

### 步骤6: 验证修复的文件
确认以下文件已经更新：

1. **server/routes/wallets.js**
   - GET `/api/wallets` 返回 `_id` 和 `status` 字段
   - GET `/api/wallets/:id` 返回完整数据
   - PUT `/api/wallets/:id/status` 接口存在

2. **src/pages/WalletConfigPage.jsx**
   - 使用 `wallet._id || wallet.id`
   - 使用可选链 `wallet.health?.status`
   - 使用可选链 `wallet.balance?.trx`
   - 默认 tab 是 `wallets`
   - 有主 tab 导航菜单

3. **src/pages/PaymentSystemPage.jsx**
   - 使用 `wallet.enabled` 而不是 `wallet.isActive`
   - 使用可选链访问嵌套属性

## 如果问题依然存在

### 方案A: 完全重启
```bash
# 1. 停止所有服务
# 2. 删除缓存
rmdir /s /q node_modules\.vite

# 3. 重启后端
node server/index.js

# 4. 重启前端（新终端）
npm run dev

# 5. 清理浏览器缓存并强制刷新 (Ctrl+F5)
```

### 方案B: 检查数据库
如果钱包数据是旧的，可能缺少某些字段：

```bash
# 刷新所有钱包数据
node server/scripts/refreshWallets.js
```

### 方案C: 提供错误信息
如果以上都不行，请提供：
1. 浏览器控制台的完整错误信息
2. Network 标签中 `/api/wallets` 的响应数据
3. `node server/scripts/testWalletApi.js` 的输出

## 测试页面

修复后，测试以下页面：

1. **代付系统 - 钱包管理**
   ```
   http://localhost:3000/payment-system?tab=wallets
   ```
   - 应该能看到钱包列表
   - 钱包卡片显示正常
   - 切换按钮可以启用/禁用钱包

2. **钱包配置 - 钱包管理**
   ```
   http://localhost:3000/wallet?tab=wallets
   ```
   - 应该能看到钱包列表
   - 点击钱包能查看详情
   - 详情页显示余额、资源、统计等信息

3. **钱包配置 - API配置**
   ```
   http://localhost:3000/wallet?tab=basic&subtab=api
   ```
   - 应该能看到API节点配置界面
   - 可以配置 TronGrid 和 ZAN 节点

## 成功标志

✅ 钱包列表正常显示  
✅ 钱包状态标签显示（健康/警告/错误）  
✅ 余额信息显示正常  
✅ 点击钱包能查看详情  
✅ 详情页所有信息完整  
✅ 启用/禁用按钮工作正常  
✅ API配置界面可以访问  
