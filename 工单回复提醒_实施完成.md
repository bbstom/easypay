# 工单回复提醒功能实施完成

## 完成时间
2026-01-30

## 功能概述
当管理员回复用户的工单后，用户侧边栏的"我的工单"菜单项会显示红色徽章，提醒用户有新的回复。

## 实现内容

### 1. 后端 API - 获取未读工单数量 ✅

**新增路由：** `GET /api/tickets/my/unread-count`

**功能：**
- 统计有管理员回复的工单数量
- 只统计状态为 `in_progress` 或 `waiting_user` 的工单
- 筛选出包含管理员回复的工单

**实现代码：**
```javascript
router.get('/my/unread-count', auth, async (req, res) => {
  try {
    // 获取处理中或等待用户回复的工单
    const tickets = await Ticket.find({
      userId: req.user.userId,
      status: { $in: ['in_progress', 'waiting_user'] }
    }).populate('replies.userId', 'username');
    
    // 筛选出有管理员回复的工单
    const ticketsWithAdminReply = tickets.filter(ticket => 
      ticket.replies && ticket.replies.some(reply => reply.isAdmin)
    );
    
    res.json({
      success: true,
      count: ticketsWithAdminReply.length
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

**返回数据：**
```json
{
  "success": true,
  "count": 3
}
```

### 2. 前端实现 - 用户侧边栏徽章 ✅

**组件：** `src/components/UserLayout.jsx`

**功能：**
- 实时显示有新回复的工单数量
- 红色徽章，醒目提示
- 侧边栏展开时：徽章显示在右侧
- 侧边栏收起时：徽章显示在图标右上角
- 每30秒自动刷新一次

**实现代码：**
```javascript
const [unreadTicketsCount, setUnreadTicketsCount] = useState(0);

useEffect(() => {
  if (user) {
    fetchUnreadTicketsCount();
    const interval = setInterval(fetchUnreadTicketsCount, 30000);
    return () => clearInterval(interval);
  }
}, [user]);

const fetchUnreadTicketsCount = async () => {
  try {
    const { data } = await axios.get('/api/tickets/my/unread-count');
    setUnreadTicketsCount(data.count || 0);
  } catch (error) {
    console.error('获取未读工单数量失败:', error);
  }
};
```

**徽章渲染：**
```jsx
{item.path === '/my-tickets' && unreadTicketsCount > 0 && (
  <span className={`${sidebarOpen ? 'ml-auto' : 'absolute -top-0.5 -right-0.5'} 
    flex items-center justify-center min-w-[18px] h-[18px] px-1 
    bg-red-500 text-white text-[10px] font-bold rounded-full`}>
    {unreadTicketsCount}
  </span>
)}
```

## 统计逻辑

### 什么情况下显示徽章？

**显示条件（同时满足）：**
1. 工单状态为 `in_progress`（处理中）或 `waiting_user`（等待用户回复）
2. 工单包含至少一条管理员回复（`reply.isAdmin === true`）

**不显示的情况：**
- 工单状态为 `open`（待处理）- 还没有回复
- 工单状态为 `resolved`（已解决）- 已处理完成
- 工单状态为 `closed`（已关闭）- 已关闭
- 工单没有任何回复
- 工单只有用户自己的回复

### 工单状态流转

```
用户创建工单
    ↓
[open] 待处理 (无徽章)
    ↓
管理员回复
    ↓
[in_progress] 处理中 (显示徽章 🔴)
    ↓
用户查看并回复
    ↓
[in_progress] 处理中 (继续显示徽章 🔴)
    ↓
管理员标记为"等待用户回复"
    ↓
[waiting_user] 等待回复 (显示徽章 🔴)
    ↓
管理员标记为"已解决"
    ↓
[resolved] 已解决 (无徽章)
```

## 视觉设计

### 徽章样式
- **颜色：** 红色 (`bg-red-500`)
- **大小：** 18x18px（最小宽度）
- **字体：** 10px，加粗
- **形状：** 圆形 (`rounded-full`)
- **位置：** 
  - 展开状态：菜单项右侧 (`ml-auto`)
  - 收起状态：图标右上角 (`absolute -top-0.5 -right-0.5`)

### 响应式布局
```jsx
// 侧边栏展开
┌─────────────────────────┐
│ 🎫 我的工单          [3]│
└─────────────────────────┘

// 侧边栏收起
┌────┐
│ 🎫 │
│ [3]│
└────┘
```

## 用户体验

### 1. 实时提醒
- ✅ 管理员回复后，用户侧边栏立即显示徽章（最多30秒延迟）
- ✅ 红色徽章醒目，不会错过
- ✅ 显示具体数量，一目了然

### 2. 自动刷新
- ✅ 每30秒自动检查一次
- ✅ 无需手动刷新页面
- ✅ 后台静默更新，不影响用户操作

### 3. 状态同步
- ✅ 用户查看工单后，徽章继续显示（因为状态仍是 `in_progress`）
- ✅ 只有管理员标记为"已解决"或"已关闭"后，徽章才消失
- ✅ 避免误导用户以为已处理完成

## 技术细节

### 1. 性能优化
- 使用轻量级 API，只返回数量，不返回完整工单数据
- 数据库查询使用索引（`userId` 和 `status`）
- 前端使用 `useState` 缓存数据，减少重复请求

### 2. 错误处理
```javascript
try {
  const { data } = await axios.get('/api/tickets/my/unread-count');
  setUnreadTicketsCount(data.count || 0);
} catch (error) {
  console.error('获取未读工单数量失败:', error);
  // 静默失败，不影响用户使用
}
```

### 3. 内存管理
```javascript
useEffect(() => {
  if (user) {
    fetchUnreadTicketsCount();
    const interval = setInterval(fetchUnreadTicketsCount, 30000);
    return () => clearInterval(interval); // 清理定时器
  }
}, [user]);
```

## 对比：管理员 vs 用户

| 功能 | 管理员 | 用户 |
|------|--------|------|
| 徽章位置 | 工单管理菜单 | 我的工单菜单 |
| 统计内容 | 待处理工单（open） | 有管理员回复的工单 |
| 刷新频率 | 30秒 | 30秒 |
| 徽章颜色 | 红色 | 红色 |
| API 路由 | `/api/tickets/admin?status=open` | `/api/tickets/my/unread-count` |

## 测试场景

### 场景 1：管理员首次回复
1. 用户创建工单（状态：open）
2. 用户侧边栏：无徽章 ✓
3. 管理员回复工单（状态：in_progress）
4. 等待最多30秒
5. 用户侧边栏：显示徽章 [1] ✓

### 场景 2：用户查看并回复
1. 用户点击"我的工单"
2. 查看工单详情和管理员回复
3. 用户回复工单
4. 用户侧边栏：徽章仍然显示 [1] ✓
5. 原因：状态仍是 in_progress，表示工单还在处理中

### 场景 3：管理员标记已解决
1. 管理员将工单状态改为"已解决"
2. 等待最多30秒
3. 用户侧边栏：徽章消失 ✓

### 场景 4：多个工单
1. 用户有3个工单
2. 其中2个有管理员回复（in_progress）
3. 1个还在待处理（open）
4. 用户侧边栏：显示徽章 [2] ✓

### 场景 5：侧边栏折叠
1. 用户折叠侧边栏
2. 徽章显示在图标右上角 ✓
3. 展开侧边栏
4. 徽章显示在菜单项右侧 ✓

## 后续优化建议

### 1. 实时推送（WebSocket）
- 使用 Socket.io 实现实时推送
- 管理员回复后立即通知用户
- 无需等待30秒轮询

### 2. 浏览器通知
- 使用 Notification API
- 即使不在页面也能收到提醒
- 需要用户授权

### 3. 声音提醒
- 新回复到达时播放提示音
- 可在设置中开启/关闭

### 4. 标记已读功能
- 添加"标记为已读"按钮
- 用户确认查看后，徽章消失
- 需要在数据库中记录已读状态

### 5. 邮件通知
- 管理员回复后发送邮件
- 邮件包含回复内容和链接
- 已在系统中实现（如果配置了邮件服务）

## 修改文件

### 后端
- `server/routes/tickets.js`
  - 新增 `GET /api/tickets/my/unread-count` 路由

### 前端
- `src/components/UserLayout.jsx`
  - 添加 `unreadTicketsCount` 状态
  - 添加 `fetchUnreadTicketsCount()` 函数
  - 添加徽章渲染逻辑
  - 添加自动刷新定时器

## 完成状态
✅ 后端 API 已实现
✅ 前端徽章已实现
✅ 自动刷新已实现
✅ 响应式布局已实现
✅ 错误处理已实现
✅ 内存管理已实现
✅ 所有代码无语法错误
