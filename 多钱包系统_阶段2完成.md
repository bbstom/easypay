# 多钱包系统 - 阶段 2 完成报告

## ✅ 完成状态

**阶段 2: 智能调度系统** - 已完成

## 实施内容

### 1. WalletSelector 服务 ✅
**文件**: `server/services/walletSelector.js`

#### 核心功能
- ✅ 智能选择最优钱包
- ✅ 多因素评分算法
- ✅ 钱包资格过滤
- ✅ 钱包推荐列表

#### 评分算法（总分 100 分）

**1. 优先级得分（40分）**
- 基于钱包的 priority 字段（0-100）
- 直接映射到 0-40 分
- 管理员可以手动设置优先级

**2. 余额充足度得分（30分）**
- 计算公式：`(余额 / (需求金额 × 10)) × 30`
- 余额是需求的 10 倍时得满分
- 确保钱包有足够的缓冲余额

**3. 负载均衡得分（20分）**
- 基于最后使用时间
- 计算公式：`(小时数 / 24) × 20`
- 24 小时未使用得满分
- 避免单个钱包过度使用

**4. 健康状态得分（10分）**
- healthy: 10 分
- warning: 5 分
- error: 0 分（会被过滤掉）

#### 过滤条件
钱包必须同时满足以下条件才能被选中：
- ✅ `enabled = true`（已启用）
- ✅ `health.status != 'error'`（健康状态正常）
- ✅ TRX 余额 >= 预估手续费
- ✅ USDT 余额 >= 转账金额（USDT 转账时）
- ✅ TRX 余额 >= 转账金额 + 手续费（TRX 转账时）

### 2. TronService 扩展 ✅
**文件**: `server/services/tronService.js`

#### 新增方法

**sendUSDTWithWallet(wallet, toAddress, amount)**
- 使用指定钱包发送 USDT
- 自动解密钱包私钥
- 创建临时 TronWeb 实例
- 支持能量租赁
- 自动更新钱包统计

**sendTRXWithWallet(wallet, toAddress, amount)**
- 使用指定钱包发送 TRX
- 自动解密钱包私钥
- 创建临时 TronWeb 实例
- 自动更新钱包统计

**updateWalletStats(walletId, success)**
- 更新钱包交易统计
- 记录成功/失败次数
- 更新最后使用时间

#### 特性
- ✅ 支持多钱包切换
- ✅ 每个钱包独立的 TronWeb 实例
- ✅ 自动统计更新
- ✅ 完整的错误处理
- ✅ 详细的日志输出

### 3. 测试脚本 ✅
**文件**: `server/scripts/testWalletSelector.js`

#### 测试场景
1. **小额 USDT 转账**（10 USDT）
2. **大额 USDT 转账**（1000 USDT）
3. **TRX 转账**（50 TRX）

#### 测试内容
- ✅ 钱包选择测试
- ✅ 推荐列表生成
- ✅ 钱包状态展示
- ✅ 评分算法验证

## 技术细节

### 钱包选择流程

```
1. 获取所有启用的钱包
   ↓
2. 过滤符合条件的钱包
   - 健康状态检查
   - 余额检查
   ↓
3. 计算每个钱包的得分
   - 优先级（40%）
   - 余额充足度（30%）
   - 负载均衡（20%）
   - 健康状态（10%）
   ↓
4. 按得分排序
   ↓
5. 选择得分最高的钱包
```

### 评分示例

假设有以下钱包：

**钱包 A**:
- 优先级: 80 → 32 分
- 余额: 100 USDT（需求 10 USDT）→ 30 分
- 最后使用: 12 小时前 → 10 分
- 健康: healthy → 10 分
- **总分: 82 分**

**钱包 B**:
- 优先级: 50 → 20 分
- 余额: 500 USDT（需求 10 USDT）→ 30 分
- 最后使用: 1 小时前 → 0.83 分
- 健康: healthy → 10 分
- **总分: 60.83 分**

**结果**: 选择钱包 A（得分更高）

### 使用示例

```javascript
// 1. 选择最优钱包
const wallet = await walletSelector.selectBestWallet({
  amount: 10,
  type: 'USDT',
  estimatedFee: 15
});

// 2. 使用选中的钱包进行转账
const result = await tronService.sendUSDTWithWallet(
  wallet,
  'TReceiver...',
  10
);

// 3. 钱包统计自动更新
// - totalTransactions +1
// - successfulTransactions +1 (如果成功)
// - lastUsed = 当前时间
```

## 优势

### 1. 智能负载均衡
- 自动分散交易到多个钱包
- 避免单个钱包过度使用
- 降低被限流的风险

### 2. 高可用性
- 单个钱包故障不影响系统
- 自动选择健康的钱包
- 余额不足时自动切换

### 3. 灵活配置
- 管理员可设置钱包优先级
- 支持动态启用/禁用钱包
- 评分算法可调整权重

### 4. 透明可追溯
- 详细的选择日志
- 完整的交易统计
- 钱包使用情况一目了然

## 测试方法

### 1. 测试钱包选择器
```bash
node server/scripts/testWalletSelector.js
```

**预期输出**:
- 显示各场景下选中的钱包
- 显示所有钱包的推荐列表和得分
- 显示当前所有钱包的状态

### 2. 测试多钱包转账
```javascript
// 在实际转账代码中
const walletSelector = require('./services/walletSelector');
const tronService = require('./services/tronService');

// 选择钱包
const wallet = await walletSelector.selectBestWallet({
  amount: 10,
  type: 'USDT',
  estimatedFee: 15
});

// 执行转账
const result = await tronService.sendUSDTWithWallet(
  wallet,
  toAddress,
  amount
);
```

## 下一步计划

### 阶段 3: API 接口
- [ ] 钱包管理 API（增删改查）
- [ ] 钱包状态 API
- [ ] 钱包统计 API
- [ ] 钱包选择 API（用于调试）

### 阶段 4-5: 前端界面
- [ ] 钱包列表页面
- [ ] 钱包添加/编辑表单
- [ ] 实时状态监控
- [ ] 统计图表

### 阶段 6-7: 测试和优化
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能优化
- [ ] 文档完善

## 文件清单

### 新增文件
1. `server/services/walletSelector.js` - 钱包选择器服务
2. `server/scripts/testWalletSelector.js` - 测试脚本

### 修改文件
1. `server/services/tronService.js` - 添加多钱包支持方法

## 注意事项

### 1. 私钥安全
- 私钥在使用时才解密
- 使用临时 TronWeb 实例
- 不在内存中长期保存明文私钥

### 2. 并发控制
- 当前实现不支持并发转账
- 如需并发，需要添加锁机制
- 避免同一钱包同时发起多笔交易

### 3. 余额同步
- 钱包余额需要定期刷新
- 建议每次转账前刷新余额
- 或使用定时任务自动刷新

### 4. 评分权重调整
- 当前权重：优先级 40%、余额 30%、负载 20%、健康 10%
- 可根据实际使用情况调整
- 修改 `walletSelector.js` 中的 `calculateScore` 方法

## 总结

阶段 2 已完成，智能调度系统已经建立。系统现在可以：

✅ 根据多个因素智能选择最优钱包
✅ 自动负载均衡，避免单点过载
✅ 支持多钱包并行使用
✅ 自动统计和追踪钱包使用情况
✅ 提供详细的选择日志和推荐列表

下一步将实施阶段 3：API 接口，为前端提供钱包管理功能。
