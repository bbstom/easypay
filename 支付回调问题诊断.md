# 支付回调问题诊断与修复

## 问题描述
使用微信付款后，网站不能检查到支付状态，无法进行下一步代付流程。

## 问题原因

### 1. 回调URL配置问题
支付平台需要回调到你的服务器，但可能存在以下问题：

- **环境变量未配置**: `APP_URL` 环境变量未设置或设置为 `localhost`
- **内网地址**: 服务器在内网，支付平台无法访问
- **端口未开放**: 服务器端口未对外开放
- **回调URL错误**: 后台配置的回调URL不正确

### 2. 签名验证失败
- MD5密钥配置错误（V1接口）
- RSA密钥配置错误（V2接口）
- 支付平台回调参数格式不匹配

## 诊断步骤

### 步骤1: 检查环境变量

查看 `.env` 文件，确认以下配置：

```env
# 应用URL（必须是公网可访问的地址）
APP_URL=https://your-domain.com

# 或者如果使用IP
APP_URL=http://your-public-ip:5000
```

**注意**: 
- 不能使用 `localhost` 或 `127.0.0.1`
- 必须是支付平台能访问到的公网地址
- 如果使用HTTPS，确保证书有效

### 步骤2: 检查后台配置

登录管理后台 → 系统设置 → 支付配置，检查：

1. **回调地址** 应该是：
   ```
   https://your-domain.com/api/payments/notify
   ```

2. **API版本** 选择正确（V1或V2）

3. **密钥配置**：
   - V1: MD5密钥
   - V2: 商户私钥 + 平台公钥

### 步骤3: 测试回调接口

使用以下命令测试回调接口是否可访问：

```bash
# 从外网测试（替换为你的域名）
curl -X POST https://your-domain.com/api/payments/notify \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "test=1"
```

如果返回 "FAIL" 或其他响应，说明接口可访问。

### 步骤4: 查看服务器日志

支付回调会在服务器日志中输出详细信息：

```bash
# 查看Node.js服务器日志
# 应该能看到类似以下的日志：
# 收到支付回调: { ... }
# 使用API版本: v1
# 订单号: ORD... 状态: TRADE_SUCCESS
```

如果没有看到这些日志，说明支付平台没有成功回调。

## 解决方案

### 方案1: 配置公网访问（推荐）

#### 1.1 使用域名
```env
APP_URL=https://your-domain.com
```

#### 1.2 使用公网IP
```env
APP_URL=http://your-public-ip:5000
```

#### 1.3 使用内网穿透（开发测试）
如果是本地开发，可以使用内网穿透工具：

**使用 ngrok**:
```bash
ngrok http 5000
```

然后将生成的URL配置到 `.env`:
```env
APP_URL=https://xxxx.ngrok.io
```

**使用 frp**:
配置frp客户端，将本地5000端口映射到公网。

### 方案2: 修改回调URL配置

如果环境变量不方便修改，可以直接在后台配置回调URL：

1. 登录管理后台
2. 系统设置 → 支付配置
3. 回调地址填写：`https://your-domain.com/api/payments/notify`
4. 保存设置

### 方案3: 临时禁用签名验证（仅用于调试）

**警告**: 仅用于调试，生产环境必须启用签名验证！

修改 `server/routes/payments.js` 的回调接口：

```javascript
// 支付回调接口
router.post('/notify', async (req, res) => {
  try {
    const settings = await Settings.findOne();
    
    console.log('收到支付回调:', req.body);
    console.log('使用API版本:', settings.paymentApiVersion);
    
    // 临时注释签名验证（仅用于调试）
    // if (!paymentService.verifySign(req.body, settings)) {
    //   console.error('签名验证失败');
    //   return res.status(400).send('FAIL');
    // }
    
    // ... 其余代码
  }
});
```

### 方案4: 手动触发代付

如果回调确实无法配置，可以使用手动触发：

1. 登录管理后台
2. 财务管理 → 找到已支付的订单
3. 点击"重试转账"按钮

## 验证修复

### 1. 创建测试订单
1. 访问代付工作台
2. 填写信息并提交
3. 使用微信支付

### 2. 查看日志
支付成功后，应该能在服务器日志中看到：

```
收到支付回调: { out_trade_no: 'ORD...', trade_status: 'TRADE_SUCCESS', ... }
使用API版本: v1
订单号: ORD... 状态: TRADE_SUCCESS
✅ 支付成功，订单: ...
🔄 开始执行 USDT 代付: ...
✅ USDT 代付成功: ORD..., txHash: ...
```

### 3. 检查订单状态
在财务管理中查看订单：
- 支付状态: 已支付
- 转账状态: 已完成
- 交易哈希: 显示TRON交易ID

## 常见问题

### Q1: 回调URL必须是HTTPS吗？
A: 不一定，但建议使用HTTPS。某些支付平台可能要求HTTPS。

### Q2: 本地开发如何测试回调？
A: 使用内网穿透工具（ngrok、frp等）将本地服务暴露到公网。

### Q3: 签名验证总是失败怎么办？
A: 
1. 检查API版本是否选择正确
2. 检查密钥是否配置正确
3. 查看支付平台文档，确认签名算法
4. 联系支付平台技术支持

### Q4: 支付成功但没有代付怎么办？
A: 
1. 检查钱包余额是否充足
2. 检查钱包私钥是否配置正确
3. 查看服务器日志中的错误信息
4. 使用"重试转账"功能

### Q5: 如何确认支付平台是否回调成功？
A: 
1. 查看服务器日志
2. 联系支付平台查看回调记录
3. 使用支付平台提供的测试工具

## 推荐配置

### 生产环境
```env
# .env
APP_URL=https://your-domain.com
NODE_ENV=production
```

后台配置：
- 回调地址: `https://your-domain.com/api/payments/notify`
- 启用签名验证
- 配置正确的密钥

### 开发环境
```env
# .env
APP_URL=https://xxxx.ngrok.io  # 使用ngrok
NODE_ENV=development
```

## 技术支持

如果以上方案都无法解决问题，请提供以下信息：

1. 服务器日志（支付时的完整日志）
2. 支付平台名称和API版本
3. 回调URL配置
4. 是否能从外网访问回调接口
5. 支付平台的回调记录（如果有）

---

**最后更新**: 2026年2月1日
