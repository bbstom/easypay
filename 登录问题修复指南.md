# ç™»å½•é—®é¢˜ä¿®å¤æŒ‡å—

## é—®é¢˜è¯Šæ–­

åç«¯è¿è¡ŒæˆåŠŸï¼ˆç«¯å£ 5000ï¼‰ï¼Œä½†ç”¨æˆ·æ— æ³•ç™»å½•ï¼Œæç¤º"æ“ä½œå¤±è´¥"ã€‚

**æ ¹æœ¬åŸå› **ï¼šNginx é…ç½®ç¼ºå°‘ API åå‘ä»£ç†ï¼Œå‰ç«¯çš„ `/api/*` è¯·æ±‚æ— æ³•åˆ°è¾¾åç«¯ã€‚

---

## ä¿®å¤æ­¥éª¤

### 1. ä¿®æ”¹ Nginx é…ç½®

åœ¨å®å¡”é¢æ¿ä¸­ï¼š

1. è¿›å…¥ **ç½‘ç«™** â†’ æ‰¾åˆ° `kk.vpno.eu.org` â†’ ç‚¹å‡» **è®¾ç½®**
2. ç‚¹å‡» **é…ç½®æ–‡ä»¶** æ ‡ç­¾
3. åœ¨ `server { ... }` å—ä¸­ï¼Œæ‰¾åˆ°è¿™ä¸€è¡Œï¼š
   ```nginx
   root /www/wwwroot/kk.vpno.eu.org/easypay/dist;
   ```

4. åœ¨ `#REWRITE-END` æ³¨é‡Š**ä¹‹å**ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```nginx
# API åå‘ä»£ç†é…ç½® - è½¬å‘åˆ°åç«¯
location /api/ {
    proxy_pass http://127.0.0.1:5000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # è¶…æ—¶è®¾ç½®
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# å‰ç«¯é™æ€æ–‡ä»¶ - æ”¯æŒ SPA è·¯ç”±
location / {
    try_files $uri $uri/ /index.html;
}
```

5. ç‚¹å‡» **ä¿å­˜**
6. é‡è½½ Nginx é…ç½®ï¼ˆå®å¡”ä¼šè‡ªåŠ¨æç¤ºï¼‰

---

### 2. é‡å¯åç«¯æœåŠ¡

```bash
cd /www/wwwroot/kk.vpno.eu.org/easypay
pm2 restart easypay-backend
pm2 logs easypay-backend --lines 20
```

ç¡®è®¤çœ‹åˆ°ï¼š
```
âœ… MongoDB è¿æ¥æˆåŠŸ
ğŸš€ æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ 5000
```

---

### 3. æµ‹è¯• API è¿æ¥

#### æµ‹è¯• 1ï¼šæœ¬åœ°è®¿é—®åç«¯
```bash
curl http://localhost:5000/api/settings/public
```

åº”è¯¥è¿”å› JSON æ•°æ®ï¼ˆç½‘ç«™è®¾ç½®ï¼‰ã€‚

#### æµ‹è¯• 2ï¼šé€šè¿‡ Nginx è®¿é—®
```bash
curl https://kk.vpno.eu.org/api/settings/public
```

åº”è¯¥è¿”å›ç›¸åŒçš„ JSON æ•°æ®ã€‚

#### æµ‹è¯• 3ï¼šæµ‹è¯•ç™»å½•æ¥å£
```bash
curl -X POST https://kk.vpno.eu.org/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"kailsay@gmail.com","password":"specter1234"}'
```

åº”è¯¥è¿”å›åŒ…å« token çš„ JSONã€‚

---

### 4. æµè§ˆå™¨æµ‹è¯•

1. æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® `https://kk.vpno.eu.org`
2. æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
3. åˆ‡æ¢åˆ° **Networkï¼ˆç½‘ç»œï¼‰** æ ‡ç­¾
4. å°è¯•ç™»å½•ï¼š
   - é‚®ç®±ï¼š`kailsay@gmail.com`
   - å¯†ç ï¼š`specter1234`

5. æŸ¥çœ‹ Network ä¸­çš„ `login` è¯·æ±‚ï¼š
   - **Status** åº”è¯¥æ˜¯ `200`
   - **Response** åº”è¯¥åŒ…å« `token` å’Œ `user` ä¿¡æ¯

---

## å®Œæ•´çš„ Nginx é…ç½®ç¤ºä¾‹

```nginx
server {
    listen 80;
    listen 443 ssl;
    listen 443 quic;
    http2 on;
    server_name kk.vpno.eu.org;
    index index.html;
    root /www/wwwroot/kk.vpno.eu.org/easypay/dist;

    # SSL é…ç½®
    ssl_certificate /www/server/panel/vhost/cert/kk.vpno.eu.org/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/kk.vpno.eu.org/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # API åå‘ä»£ç† - å…³é”®é…ç½®ï¼
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # å‰ç«¯é™æ€æ–‡ä»¶ - æ”¯æŒ SPA è·¯ç”±
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # ç¦æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶
    location ~* (\.env|\.git|node_modules) {
        return 404;
    }
    
    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

---

## å¸¸è§é—®é¢˜

### Q1: æ·»åŠ é…ç½®åè¿˜æ˜¯æ— æ³•ç™»å½•ï¼Ÿ

**æ£€æŸ¥æ­¥éª¤**ï¼š
1. ç¡®è®¤ Nginx é…ç½®å·²ä¿å­˜å¹¶é‡è½½
2. æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—ï¼š
   ```bash
   tail -f /www/wwwlogs/kk.vpno.eu.org.error.log
   ```
3. ç¡®è®¤åç«¯æ­£åœ¨è¿è¡Œï¼š
   ```bash
   pm2 status
   ```

### Q2: 502 Bad Gateway é”™è¯¯ï¼Ÿ

**åŸå› **ï¼šåç«¯æœªè¿è¡Œæˆ–ç«¯å£ä¸å¯¹ã€‚

**è§£å†³**ï¼š
```bash
pm2 restart easypay-backend
pm2 logs easypay-backend
```

### Q3: CORS é”™è¯¯ï¼Ÿ

**åŸå› **ï¼š.env ä¸­çš„ FRONTEND_URL é…ç½®é”™è¯¯ã€‚

**è§£å†³**ï¼š
ç¡®è®¤ `.env` ä¸­æœ‰ï¼š
```env
FRONTEND_URL=https://kk.vpno.eu.org
```

ç„¶åé‡å¯åç«¯ï¼š
```bash
pm2 restart easypay-backend
```

---

## éªŒè¯æ¸…å•

- [ ] Nginx é…ç½®å·²æ·»åŠ  `/api/` åå‘ä»£ç†
- [ ] Nginx é…ç½®å·²ä¿å­˜å¹¶é‡è½½
- [ ] åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œï¼ˆpm2 statusï¼‰
- [ ] .env ä¸­ APP_URL å’Œ FRONTEND_URL éƒ½æ˜¯ `https://kk.vpno.eu.org`
- [ ] æœ¬åœ° curl æµ‹è¯•é€šè¿‡
- [ ] é€šè¿‡åŸŸå curl æµ‹è¯•é€šè¿‡
- [ ] æµè§ˆå™¨å¯ä»¥æˆåŠŸç™»å½•

---

## å¿«é€Ÿä¿®å¤å‘½ä»¤

```bash
# 1. é‡å¯åç«¯
cd /www/wwwroot/kk.vpno.eu.org/easypay
pm2 restart easypay-backend

# 2. æµ‹è¯• API
curl https://kk.vpno.eu.org/api/settings/public

# 3. æŸ¥çœ‹æ—¥å¿—
pm2 logs easypay-backend --lines 30
```

---

## ä¿®å¤å®Œæˆæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œè¯´æ˜ä¿®å¤æˆåŠŸï¼š

1. âœ… æµè§ˆå™¨å¯ä»¥æ­£å¸¸ç™»å½•
2. âœ… Network ä¸­ `/api/auth/login` è¿”å› 200
3. âœ… ç™»å½•åå¯ä»¥çœ‹åˆ°"ç®¡ç†åå°"æŒ‰é’®ï¼ˆç®¡ç†å‘˜è´¦å·ï¼‰
4. âœ… å¯ä»¥è®¿é—®ä¸ªäººä¸­å¿ƒå’Œè®¢å•è®°å½•

---

**æœ€åæé†’**ï¼šä¿®æ”¹ Nginx é…ç½®åï¼Œä¸€å®šè¦ç‚¹å‡»"ä¿å­˜"å¹¶é‡è½½é…ç½®ï¼
