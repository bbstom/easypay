# 阶梯费率功能说明

## 功能概述

阶梯费率功能允许根据用户代付的 USDT 数量，自动应用不同的费率规则。支持固定费用和百分比费率混合使用，灵活配置不同金额区间的收费标准。

## 主要特性

### 1. 灵活的费率类型
- **固定费用**：无论金额多少，收取固定的人民币费用
- **百分比费率**：按照订单金额的百分比收取费用

### 2. 多档位配置
- 支持配置多个金额区间
- 每个区间可以独立设置费率类型和费率值
- 自动匹配用户订单金额到对应的费率规则

### 3. 向下兼容
- 可以随时开启或关闭阶梯费率
- 关闭后自动使用传统的统一费率模式
- 不影响已有订单数据

## 配置方法

### 1. 进入设置页面
管理后台 → 设置 → 费率设置

### 2. 启用阶梯费率
打开"阶梯费率"开关

### 3. 配置费率规则

#### 规则示例 1：小额固定，大额百分比
```
规则 1: 0-100 USDT
  - 费率类型: 固定费用
  - 费用金额: 5 CNY
  - 说明: 小额订单收取固定 5 元

规则 2: 100-500 USDT
  - 费率类型: 固定费用
  - 费用金额: 3 CNY
  - 说明: 中等金额优惠，只收 3 元

规则 3: 500-999999 USDT
  - 费率类型: 百分比费率
  - 费率百分比: 0.5%
  - 说明: 大额订单按 0.5% 收取
```

#### 规则示例 2：全部百分比，阶梯递减
```
规则 1: 0-100 USDT
  - 费率类型: 百分比费率
  - 费率百分比: 2%

规则 2: 100-500 USDT
  - 费率类型: 百分比费率
  - 费率百分比: 1.5%

规则 3: 500-1000 USDT
  - 费率类型: 百分比费率
  - 费率百分比: 1%

规则 4: 1000-999999 USDT
  - 费率类型: 百分比费率
  - 费率百分比: 0.5%
```

### 4. 规则配置说明

#### 最小金额 (minAmount)
- 该规则适用的最小 USDT 数量（包含）
- 第一个规则通常从 0 开始

#### 最大金额 (maxAmount)
- 该规则适用的最大 USDT 数量（不包含）
- 最后一个规则建议设为 999999（表示无上限）

#### 费率类型 (feeType)
- **固定费用 (fixed)**：收取固定的人民币金额
- **百分比费率 (percentage)**：按订单金额的百分比收取

#### 费率值 (feeValue)
- 固定费用：直接填写人民币金额，如 5 表示 5 元
- 百分比费率：填写百分比数值，如 1 表示 1%，0.5 表示 0.5%

#### 规则描述 (description)
- 可选的规则说明，方便管理和识别

## 计算逻辑

### 匹配规则
系统会根据用户输入的 USDT 数量，查找第一个满足条件的规则：
```
minAmount <= 用户金额 < maxAmount
```

### 费用计算

#### 固定费用
```
服务费 = feeValue (CNY)
```

#### 百分比费率
```
订单金额(CNY) = USDT数量 × USDT汇率
服务费 = 订单金额 × (feeValue / 100)
```

### 示例计算

假设配置如下：
- 规则 1: 0-100 USDT, 固定费用 5 CNY
- 规则 2: 100-500 USDT, 固定费用 3 CNY
- 规则 3: 500+ USDT, 百分比 0.5%

用户代付场景：

**场景 1：代付 50 USDT**
- 匹配规则 1 (0-100)
- 服务费 = 5 CNY

**场景 2：代付 200 USDT**
- 匹配规则 2 (100-500)
- 服务费 = 3 CNY

**场景 3：代付 1000 USDT**
- 匹配规则 3 (500+)
- USDT 汇率假设为 7.35 CNY
- 订单金额 = 1000 × 7.35 = 7350 CNY
- 服务费 = 7350 × 0.5% = 36.75 CNY

## 使用建议

### 1. 规则设计原则
- **从小到大排列**：按金额从小到大设置规则
- **无缝衔接**：确保规则之间没有遗漏的金额区间
- **合理定价**：小额订单可以固定费用，大额订单用百分比更灵活

### 2. 常见配置方案

#### 方案 A：鼓励大额交易
```
0-100:    固定 5 元
100-500:  固定 3 元
500+:     0.5%
```
优点：大额订单费率更低，鼓励用户增加交易金额

#### 方案 B：统一百分比
```
0-100:    2%
100-500:  1.5%
500-1000: 1%
1000+:    0.5%
```
优点：费率与金额成正比，公平透明

#### 方案 C：保底收费
```
0-50:     固定 5 元
50-200:   1.5%
200+:     1%
```
优点：小额订单有保底收入，大额订单按比例收取

### 3. 测试建议
- 配置完成后，在前端测试不同金额的费用计算
- 确认每个金额区间都能正确匹配规则
- 检查边界值（如 100、500）的计算是否正确

## 技术实现

### 数据库字段
```javascript
tieredFeeEnabled: Boolean  // 是否启用阶梯费率
tieredFeeRules: String     // JSON 格式的规则数组
```

### 规则数据结构
```javascript
[
  {
    minAmount: 0,           // 最小金额
    maxAmount: 100,         // 最大金额
    feeType: 'fixed',       // 费率类型
    feeValue: 5,            // 费率值
    description: '0-100'    // 规则描述
  },
  // ... 更多规则
]
```

### 前端计算
前端会实时计算并显示服务费，用户输入金额后立即看到费用

### 后端验证
后端创建订单时会重新计算服务费，确保数据准确性

## 常见问题

### Q1: 如果用户金额不匹配任何规则怎么办？
A: 系统会自动使用传统的统一费率作为备用方案

### Q2: 可以随时修改规则吗？
A: 可以，修改后立即生效，不影响已创建的订单

### Q3: 关闭阶梯费率后会怎样？
A: 系统会恢复使用传统的统一费率模式

### Q4: 规则的顺序重要吗？
A: 系统会自动查找第一个匹配的规则，建议按金额从小到大排列

### Q5: 百分比费率的基数是什么？
A: 基数是订单的人民币金额（USDT数量 × 汇率）

## 部署说明

### 1. 更新代码
```bash
# 拉取最新代码
git pull

# 安装依赖（如有新增）
npm install
```

### 2. 重新编译前端
```bash
npm run build
```

### 3. 重启后端服务
```bash
pm2 restart easypay
```

### 4. 验证功能
- 登录管理后台
- 进入"设置 → 费率设置"
- 启用阶梯费率并配置规则
- 保存设置
- 前端测试不同金额的费用计算

## 更新日志

**2026-02-04**
- ✅ 新增阶梯费率功能
- ✅ 支持固定费用和百分比费率混合配置
- ✅ 前端实时计算服务费
- ✅ 后端订单创建时验证费率
- ✅ 向下兼容传统费率模式

---

如有问题，请查看服务器日志：
```bash
pm2 logs easypay --lines 100
```
