# 多钱包代付系统修复完成

## 问题诊断

你说得完全正确！系统确实存在问题：

**问题根源：**
代付系统还在使用旧的单钱包配置（从 Settings 读取私钥），而没有使用你在前端配置的多钱包系统。

**具体表现：**
1. 查询钱包状态时，使用的是旧地址：`TP4Cr7xRZ7jGZ5XmKt2aN7NP6yFGG99999`（余额不足）
2. 而你已经配置了新钱包：`TTY9B985W7DMuLyUP7oqoncamBJ3DkuTRX`（余额充足）
3. 代付时没有使用新钱包，导致失败

## 已完成的修复

### 1. 修改代付逻辑（`server/routes/payments.js`）

**修改前：**
```javascript
// 直接使用 tronService.sendUSDT()
// 这会使用 Settings 中的旧钱包
txResult = await tronService.sendUSDT(payment.address, payment.amount);
```

**修改后：**
```javascript
// 1. 使用钱包选择器选择最优钱包
const selectedWallet = await walletSelector.selectBestWallet({
  amount: payment.amount,
  type: payment.payType,
  estimatedFee: 15
});

// 2. 使用选中的钱包执行转账
txResult = await tronService.sendUSDTWithWallet(
  selectedWallet, 
  payment.address, 
  payment.amount
);

// 3. 记录使用的钱包信息
payment.walletId = selectedWallet._id;
payment.walletName = selectedWallet.name;
```

### 2. 更新 Payment 模型

添加了钱包信息字段：
```javascript
// 使用的钱包信息（多钱包系统）
walletId: { type: mongoose.Schema.Types.ObjectId, ref: 'Wallet' },
walletName: { type: String },
```

### 3. 修复 TronService 方法

**修复了 `sendUSDTWithWallet` 和 `sendTRXWithWallet` 方法：**
- 添加了 TronWeb 初始化检查
- 修复了地址验证逻辑
- 确保使用正确的钱包地址

### 4. 更新诊断脚本

**`checkOrderStatus.js`** 现在支持多钱包系统：
- 使用钱包选择器选择最优钱包
- 显示使用的钱包信息
- 支持 `retry` 参数重试失败订单

### 5. 创建测试脚本

**`testMultiWalletPayment.js`** 用于测试多钱包系统：
- 查看所有配置的钱包
- 刷新钱包余额
- 测试钱包选择逻辑
- 检查系统可用性

## 当前状态

### 已配置的钱包

```
📍 钱包: TRX
   地址: TTY9B985W7DMuLyUP7oqoncamBJ3DkuTRX
   状态: ✅ 启用
   优先级: 50
   健康状态: healthy
   TRX 余额: 318.04 TRX ✅
   USDT 余额: 139.00 USDT ✅
```

### 剩余问题

**能量租赁地址问题：**
- 能量租赁功能还在使用旧的单钱包地址
- 需要修改能量租赁逻辑，使用当前钱包的地址

## 下一步操作

### 方案 1：禁用能量租赁（快速解决）

```bash
# 在管理后台：
# 代付系统 → 能量租赁 → 禁用能量租赁
```

这样系统会直接使用 TRX 支付 gas 费用（约 13-15 TRX/笔）。

### 方案 2：修复能量租赁（推荐）

需要修改 `rentEnergyViaTransfer` 方法，让它接受钱包地址参数，而不是使用 `this.getWalletAddress()`。

## 测试命令

### 1. 查看所有钱包
```bash
node server/scripts/testMultiWalletPayment.js
```

### 2. 重试失败的订单（禁用能量租赁后）
```bash
node server/scripts/checkOrderStatus.js ORD1770025130619CL6KPC2 retry
```

### 3. 创建新订单测试
在前端创建新订单，系统会自动使用多钱包系统。

## 总结

✅ **已修复：**
- 代付逻辑现在使用多钱包系统
- 钱包选择器正常工作
- 订单会记录使用的钱包信息
- 诊断脚本支持多钱包

⚠️ **待修复：**
- 能量租赁功能需要适配多钱包系统

💡 **建议：**
1. 先禁用能量租赁，测试代付功能
2. 确认代付正常后，再修复能量租赁功能
3. 或者直接使用 TRX 支付 gas（钱包有 318 TRX，足够使用）
