# æ•°æ®åº“ç´¢å¼•ä¿®å¤å®Œæˆ

## ğŸ› é—®é¢˜

```
E11000 duplicate key error collection: fastpay.telegramcontents 
index: key_1 dup key: { key: "order_failed" }
```

## ğŸ” åŸå› 

æ•°æ®åº“ç´¢å¼•æŸåæˆ–ä¸ä¸€è‡´ï¼Œå¯¼è‡´æ’å…¥æ•°æ®æ—¶æŠ¥é‡å¤é”®é”™è¯¯ï¼Œä½†å®é™…æ•°æ®åº“ä¸­å¹¶æ²¡æœ‰é‡å¤æ•°æ®ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºæ¸…ç†è„šæœ¬

**æ–‡ä»¶**: `server/scripts/cleanDuplicateContents.js`

ç”¨äºæ£€æŸ¥å’Œæ¸…ç†é‡å¤çš„å†…å®¹è®°å½•ã€‚

### 2. åˆ›å»ºç´¢å¼•é‡å»ºè„šæœ¬

**æ–‡ä»¶**: `server/scripts/rebuildContentIndexes.js`

ç”¨äºé‡å»ºæ•°æ®åº“ç´¢å¼•ã€‚

### 3. æ‰§è¡Œä¿®å¤

```bash
# 1. æ£€æŸ¥é‡å¤æ•°æ®
node server/scripts/cleanDuplicateContents.js

# 2. é‡å»ºç´¢å¼•
node server/scripts/rebuildContentIndexes.js
```

## ğŸ“Š ä¿®å¤ç»“æœ

```
âœ… å·²è¿æ¥åˆ°æ•°æ®åº“
ğŸ“‹ å½“å‰ç´¢å¼•:
  - {"_id":1}: _id_
  - {"key":1}: key_1

ğŸ—‘ï¸  åˆ é™¤æ—§ç´¢å¼•...
  âœ… å·²åˆ é™¤ key_1 ç´¢å¼•

ğŸ”¨ é‡å»ºç´¢å¼•...
  âœ… ç´¢å¼•å·²é‡å»º

ğŸ“‹ æ–°ç´¢å¼•:
  - {"_id":1}: _id_
  - {"key":1}: key_1

ğŸ“Š éªŒè¯æ•°æ®:
  æ€»å…± 5 æ¡å†…å®¹
  å”¯ä¸€ key: 5
  âœ… æ²¡æœ‰é‡å¤çš„ key

âœ… å®Œæˆï¼
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

- âœ… ç´¢å¼•å·²é‡å»º
- âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡
- âœ… æ²¡æœ‰é‡å¤æ•°æ®
- âœ… å¯ä»¥æ­£å¸¸æ’å…¥æ–°å†…å®¹

## ğŸ“ é¢„é˜²æªæ–½

### 1. å®šæœŸæ£€æŸ¥ç´¢å¼•

```bash
node server/scripts/rebuildContentIndexes.js
```

### 2. é¿å…æ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“

ä½¿ç”¨åå°ç®¡ç†ç•Œé¢æˆ– API æ¥ç®¡ç†å†…å®¹ï¼Œé¿å…ç›´æ¥æ“ä½œæ•°æ®åº“ã€‚

### 3. å¤‡ä»½æ•°æ®åº“

å®šæœŸå¤‡ä»½æ•°æ®åº“ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼š

```bash
# MongoDB å¤‡ä»½
mongodump --uri="mongodb://..." --out=/backup/$(date +%Y%m%d)
```

## ğŸ”§ ç›¸å…³è„šæœ¬

### cleanDuplicateContents.js

åŠŸèƒ½ï¼š
- æŸ¥æ‰¾æ‰€æœ‰å†…å®¹
- æŒ‰ key åˆ†ç»„
- è¯†åˆ«é‡å¤è®°å½•
- ä¿ç•™æœ€æ–°è®°å½•ï¼Œåˆ é™¤æ—§è®°å½•

### rebuildContentIndexes.js

åŠŸèƒ½ï¼š
- æ˜¾ç¤ºå½“å‰ç´¢å¼•
- åˆ é™¤æ—§ç´¢å¼•
- é‡å»ºç´¢å¼•
- éªŒè¯æ•°æ®å®Œæ•´æ€§

## ğŸ“š ç›¸å…³æ¨¡å‹

**TelegramContent** (`server/models/TelegramContent.js`)

```javascript
const schema = new mongoose.Schema({
  key: { 
    type: String, 
    required: true, 
    unique: true  // å”¯ä¸€ç´¢å¼•
  },
  // ... å…¶ä»–å­—æ®µ
});
```

`key` å­—æ®µæœ‰å”¯ä¸€ç´¢å¼•ï¼Œç¡®ä¿æ¯ä¸ª key åªèƒ½æœ‰ä¸€æ¡è®°å½•ã€‚

## âœ… ç³»ç»ŸçŠ¶æ€

- âœ… æ•°æ®åº“ç´¢å¼•æ­£å¸¸
- âœ… å†…å®¹ç®¡ç†ç³»ç»Ÿæ­£å¸¸
- âœ… å¯ä»¥æ­£å¸¸åˆ›å»ºå’Œç¼–è¾‘å†…å®¹
- âœ… æ²¡æœ‰é‡å¤æ•°æ®

---

**ä¿®å¤æ—¥æœŸ**: 2026/02/08  
**ä¿®å¤æ–¹æ³•**: é‡å»ºæ•°æ®åº“ç´¢å¼•  
**éªŒè¯çŠ¶æ€**: âœ… é€šè¿‡  
**ç³»ç»ŸçŠ¶æ€**: âœ… æ­£å¸¸è¿è¡Œ

