# 生产部署 - 总结

## ✅ 已创建的文件

### 1. 数据库初始化脚本
**文件：** `server/scripts/initDatabase.js`

**功能：**
- 自动创建管理员账号
- 初始化系统配置
- 设置默认参数
- 交互式配置

**使用：**
```bash
npm run init-db
```

---

### 2. 部署脚本
**文件：** `deploy.sh`

**功能：**
- 自动安装依赖
- 构建前端
- 检查数据库连接
- 初始化数据库（可选）
- 启动/重启后端服务

**使用：**
```bash
chmod +x deploy.sh
bash deploy.sh
```

---

### 3. 部署文档

#### 完整指南
**文件：** `生产环境部署指南.md`

**内容：**
- 详细的部署步骤
- 服务器环境配置
- Nginx 配置
- SSL 证书配置
- 安全加固
- 故障排查
- 备份策略

#### 快速开始
**文件：** `生产部署_快速开始.md`

**内容：**
- 5 分钟快速部署
- 简化的步骤
- 常用命令
- 常见问题

---

## 🎯 部署流程

### 开发环境 → 生产环境

```
开发环境 (npm run dev)
    ├─ 前端: Vite Dev Server (端口 5173)
    └─ 后端: Nodemon (端口 3000)
    
    ↓ 构建 (npm run build)
    
生产环境
    ├─ 前端: Nginx 静态文件服务
    ├─ 后端: PM2 + Node.js (端口 3000)
    └─ 数据库: MongoDB (端口 27017)
```

---

## 📊 数据库初始化

### 自动 vs 手动

| 方式 | 命令 | 说明 |
|------|------|------|
| **自动** | `bash deploy.sh` | 部署脚本会询问是否初始化 |
| **手动** | `npm run init-db` | 单独运行初始化脚本 |

### 初始化内容

1. **管理员账号**
   - 用户名（默认：admin）
   - 邮箱
   - 密码

2. **系统配置**
   - 网站名称
   - 汇率设置
   - 服务费设置
   - 默认参数

3. **数据库集合**
   - users（用户）
   - settings（系统配置）
   - wallets（钱包）
   - payments（订单）
   - ads（广告）
   - faqs（常见问题）
   - tickets（工单）
   - swaporders（闪兑订单）

---

## 🔧 配置文件

### .env（环境变量）

**必须配置：**
```env
NODE_ENV=production
MONGODB_URI=mongodb://localhost:27017/easypay
JWT_SECRET=<随机字符串>
MASTER_KEY=<随机字符串>
FRONTEND_URL=https://your-domain.com
```

**可选配置：**
```env
PORT=3000
PAYMENT_CALLBACK_URL=https://your-domain.com/api/payments/notify
```

### Nginx 配置

**位置：** `/etc/nginx/sites-available/easypay`

**关键配置：**
- 静态文件服务（前端）
- API 反向代理（后端）
- SSL 证书
- Gzip 压缩
- 缓存策略

---

## 🚀 启动方式

### 开发环境

```bash
npm run dev
```

**启动：**
- 前端：Vite Dev Server
- 后端：Nodemon（自动重启）

### 生产环境

```bash
# 方式 1：使用部署脚本（推荐）
bash deploy.sh

# 方式 2：手动启动
npm run build          # 构建前端
pm2 start server/index.js --name easypay-backend  # 启动后端
```

---

## 📋 部署检查清单

### 部署前
- [ ] 服务器准备完成（Node.js, MongoDB, Nginx）
- [ ] 域名解析配置完成
- [ ] SSL 证书准备完成
- [ ] 代码上传到服务器

### 部署中
- [ ] 环境变量配置完成（.env）
- [ ] 依赖安装完成（npm install）
- [ ] 前端构建完成（npm run build）
- [ ] 数据库初始化完成（npm run init-db）
- [ ] Nginx 配置完成
- [ ] 后端服务启动完成（PM2）

### 部署后
- [ ] 网站可以访问（https://your-domain.com）
- [ ] 管理后台可以登录
- [ ] API 接口正常响应
- [ ] 修改管理员密码
- [ ] 配置支付平台
- [ ] 添加代付钱包
- [ ] 配置能量租赁
- [ ] 测试支付功能
- [ ] 测试代付功能
- [ ] 配置备份任务

---

## 🔒 安全建议

### 1. 密钥安全
- ✅ 使用强随机密钥（JWT_SECRET, MASTER_KEY）
- ✅ 不要在代码中硬编码密钥
- ✅ 定期更换密钥

### 2. 数据库安全
- ✅ 启用 MongoDB 认证
- ✅ 限制 MongoDB 只监听本地
- ✅ 定期备份数据库

### 3. 服务器安全
- ✅ 配置防火墙（只开放 80, 443, 22）
- ✅ 使用 SSL/TLS 加密
- ✅ 定期更新系统和软件

### 4. 应用安全
- ✅ 修改默认管理员密码
- ✅ 限制管理后台访问
- ✅ 启用日志记录
- ✅ 监控异常访问

---

## 🔄 更新流程

### 代码更新

```bash
cd /var/www/easypay
git pull
bash deploy.sh
```

### 配置更新

```bash
# 修改 .env
nano .env

# 重启服务
pm2 restart easypay-backend
```

### 数据库更新

```bash
# 如果有数据库迁移脚本
node server/scripts/migrate.js

# 重启服务
pm2 restart easypay-backend
```

---

## 📊 监控和维护

### 日志查看

```bash
# 后端日志
pm2 logs easypay-backend

# Nginx 访问日志
sudo tail -f /var/log/nginx/access.log

# Nginx 错误日志
sudo tail -f /var/log/nginx/error.log

# MongoDB 日志
sudo tail -f /var/log/mongodb/mongod.log
```

### 性能监控

```bash
# PM2 监控
pm2 monit

# 系统资源
htop

# 磁盘使用
df -h

# 内存使用
free -h
```

### 备份

```bash
# 数据库备份
mongodump --db easypay --out /var/backups/easypay/$(date +%Y%m%d)

# 代码备份
tar -czf /var/backups/easypay/code_$(date +%Y%m%d).tar.gz /var/www/easypay
```

---

## 🐛 故障排查

### 常见问题

| 问题 | 检查 | 解决 |
|------|------|------|
| 无法访问网站 | Nginx 状态 | `sudo systemctl restart nginx` |
| API 请求失败 | 后端服务 | `pm2 restart easypay-backend` |
| 数据库连接失败 | MongoDB 状态 | `sudo systemctl start mongod` |
| 支付回调失败 | 回调 URL | 检查支付平台配置 |
| 代付失败 | 钱包余额 | 检查钱包配置和余额 |

### 日志位置

- **后端日志：** `~/.pm2/logs/`
- **Nginx 日志：** `/var/log/nginx/`
- **MongoDB 日志：** `/var/log/mongodb/`

---

## 📞 技术支持

### 文档

- **完整指南：** `生产环境部署指南.md`
- **快速开始：** `生产部署_快速开始.md`
- **Nginx 配置：** `nginx配置示例.conf`

### 脚本

- **初始化数据库：** `npm run init-db`
- **部署：** `bash deploy.sh`
- **创建管理员：** `npm run create-admin`

---

## ✨ 总结

### 核心要点

1. **数据库会自动初始化** ✅
   - 运行 `npm run init-db` 或 `bash deploy.sh`
   - 创建管理员账号和系统配置
   - 不需要手动创建数据库

2. **前端需要构建** ✅
   - 运行 `npm run build`
   - 生成 `dist` 目录
   - Nginx 服务静态文件

3. **后端使用 PM2 管理** ✅
   - 自动重启
   - 日志管理
   - 进程监控

4. **Nginx 做反向代理** ✅
   - 静态文件服务（前端）
   - API 代理（后端）
   - SSL/TLS 加密

### 部署命令

```bash
# 一键部署
bash deploy.sh

# 或手动部署
npm install --production
npm run build
npm run init-db
pm2 start server/index.js --name easypay-backend
```

---

**文档版本：** v1.0  
**最后更新：** 2026-02-02  
**状态：** ✅ 生产就绪
