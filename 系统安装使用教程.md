# 系统安装使用教程

> **EasyPay - USDT/TRX 代付系统**  
> 完整的安装、配置和使用指南

---

## 📋 目录

1. [系统简介](#系统简介)
2. [环境要求](#环境要求)
3. [快速安装](#快速安装)
4. [基础配置](#基础配置)
5. [功能配置](#功能配置)
6. [Telegram Bot 配置](#telegram-bot-配置)
7. [生产环境部署](#生产环境部署)
8. [常用操作](#常用操作)
9. [故障排查](#故障排查)
10. [进阶功能](#进阶功能)

---

## 系统简介

### 核心功能

- ✅ **USDT/TRX 代付**：自动化加密货币转账服务
- ✅ **多钱包管理**：支持多个钱包自动轮换和负载均衡
- ✅ **支付网关集成**：支持支付宝、微信支付等
- ✅ **Telegram Bot**：完整的 Telegram 机器人交互界面
- ✅ **群发系统**：支持定时、重复发送的消息群发
- ✅ **工单系统**：用户支持和客服管理
- ✅ **能量租赁**：TRON 能量租赁服务（可选）
- ✅ **闪兑服务**：加密货币兑换服务（可选）

### 技术栈

- **前端**：React + Vite + TailwindCSS
- **后端**：Node.js + Express
- **数据库**：MongoDB
- **区块链**：TRON (TronWeb)
- **Bot**：Telegraf (Telegram Bot Framework)

---

## 环境要求

### 必需环境

```bash
Node.js >= 16.x
MongoDB >= 4.4
PM2 (生产环境)
```

### 推荐配置

**开发环境：**
- CPU: 2 核
- 内存: 2GB
- 硬盘: 10GB

**生产环境：**
- CPU: 4 核
- 内存: 4GB
- 硬盘: 20GB
- 带宽: 5Mbps+

---

## 快速安装

### 1. 克隆项目

```bash
git clone <your-repo-url>
cd easypay
```

### 2. 安装依赖

```bash
npm install
```

### 3. 配置环境变量

复制示例配置文件：

```bash
copy .env.example .env
```

编辑 `.env` 文件，填入必要配置：

```env
# ==================== 基础配置 ====================
# 服务器端口
PORT=5000

# 运行环境（development/production）
NODE_ENV=production

# 应用 URL（后端地址）
APP_URL=https://your-domain.com

# 前端 URL
FRONTEND_URL=https://your-domain.com

# ==================== 数据库配置 ====================
# MongoDB 连接字符串
MONGODB_URI=mongodb://localhost:27017/easypay

# 如果 MongoDB 需要认证
# MONGODB_URI=mongodb://username:password@localhost:27017/easypay?authSource=admin

# ==================== 安全配置 ====================
# JWT 密钥（必须修改为强密钥）
JWT_SECRET=your-super-secret-jwt-key-change-this-to-random-string

# 加密密钥（用于加密敏感数据，必须修改）
ENCRYPTION_KEY=your-encryption-key-32-characters-long

# 生成强密钥的方法：
# node server/scripts/generateStrongKey.js

# ==================== Telegram Bot 配置 ====================
# Bot Token（从 @BotFather 获取）
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

# Bot 用户名（不含 @）
TELEGRAM_BOT_USERNAME=YourBotUsername

# API URL（Bot 回调使用，通常与 APP_URL 相同）
API_URL=https://your-domain.com

# ==================== TRON 区块链配置 ====================
# TronGrid API Key（从 https://www.trongrid.io 获取）
TRON_GRID_API_KEY=your-trongrid-api-key

# 主钱包私钥（64位十六进制字符串）
TRON_PRIVATE_KEY=your-wallet-private-key-64-hex-characters

# 主钱包地址
TRON_WALLET_ADDRESS=TYourWalletAddress

# ==================== 支付网关配置（可选）====================
# 支付平台商户ID
PAYMENT_MERCHANT_ID=your-merchant-id

# 支付平台密钥
PAYMENT_SECRET_KEY=your-payment-secret-key

# 支付平台 API 地址
PAYMENT_API_URL=https://payment-gateway.com/api

# ==================== 能量租赁配置（可选）====================
# CatFee API Key
CATFEE_API_KEY=your-catfee-api-key

# CatFee API Secret
CATFEE_API_SECRET=your-catfee-api-secret

# CatFee API URL（生产环境）
CATFEE_API_URL=https://api.catfee.io

# 测试环境使用：https://nile.catfee.io

# ==================== 邮件配置（可选）====================
# SMTP 服务器
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-email-password

# ==================== 其他配置 ====================
# 日志级别（error/warn/info/debug）
LOG_LEVEL=info

# 会话密钥
SESSION_SECRET=your-session-secret-key
```

**重要提示：**

1. **必须修改的配置：**
   - `JWT_SECRET` - JWT 密钥
   - `ENCRYPTION_KEY` - 加密密钥
   - `TELEGRAM_BOT_TOKEN` - Bot Token
   - `TRON_PRIVATE_KEY` - 钱包私钥
   - `APP_URL` 和 `FRONTEND_URL` - 改为你的域名

2. **生成强密钥：**
   ```bash
   node server/scripts/generateStrongKey.js
   ```

3. **生产环境配置：**
   - `NODE_ENV=production`
   - 使用 HTTPS 域名
   - 使用强密码和密钥
   - 配置 MongoDB 认证

### 4. 初始化数据库

```bash
node server/scripts/initDatabase.js
```

### 5. 创建管理员账号

```bash
node server/scripts/createAdmin.js
```

按提示输入：
- 用户名
- 邮箱
- 密码

### 6. 启动服务

**开发环境：**

```bash
# 启动后端
npm run dev

# 新开终端，启动前端
npm run client
```

**生产环境：**

```bash
# 构建前端
npm run build

# 使用 PM2 启动
pm2 start ecosystem.config.js
```

### 7. 访问系统

- **前端**：http://localhost:5173 (开发) 或 http://localhost:3000 (生产)
- **后端 API**：http://localhost:3000/api
- **管理后台**：登录后访问 /admin

---

## 基础配置

### 1. 登录管理后台

访问前端地址，使用创建的管理员账号登录。

### 2. 配置 TRON 钱包

进入 **系统设置** → **钱包配置**：

1. **TronGrid API Key**
   - 访问 https://www.trongrid.io
   - 注册并获取 API Key
   - 填入配置

2. **钱包私钥**
   - 使用 TronLink 或其他钱包生成
   - **重要**：私钥格式为 64 位十六进制字符串
   - 点击"测试连接"验证配置

3. **充值钱包**
   - 向钱包地址转入 TRX（用于手续费）
   - 向钱包地址转入 USDT（用于代付）
   - 建议初始：100 TRX + 1000 USDT

### 3. 配置支付网关（可选）

如果需要接收法币支付，配置支付网关：

进入 **系统设置** → **支付配置**：

1. 选择支付平台（如：易支付、码支付等）
2. 填入商户 ID 和密钥
3. 配置回调地址
4. 测试支付功能

详见：[PAYMENT_METHODS.md](./PAYMENT_METHODS.md)

---

## 功能配置

### 多钱包系统

支持配置多个钱包，系统自动选择最优钱包进行转账。

**配置步骤：**

1. 进入 **钱包管理**
2. 点击 **添加钱包**
3. 填入钱包信息：
   - 名称
   - 地址
   - 私钥
   - 优先级
4. 启用钱包
5. 系统自动更新余额

**选择策略：**
- 优先级高的钱包优先使用
- 余额不足自动切换
- 支持手动禁用钱包

详见：[多钱包系统_快速参考.md](./多钱包系统_快速参考.md)

### 能量租赁（可选）

如果需要降低 USDT 转账手续费，可配置能量租赁：

1. 注册 CatFee 账号：https://catfee.io
2. 获取 API Key 和 Secret
3. 在 **钱包配置** 中填入
4. 系统自动租赁能量

详见：[TRON资源管理指南.md](./TRON资源管理指南.md)

### 闪兑服务（可选）

支持 USDT ↔ TRX 兑换：

1. 配置兑换汇率
2. 设置手续费率
3. 启用闪兑功能

详见：[闪兑系统_快速配置指南.md](./闪兑系统_快速配置指南.md)

---

## Telegram Bot 配置

### 1. 创建 Bot

1. 在 Telegram 中找到 @BotFather
2. 发送 `/newbot` 命令
3. 按提示设置 Bot 名称和用户名
4. 获取 Bot Token
5. 将 Token 填入 `.env` 文件的 `TELEGRAM_BOT_TOKEN`

### 2. 配置 Bot 菜单

进入 **Telegram 管理** → **主菜单设置**：

1. 添加/编辑菜单按钮
2. 配置按钮文本和功能
3. 调整按钮布局
4. 保存菜单

### 3. 配置消息模板

进入 **Telegram 管理** → **内容管理**：

1. 编辑欢迎消息
2. 配置通知模板：
   - 支付成功通知
   - 代付完成通知
   - 代付失败通知
3. 支持变量替换（如：`{{username}}`、`{{amount}}`）
4. 支持 HTML 格式化

### 4. 测试 Bot

1. 在 Telegram 中搜索你的 Bot
2. 点击 Start 或发送 `/start`
3. 测试各项功能：
   - 代付功能
   - 订单查询
   - 工单系统

详见：[Telegram_Bot_快速启动指南.md](./Telegram_Bot_快速启动指南.md)

### 5. 群发系统

支持定时、重复发送的消息群发：

1. 进入 **Telegram 管理** → **群发消息**
2. 创建群发：
   - 标题和内容
   - 选择目标用户
   - 设置定时发送（可选）
   - 启用重复发送（可选）
3. 发送或保存为草稿

**高级功能：**
- 定时发送：设置未来某个时间发送
- 重复发送：按间隔自动重复发送
- 群发统计：查看发送成功率和失败详情

详见：[Telegram群发定时重复功能使用指南.md](./Telegram群发定时重复功能使用指南.md)

---

## 生产环境部署

### 方式一：宝塔面板部署（推荐）

详见：[宝塔部署完整指南.md](./宝塔部署完整指南.md)

**简要步骤：**

1. 安装宝塔面板
2. 安装 Node.js、MongoDB、Nginx
3. 上传项目文件
4. 配置环境变量
5. 构建前端：`npm run build`
6. 使用 PM2 启动：`pm2 start ecosystem.config.js`
7. 配置 Nginx 反向代理
8. 配置 SSL 证书

### 方式二：手动部署

详见：[生产环境部署指南.md](./生产环境部署指南.md)

**简要步骤：**

1. 准备服务器（Ubuntu/CentOS）
2. 安装依赖环境
3. 克隆项目
4. 配置环境变量
5. 构建和启动
6. 配置 Nginx
7. 配置防火墙和安全策略

### Nginx 配置详解

**重要：** 生产环境必须使用 Nginx 反向代理，所有请求通过 443 端口（HTTPS）访问。

#### 完整配置示例

创建 Nginx 配置文件：`/etc/nginx/sites-available/easypay.conf`

```nginx
# HTTP 自动跳转到 HTTPS
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 自动跳转到 HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPS 主配置
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL 证书配置
    ssl_certificate /path/to/your/cert.pem;
    ssl_certificate_key /path/to/your/key.pem;
    
    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 日志配置
    access_log /var/log/nginx/easypay_access.log;
    error_log /var/log/nginx/easypay_error.log;
    
    # 客户端最大上传大小
    client_max_body_size 10M;
    
    # ==================== 后端 API 代理 ====================
    # 所有 /api 开头的请求转发到后端
    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        
        # 传递真实 IP 和 Host
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 禁用缓存（API 请求）
        proxy_buffering off;
    }
    
    # ==================== 前端静态文件 ====================
    # 生产环境：直接服务构建后的静态文件
    location / {
        root /path/to/easypay/dist;
        try_files $uri $uri/ /index.html;
        
        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # HTML 文件不缓存
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }
    
    # ==================== 安全配置 ====================
    # 隐藏 Nginx 版本号
    server_tokens off;
    
    # 防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # XSS 防护
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 内容类型嗅探防护
    add_header X-Content-Type-Options "nosniff" always;
    
    # HSTS（强制 HTTPS）
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
}
```

#### 配置说明

**1. 端口和域名：**
- 用户只能访问 443 端口（HTTPS）
- 80 端口自动跳转到 443
- 后端 5000 端口不对外开放

**2. API 代理：**
```nginx
location /api {
    proxy_pass http://127.0.0.1:5000;
    # ...
}
```
- 所有 `/api/*` 请求转发到后端 `http://127.0.0.1:5000/api/*`
- 支付回调地址：`https://your-domain.com/api/payments/callback`
- Telegram Webhook：`https://your-domain.com/api/telegram/webhook`

**3. 前端静态文件：**
```nginx
location / {
    root /path/to/easypay/dist;
    try_files $uri $uri/ /index.html;
}
```
- 直接服务构建后的静态文件（`npm run build` 生成的 `dist` 目录）
- 支持 React Router 的 History 模式

**4. 环境变量配置：**

`.env` 文件中的 URL 配置：
```env
# 生产环境配置
APP_URL=https://your-domain.com
FRONTEND_URL=https://your-domain.com
API_URL=https://your-domain.com
```

**注意：** 不要包含端口号，因为用户通过 443 端口访问。

#### 启用配置

```bash
# 创建软链接
ln -s /etc/nginx/sites-available/easypay.conf /etc/nginx/sites-enabled/

# 测试配置
nginx -t

# 重载 Nginx
nginx -s reload

# 或重启 Nginx
systemctl restart nginx
```

#### 防火墙配置

```bash
# 开放 HTTP 和 HTTPS 端口
ufw allow 80/tcp
ufw allow 443/tcp

# 不要开放后端端口（5000）给外部访问
# 后端只监听 127.0.0.1:5000，只能本地访问
```

#### 宝塔面板配置

如果使用宝塔面板：

1. 进入 **网站** → **添加站点**
2. 域名：`your-domain.com`
3. 根目录：`/path/to/easypay/dist`
4. 点击 **设置** → **反向代理**
5. 添加反向代理：
   - 代理名称：`backend-api`
   - 目标 URL：`http://127.0.0.1:5000`
   - 发送域名：`$host`
   - 内容替换：留空
   - 代理目录：`/api`
6. 点击 **SSL** → **Let's Encrypt** 申请免费证书
7. 开启 **强制 HTTPS**

### 部署检查清单

使用部署检查清单确保所有配置正确：

详见：[DEPLOYMENT_CHECKLIST.md](./DEPLOYMENT_CHECKLIST.md)

**关键检查项：**

- [ ] `.env` 文件配置正确（使用 HTTPS 域名）
- [ ] 后端监听 `127.0.0.1:5000`（不对外开放）
- [ ] Nginx 配置 `/api` 代理到后端
- [ ] Nginx 配置前端静态文件服务
- [ ] SSL 证书配置正确
- [ ] 防火墙只开放 80 和 443 端口
- [ ] 支付回调地址：`https://your-domain.com/api/payments/callback`
- [ ] Telegram Webhook 配置正确

---

## 常用操作

### 用户管理

**查看所有用户：**
```bash
node server/scripts/listAllUsers.js
```

**重置用户密码：**
```bash
node server/scripts/resetPassword.js
```

**创建新管理员：**
```bash
node server/scripts/createNewAdmin.js
```

### 钱包管理

**查看钱包列表：**
```bash
node server/scripts/listWallets.js
```

**刷新钱包余额：**
```bash
node server/scripts/refreshWallets.js
```

**查看钱包状态：**
```bash
node server/scripts/checkWalletStatus.js
```

### 系统维护

**查看 PM2 进程：**
```bash
pm2 list
pm2 logs easypay-backend
pm2 logs easypay-frontend
```

**重启服务：**
```bash
pm2 restart easypay-backend
pm2 restart easypay-frontend
```

**查看系统日志：**
```bash
pm2 logs --lines 100
```

### 数据库备份

**备份数据库：**
```bash
mongodump --db easypay --out ./backup/$(date +%Y%m%d)
```

**恢复数据库：**
```bash
mongorestore --db easypay ./backup/20260208/easypay
```

---

## 故障排查

### 常见问题

#### 1. Bot 无法启动

**症状：** Bot 不响应消息

**排查步骤：**
1. 检查 Bot Token 是否正确
2. 检查服务器是否能访问 Telegram API
3. 查看后端日志：`pm2 logs easypay-backend`
4. 测试 Bot：在 Telegram 中发送 `/start`

#### 2. 代付失败

**症状：** 订单状态为失败

**排查步骤：**
1. 检查钱包余额是否充足
2. 检查钱包私钥是否正确
3. 检查 TronGrid API Key 是否有效
4. 查看错误日志获取详细信息

#### 3. 支付回调失败

**症状：** 支付成功但订单未更新

**排查步骤：**
1. 检查回调地址是否正确配置
2. 检查服务器防火墙是否开放端口
3. 查看支付网关后台的回调日志
4. 检查后端日志中的回调记录

#### 4. 群发消息失败

**症状：** 群发消息发送失败

**排查步骤：**
1. 查看群发详情中的失败原因
2. 检查按钮 URL 格式是否正确
3. 检查媒体文件是否可访问
4. 查看服务器日志获取详细错误

详见：[快速故障排查卡.md](./快速故障排查卡.md)

### 日志查看

**后端日志：**
```bash
pm2 logs easypay-backend --lines 100
```

**前端日志：**
```bash
pm2 logs easypay-frontend --lines 100
```

**Nginx 日志：**
```bash
tail -f /www/wwwlogs/your-domain.log
```

---

## 进阶功能

### 多 Bot 配置

支持配置多个 Telegram Bot，用于不同的业务场景：

详见：[多Bot配置说明.md](./多Bot配置说明.md)

### API 版本管理

系统支持多个 API 版本，可根据需求选择：

详见：[API_VERSION_GUIDE.md](./API_VERSION_GUIDE.md)

### 安全审计

定期运行安全审计脚本：

```bash
node server/scripts/securityAudit.js
```

检查项目：
- 弱密码用户
- 未加密的敏感数据
- 权限配置
- API 密钥安全

### 性能优化

**数据库索引：**
- 系统已自动创建必要索引
- 定期检查慢查询

**缓存策略：**
- 钱包余额缓存（5 分钟）
- 汇率缓存（10 分钟）
- 用户信息缓存（1 分钟）

**负载均衡：**
- 多钱包自动负载均衡
- 支持水平扩展（多服务器）

---

## 相关文档

### 快速参考

- [快速故障排查卡](./快速故障排查卡.md)
- [多钱包系统快速参考](./多钱包系统_快速参考.md)
- [密钥配置快速参考](./密钥配置_快速参考.md)
- [闪兑系统快速配置指南](./闪兑系统_快速配置指南.md)

### 详细指南

- [宝塔部署完整指南](./宝塔部署完整指南.md)
- [生产环境部署指南](./生产环境部署指南.md)
- [TRON 资源管理指南](./TRON资源管理指南.md)
- [支付方法配置](./PAYMENT_METHODS.md)
- [加密货币转账指南](./CRYPTO_TRANSFER_GUIDE.md)

### Telegram Bot

- [Telegram Bot 快速启动指南](./Telegram_Bot_快速启动指南.md)
- [Telegram Bot 部署清单](./Telegram_Bot_部署清单.md)
- [Telegram Bot CMS 使用指南](./Telegram_Bot_CMS使用指南.md)
- [Telegram 群发系统使用指南](./Telegram_Bot_群发系统使用指南.md)
- [Telegram 群发定时重复功能使用指南](./Telegram群发定时重复功能使用指南.md)

### 系统配置

- [环境变量配置说明](./环境变量配置说明.md)
- [私钥格式说明](./私钥格式说明.md)
- [通知模板配置说明](./通知模板配置说明.md)
- [支付通知系统使用指南](./支付通知系统_使用指南.md)

---

## 技术支持

### 获取帮助

1. 查看相关文档
2. 检查日志文件
3. 运行诊断脚本
4. 联系技术支持

### 常用命令速查

```bash
# 查看服务状态
pm2 list

# 查看日志
pm2 logs easypay-backend --lines 100

# 重启服务
pm2 restart all

# 查看钱包状态
node server/scripts/checkWalletStatus.js

# 刷新钱包余额
node server/scripts/refreshWallets.js

# 查看用户列表
node server/scripts/listAllUsers.js

# 安全审计
node server/scripts/securityAudit.js
```

---

## 更新日志

### v1.0.0 (2026-02-08)

**核心功能：**
- ✅ USDT/TRX 代付系统
- ✅ 多钱包管理
- ✅ Telegram Bot 集成
- ✅ 群发系统（定时、重复发送）
- ✅ 工单系统
- ✅ 支付网关集成
- ✅ 能量租赁（可选）
- ✅ 闪兑服务（可选）

**最近更新：**
- 修复群发消息按钮 URL 格式问题
- 添加群发失败详情记录
- 优化群发统计页面
- 改进错误日志输出

---

## 许可证

本项目仅供学习和研究使用。

---

**最后更新：** 2026-02-08  
**版本：** v1.0.0  
**维护者：** EasyPay Team
