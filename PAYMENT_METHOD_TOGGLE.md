# 支付方式可用性开关功能

## 功能说明

管理员可以在后台控制支付宝和微信支付的可用性。前端用户仍可选择任何支付方式，但提交订单时会检查并提示不可用的支付方式。

## 实现内容

### 1. 后端更新

**Settings模型** (`server/models/Settings.js`)
- 新增字段：
  - `paymentAlipayEnabled`: Boolean，默认false（支付宝未开通）
  - `paymentWechatEnabled`: Boolean，默认true（微信支付已开通）

**公开API** (`server/routes/settings.js`)
- `/api/settings/public` 接口新增返回：
  - `paymentAlipayEnabled`
  - `paymentWechatEnabled`

### 2. 管理后台

**设置页面** (`src/pages/SettingsPage.jsx`)

在"支付配置"标签页顶部新增"支付方式可用性"区域：

- **支付宝开关**
  - 蓝色图标
  - Toggle开关
  - 显示"Alipay"标识

- **微信支付开关**
  - 绿色图标
  - Toggle开关
  - 显示"WeChat Pay"标识

提示文字：
> 💡 关闭的支付方式在前端仍可选择，但提交订单时会提示不可用

### 3. 前端支付页面

**PayPage.jsx & PayPageTRX.jsx**

#### 支付方式按钮
- 移除disabled状态
- 所有支付方式都可点击选择
- 未开通的支付方式显示：
  - 右上角红色"未开通"标签
  - 按钮略微透明（opacity-60）

#### 订单提交验证
在`handleSubmit`函数中添加检查：

```javascript
// 检查支付方式是否可用
if (paymentMethod === 'alipay' && !settings.paymentAlipayEnabled) {
  alert('❌ 支付宝支付暂未开通\n\n商户未开通支付宝支付通道，请选择微信支付。');
  return;
}
if (paymentMethod === 'wechat' && settings.paymentWechatEnabled === false) {
  alert('❌ 微信支付暂未开通\n\n商户未开通微信支付通道，请选择其他支付方式。');
  return;
}
```

## 使用流程

### 管理员操作

1. 登录管理后台
2. 进入"支付配置"标签页
3. 在顶部"支付方式可用性"区域：
   - 开启支付宝：点击支付宝的Toggle开关
   - 关闭微信：点击微信的Toggle开关
4. 点击"保存设置"

### 用户体验

#### 场景1：支付宝未开通（默认）

1. 用户访问代付页面
2. 看到支付宝按钮右上角有"未开通"标签
3. 用户仍可点击选择支付宝
4. 填写完信息后点击"立即发起代付"
5. 系统弹窗提示：
   ```
   ❌ 支付宝支付暂未开通
   
   商户未开通支付宝支付通道，请选择微信支付。
   ```
6. 用户切换到微信支付后可正常提交

#### 场景2：微信支付已开通（默认）

1. 用户访问代付页面
2. 微信支付按钮正常显示，无"未开通"标签
3. 选择微信支付可正常提交订单

#### 场景3：管理员开通支付宝

1. 管理员在后台开启支付宝开关
2. 保存设置
3. 用户刷新页面
4. 支付宝按钮的"未开通"标签消失
5. 选择支付宝可正常提交订单

## UI设计

### 后台开关样式

```
┌─────────────────────────────────────────────────┐
│  支付方式可用性                                    │
├─────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐    │
│  │ [蓝色图标]        │  │ [绿色图标]        │    │
│  │ 支付宝           │  │ 微信支付          │    │
│  │ Alipay      [○] │  │ WeChat Pay   [●] │    │
│  └──────────────────┘  └──────────────────┘    │
│                                                 │
│  💡 关闭的支付方式在前端仍可选择，但提交订单时会  │
│     提示不可用                                   │
└─────────────────────────────────────────────────┘
```

### 前端按钮样式

**未开通状态：**
```
┌─────────────────┐
│  [图标] 支付宝   │ [未开通]
└─────────────────┘
  (略微透明)
```

**已开通状态：**
```
┌─────────────────┐
│  [图标] 微信     │
└─────────────────┘
  (正常显示)
```

**选中状态：**
```
┌─────────────────┐
│  [图标] 微信     │
└─────────────────┘
  (青色边框+背景)
```

## 优势

### 1. 用户体验友好
- ✅ 不强制禁用按钮，用户可以自由选择
- ✅ 清晰的视觉提示（"未开通"标签）
- ✅ 提交时才提示，不打断用户操作流程
- ✅ 提示信息明确，告知用户如何解决

### 2. 管理灵活
- ✅ 管理员可随时开关支付方式
- ✅ 无需修改代码
- ✅ 实时生效（用户刷新页面即可）

### 3. 扩展性好
- ✅ 易于添加更多支付方式
- ✅ 每个支付方式独立控制
- ✅ 前后端分离，逻辑清晰

## 技术细节

### 数据流

1. **后台设置** → 数据库
   ```
   管理员开关 → Settings.paymentAlipayEnabled = true
   ```

2. **数据库** → 前端
   ```
   GET /api/settings/public → { paymentAlipayEnabled: true }
   ```

3. **前端验证**
   ```javascript
   if (!settings.paymentAlipayEnabled) {
     alert('支付宝未开通');
     return;
   }
   ```

### 状态判断

```javascript
// 支付宝未开通
!settings.paymentAlipayEnabled

// 微信支付未开通
settings.paymentWechatEnabled === false

// 支付宝已开通
settings.paymentAlipayEnabled === true

// 微信支付已开通
settings.paymentWechatEnabled !== false
```

## 测试建议

### 测试用例1：默认状态
1. 不修改任何设置
2. 访问代付页面
3. 验证：支付宝显示"未开通"，微信正常
4. 选择支付宝提交
5. 验证：弹窗提示未开通

### 测试用例2：开通支付宝
1. 后台开启支付宝开关
2. 保存设置
3. 刷新代付页面
4. 验证：支付宝"未开通"标签消失
5. 选择支付宝提交
6. 验证：可正常创建订单

### 测试用例3：关闭微信
1. 后台关闭微信开关
2. 保存设置
3. 刷新代付页面
4. 验证：微信显示"未开通"
5. 选择微信提交
6. 验证：弹窗提示未开通

### 测试用例4：全部关闭
1. 后台关闭所有支付方式
2. 保存设置
3. 刷新代付页面
4. 验证：所有支付方式都显示"未开通"
5. 尝试提交任何支付方式
6. 验证：都会提示未开通

## 注意事项

⚠️ **重要提示**

1. **默认状态**
   - 支付宝默认关闭（未开通）
   - 微信支付默认开启（已开通）

2. **用户提示**
   - 提示信息应清晰明确
   - 告知用户如何解决（选择其他支付方式）

3. **数据同步**
   - 修改设置后需要保存
   - 前端需要刷新页面才能看到变化
   - 考虑添加自动刷新或实时通知

4. **扩展建议**
   - 可以添加更多支付方式（如银行卡、USDT直付等）
   - 可以为每个支付方式设置不同的费率
   - 可以记录支付方式的使用统计

## 未来优化

可以考虑的改进：

1. **实时更新**
   - 使用WebSocket推送配置变更
   - 无需刷新页面即可看到最新状态

2. **更详细的提示**
   - 显示预计开通时间
   - 提供客服联系方式
   - 显示其他可用支付方式

3. **支付方式排序**
   - 已开通的排在前面
   - 未开通的排在后面或隐藏

4. **统计分析**
   - 记录每个支付方式的使用次数
   - 分析用户偏好
   - 优化支付方式配置
