# 登录 401 错误 - 解决方案

## 当前状态

✅ **Nginx 反向代理已工作** - API 请求可以到达后端  
✅ **后端服务正常运行** - 端口 5000  
❌ **登录失败** - 返回 401 "邮箱或密码错误"

---

## 问题分析

401 错误说明：
- ✅ 前后端通信正常
- ✅ API 路由正确
- ❌ 用户名或密码不匹配

---

## 解决方案

### 方案 1：检查现有账号密码（推荐）

```bash
cd /www/wwwroot/kk.vpno.eu.org/easypay
node server/scripts/checkUserPassword.js
```

这个脚本会：
1. 列出数据库中所有用户
2. 测试常见的密码组合
3. 告诉你正确的账号密码

**可能的账号组合**：
- `kailsay@gmail.com` / `specter1234`
- `admin@fastpay.com` / `admin123`
- `kailsay@gmail.com` / `admin123`

---

### 方案 2：重置密码

如果检查后发现密码不对：

```bash
node server/scripts/resetPassword.js
```

按提示操作：
1. 输入要重置的用户邮箱（如 `kailsay@gmail.com`）
2. 输入新密码（至少 6 位）
3. 记住新密码并在浏览器中登录

---

### 方案 3：创建新管理员

如果想创建一个全新的管理员账号：

```bash
node server/scripts/createNewAdmin.js
```

---

## 快速测试流程

### 1. 检查用户
```bash
node server/scripts/checkUserPassword.js
```

### 2. 测试 API 登录
```bash
curl -X POST https://kk.vpno.eu.org/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"kailsay@gmail.com","password":"specter1234"}'
```

**成功响应示例**：
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "...",
    "username": "kailsay",
    "email": "kailsay@gmail.com",
    "role": "admin"
  }
}
```

**失败响应示例**：
```json
{
  "error": "邮箱或密码错误"
}
```

### 3. 浏览器测试
1. 访问 `https://kk.vpno.eu.org`
2. 使用正确的账号密码登录
3. 应该能看到"管理后台"按钮

---

## 常见问题

### Q1: 为什么会有密码问题？

**可能原因**：
1. 初始化数据库时创建了多个用户
2. 开发环境的旧账号还在数据库中
3. 密码在某次操作中被修改了

### Q2: 如何查看所有用户？

```bash
node server/scripts/listAllUsers.js
```

### Q3: 如何删除旧用户？

连接到 MongoDB，手动删除：
```bash
mongo mongodb://root:Ubuntu123!@172.16.254.100:27017/fastpay?authSource=admin

# 在 mongo shell 中
use fastpay
db.users.find()  # 查看所有用户
db.users.deleteOne({ email: "admin@fastpay.com" })  # 删除指定用户
```

---

## 诊断命令汇总

```bash
# 进入项目目录
cd /www/wwwroot/kk.vpno.eu.org/easypay

# 1. 检查用户和密码
node server/scripts/checkUserPassword.js

# 2. 列出所有用户
node server/scripts/listAllUsers.js

# 3. 重置密码
node server/scripts/resetPassword.js

# 4. 创建新管理员
node server/scripts/createNewAdmin.js

# 5. 查看后端日志
pm2 logs easypay-backend --lines 50

# 6. 测试登录 API
curl -X POST https://kk.vpno.eu.org/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"你的邮箱","password":"你的密码"}'
```

---

## 成功标志

当你看到以下情况时，说明问题已解决：

✅ `checkUserPassword.js` 显示某个账号密码正确  
✅ curl 测试返回 token 和用户信息  
✅ 浏览器可以成功登录  
✅ 登录后可以看到"管理后台"按钮  
✅ 可以访问个人中心和订单记录

---

## 下一步

问题解决后，建议：

1. **记录正确的账号密码**
2. **删除不需要的旧账号**
3. **在后台修改为更安全的密码**
4. **备份数据库**

---

## 需要帮助？

如果以上方案都不行，请提供：

1. `checkUserPassword.js` 的输出
2. `pm2 logs easypay-backend` 的日志
3. 浏览器 Network 中 login 请求的详细信息
