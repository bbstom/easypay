# 清理旧单钱包系统 - 执行计划

## 目标
彻底删除旧的单钱包配置，确保全局只使用多钱包系统。

## 清理内容

### 1. Settings 模型 ✅ 已完成
**删除的字段：**
- `tronPrivateKeyEncrypted` - 旧的加密私钥
- `tronWalletAddress` - 旧的钱包地址
- `tronApiUrl` - 移到 API 节点配置
- `tronGridApiKey` - 移到 API 节点配置

**保留的字段：**
- `tronApiNodes` - API 节点配置（多节点支持）
- `energyRentalAddress` - 能量租赁地址（仍需要）
- 其他系统配置

### 2. tronService.js 需要清理的方法

**需要删除的方法：**
```javascript
// 这些方法使用 Settings 中的旧私钥
async sendUSDT(toAddress, amount)  // 使用旧钱包
async sendTRX(toAddress, amount)   // 使用旧钱包
getWalletAddress()                 // 返回旧钱包地址
```

**需要保留的方法：**
```javascript
// 这些方法使用多钱包系统
async sendUSDTWithWallet(wallet, toAddress, amount)
async sendTRXWithWallet(wallet, toAddress, amount)
async rentEnergyViaTransferWithWallet(...)
async rentEnergyViaCatFeeWithWallet(...)
```

**需要修改的方法：**
```javascript
// 这些方法内部调用了 getWalletAddress()
async rentEnergy(isFirstTransfer)
async rentEnergyViaTransfer(...)
async rentEnergyViaCatFee(...)
async checkWalletStatus()
```

### 3. 需要更新的测试脚本

**需要删除的脚本：**
- `server/scripts/testTransfer.js` - 使用旧的 sendUSDT/sendTRX
- `server/scripts/checkWalletAndRetry.js` - 使用旧方法
- `server/scripts/testWallet.js` - 检查旧钱包

**需要保留的脚本：**
- `server/scripts/testMultiWalletPayment.js` - 多钱包测试
- `server/scripts/testCompletePaymentFlow.js` - 完整流程测试
- `server/scripts/testEnergyRentalWithWallet.js` - 能量租赁测试
- `server/scripts/verifyMultiWalletSystem.js` - 系统验证

### 4. 需要更新的路由

**已更新：**
- `server/routes/payments.js` - 使用多钱包系统 ✅
- `server/routes/swap.js` - 使用闪兑专用钱包 ✅

### 5. 数据库迁移

**需要执行的操作：**
```javascript
// 从 Settings 中删除旧字段
db.settings.updateMany(
  {},
  {
    $unset: {
      tronPrivateKeyEncrypted: "",
      tronWalletAddress: "",
      tronApiUrl: "",
      tronGridApiKey: ""
    }
  }
)
```

## 执行步骤

### 步骤 1: 备份数据 ✅
```bash
# 备份数据库
mongodump --uri="mongodb://localhost:27017/your_database" --out=backup_before_cleanup

# 备份代码
git commit -am "Backup before cleanup"
```

### 步骤 2: 更新 Settings 模型 ✅
- 删除旧的钱包字段
- 添加注释说明已迁移到多钱包系统

### 步骤 3: 清理 tronService.js
- 删除 `sendUSDT()` 方法
- 删除 `sendTRX()` 方法
- 删除 `getWalletAddress()` 方法
- 删除 `rentEnergy()` 方法（已被 WithWallet 版本替代）
- 更新 `initialize()` 方法（不再从 Settings 读取私钥）
- 更新 `checkWalletStatus()` 方法（改为接受钱包参数）

### 步骤 4: 删除旧的测试脚本
- 删除 `testTransfer.js`
- 删除 `checkWalletAndRetry.js`（已被 checkOrderStatus.js 替代）
- 删除 `testWallet.js`（已被 testMultiWalletPayment.js 替代）

### 步骤 5: 更新文档
- 更新 README.md
- 更新配置指南
- 添加迁移说明

### 步骤 6: 数据库清理
- 执行数据库迁移脚本
- 删除 Settings 中的旧字段

### 步骤 7: 测试验证
```bash
# 1. 验证多钱包系统
node server/scripts/verifyMultiWalletSystem.js

# 2. 测试完整流程
node server/scripts/testCompletePaymentFlow.js <地址> 1

# 3. 测试能量租赁
node server/scripts/testEnergyRentalWithWallet.js
```

## 风险评估

### 低风险 ✅
- Settings 模型字段删除（已不使用）
- 测试脚本删除（不影响生产）

### 中风险 ⚠️
- tronService.js 方法删除
  - 风险：如果有地方还在调用旧方法会报错
  - 缓解：先搜索所有调用，确认都已更新

### 高风险 ❌
- 数据库字段删除
  - 风险：无法回滚
  - 缓解：先备份，测试后再执行

## 回滚计划

如果出现问题：

1. **代码回滚**
   ```bash
   git revert HEAD
   ```

2. **数据库回滚**
   ```bash
   mongorestore --uri="mongodb://localhost:27017/your_database" backup_before_cleanup
   ```

3. **恢复旧方法**
   - 从 git 历史恢复 tronService.js
   - 恢复 Settings 模型

## 验证清单

执行完成后检查：

- [ ] Settings 模型不再有旧钱包字段
- [ ] tronService.js 不再有旧的单钱包方法
- [ ] 所有代付订单使用多钱包系统
- [ ] 能量租赁功能正常
- [ ] 测试脚本都能正常运行
- [ ] 没有代码调用已删除的方法
- [ ] 文档已更新

## 预期结果

清理完成后：

✅ **代码更清晰**
- 只有一套钱包系统（多钱包）
- 没有混淆的旧代码
- 更容易维护

✅ **系统更安全**
- 不会意外使用旧钱包
- 钱包管理统一
- 更好的权限控制

✅ **功能更强大**
- 支持多个钱包
- 智能钱包选择
- 负载均衡
- 故障转移

## 注意事项

1. **在生产环境执行前，先在测试环境验证**
2. **确保有完整的数据库备份**
3. **选择低峰时段执行**
4. **准备好回滚方案**
5. **通知相关人员**
