# ğŸ” è½¬è´¦æˆåŠŸåˆ¤æ–­æœºåˆ¶è¯¦è§£

## é—®é¢˜ 1: ä¸ºä»€ä¹ˆä¸éœ€è¦è¾“å…¥é’±åŒ…åœ°å€ï¼Ÿ

### ç­”æ¡ˆï¼šé’±åŒ…åœ°å€æ˜¯ä»ç§é’¥è‡ªåŠ¨æ´¾ç”Ÿçš„

åœ¨åŒºå—é“¾ä¸­ï¼Œç§é’¥ã€å…¬é’¥å’Œåœ°å€çš„å…³ç³»æ˜¯ï¼š

```
ç§é’¥ (Private Key)
    â†“ æ¤­åœ†æ›²çº¿åŠ å¯†ç®—æ³•
å…¬é’¥ (Public Key)
    â†“ å“ˆå¸Œç®—æ³•
é’±åŒ…åœ°å€ (Wallet Address)
```

### å®ç°åŸç†

å½“æ‚¨è¾“å…¥ç§é’¥åï¼ŒTronWeb ä¼šè‡ªåŠ¨ï¼š

```javascript
// 1. åˆ›å»º TronWeb å®ä¾‹ï¼ˆè¾“å…¥ç§é’¥ï¼‰
const tronWeb = new TronWeb({
  fullHost: 'https://api.trongrid.io',
  privateKey: 'æ‚¨çš„64ä½ç§é’¥'
});

// 2. è‡ªåŠ¨æ´¾ç”Ÿé’±åŒ…åœ°å€
const walletAddress = tronWeb.defaultAddress.base58;
// è¾“å‡º: TXxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### ä»£ç ä½ç½®

**server/routes/wallet.js** (ç¬¬ 82-87 è¡Œ):
```javascript
// éªŒè¯ç§é’¥æ˜¯å¦æœ‰æ•ˆï¼ˆå°è¯•åˆ›å»º TronWeb å®ä¾‹ï¼‰
const testTronWeb = new TronWeb({
  fullHost: tronApiUrl || settings.tronApiUrl,
  privateKey: tronPrivateKey
});

// è·å–é’±åŒ…åœ°å€ï¼ˆè‡ªåŠ¨æ´¾ç”Ÿï¼‰
const walletAddress = testTronWeb.defaultAddress.base58;
```

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

1. **å®‰å…¨æ€§**: ç§é’¥å¯ä»¥æ´¾ç”Ÿåœ°å€ï¼Œä½†åœ°å€æ— æ³•åæ¨ç§é’¥
2. **ä¾¿æ·æ€§**: ç”¨æˆ·åªéœ€è¦è®°ä½ç§é’¥ï¼Œåœ°å€è‡ªåŠ¨ç”Ÿæˆ
3. **å‡†ç¡®æ€§**: é¿å…ç”¨æˆ·è¾“å…¥é”™è¯¯çš„åœ°å€
4. **æ ‡å‡†åŒ–**: æ‰€æœ‰åŒºå—é“¾éƒ½æ˜¯è¿™æ ·è®¾è®¡çš„

---

## é—®é¢˜ 2: å¦‚ä½•åˆ¤æ–­è½¬è´¦æ˜¯å¦æˆåŠŸï¼Ÿ

### åˆ¤æ–­æœºåˆ¶ï¼ˆå¤šå±‚éªŒè¯ï¼‰

ç³»ç»Ÿä½¿ç”¨ **3 å±‚éªŒè¯æœºåˆ¶** æ¥ç¡®ä¿è½¬è´¦æˆåŠŸï¼š

### ç¬¬ 1 å±‚ï¼šå‘é€å‰éªŒè¯

**ä½ç½®**: `server/services/tronService.js` - `sendUSDT()` / `sendTRX()`

```javascript
// 1. éªŒè¯æ¥æ”¶åœ°å€æ ¼å¼
if (!this.isValidAddress(toAddress)) {
  throw new Error('æ— æ•ˆçš„æ¥æ”¶åœ°å€');
}

// 2. æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
const balance = await this.getUSDTBalance(walletAddress);
if (balance < amount) {
  throw new Error('USDTä½™é¢ä¸è¶³');
}

// 3. éªŒè¯é€šè¿‡ï¼Œæ‰§è¡Œè½¬è´¦
const tx = await contract.transfer(toAddress, amountInSun).send({
  feeLimit: 100000000,
  callValue: 0
});
```

### ç¬¬ 2 å±‚ï¼šäº¤æ˜“æäº¤éªŒè¯

**TronWeb è¿”å›äº¤æ˜“å“ˆå¸Œ (txid)**:

```javascript
// USDT è½¬è´¦
const tx = await contract.transfer(toAddress, amountInSun).send();
// è¿”å›: "abc123...xyz789" (äº¤æ˜“å“ˆå¸Œ)

// TRX è½¬è´¦
const tx = await this.tronWeb.trx.sendTransaction(toAddress, amountInSun);
// è¿”å›: { txid: "abc123...xyz789", ... }
```

**å¦‚æœè¿”å›äº† txidï¼Œè¯´æ˜**:
- âœ… äº¤æ˜“å·²æäº¤åˆ° TRON ç½‘ç»œ
- âœ… äº¤æ˜“æ ¼å¼æ­£ç¡®
- âœ… ç­¾åéªŒè¯é€šè¿‡
- âœ… ä½™é¢å……è¶³
- âœ… Gas è´¹ç”¨å……è¶³

**ä»£ç ä½ç½®** (server/services/tronService.js):
```javascript
// USDT è½¬è´¦æˆåŠŸ
console.log(`âœ… USDTå‘é€æˆåŠŸ! TxID: ${tx}`);
return {
  success: true,
  txid: tx,  // â† è¿™å°±æ˜¯æˆåŠŸçš„æ ‡å¿—
  amount: amount,
  to: toAddress
};

// TRX è½¬è´¦æˆåŠŸ
console.log(`âœ… TRXå‘é€æˆåŠŸ! TxID: ${tx.txid}`);
return {
  success: true,
  txid: tx.txid || tx.transaction?.txID,  // â† æˆåŠŸæ ‡å¿—
  amount: amount,
  to: toAddress
};
```

### ç¬¬ 3 å±‚ï¼šåŒºå—é“¾ç¡®è®¤éªŒè¯ï¼ˆå¯é€‰ï¼‰

**æŸ¥è¯¢äº¤æ˜“çŠ¶æ€**:

```javascript
async getTransaction(txHash) {
  // 1. æŸ¥è¯¢äº¤æ˜“æ˜¯å¦å­˜åœ¨
  const tx = await this.tronWeb.trx.getTransaction(txHash);
  if (!tx || !tx.txID) {
    return { found: false, confirmed: false };
  }
  
  // 2. æŸ¥è¯¢äº¤æ˜“æ˜¯å¦å·²ç¡®è®¤ï¼ˆå·²æ‰“åŒ…åˆ°åŒºå—ï¼‰
  const txInfo = await this.tronWeb.trx.getTransactionInfo(txHash);
  
  return {
    found: true,
    confirmed: txInfo && txInfo.blockNumber > 0,  // â† å·²ç¡®è®¤
    blockNumber: txInfo?.blockNumber,
    result: txInfo?.result,
    fee: txInfo?.fee
  };
}
```

---

## å®Œæ•´çš„è½¬è´¦æµç¨‹

### 1. ç”¨æˆ·æ”¯ä»˜å®Œæˆ

```
ç”¨æˆ· â†’ æ”¯ä»˜å®/å¾®ä¿¡ â†’ æ”¯ä»˜ç½‘å…³ â†’ å›è°ƒé€šçŸ¥
```

### 2. ç³»ç»Ÿæ¥æ”¶å›è°ƒ

**server/routes/payments.js** - `/notify` æ¥å£:

```javascript
// éªŒè¯ç­¾å
if (!paymentService.verifySign(req.body, settings)) {
  return res.status(400).send('FAIL');
}

// æ›´æ–°è®¢å•çŠ¶æ€
payment.paymentStatus = 'paid';
payment.status = 'paid';
await payment.save();

// è§¦å‘è‡ªåŠ¨è½¬è´¦
processTransfer(payment._id);
```

### 3. æ‰§è¡Œè½¬è´¦

**server/routes/payments.js** - `processTransfer()`:

```javascript
async function processTransfer(paymentId, retryCount = 0) {
  const payment = await Payment.findById(paymentId);
  
  // æ›´æ–°çŠ¶æ€ä¸ºå¤„ç†ä¸­
  payment.transferStatus = 'processing';
  await payment.save();

  // æ‰§è¡ŒåŒºå—é“¾è½¬è´¦
  let txResult;
  if (payment.payType === 'USDT') {
    txResult = await tronService.sendUSDT(payment.address, payment.amount);
  } else {
    txResult = await tronService.sendTRX(payment.address, payment.amount);
  }

  // âœ… å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜è½¬è´¦æˆåŠŸï¼ˆæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼‰
  
  // ä¿å­˜äº¤æ˜“å“ˆå¸Œ
  payment.txHash = txResult.txid || txResult;
  payment.transferStatus = 'completed';  // â† æ ‡è®°ä¸ºå·²å®Œæˆ
  payment.transferTime = new Date();
  payment.status = 'completed';
  await payment.save();

  console.log(`âœ… ä»£ä»˜æˆåŠŸ: ${payment.platformOrderId}, txHash: ${payment.txHash}`);
}
```

### 4. å¦‚æœè½¬è´¦å¤±è´¥

```javascript
catch (error) {
  console.error(`âŒ ä»£ä»˜å¤±è´¥:`, error.message);
  
  // å¦‚æœè¿˜æœ‰é‡è¯•æ¬¡æ•°
  if (retryCount < maxRetries) {
    // ç­‰å¾…åé‡è¯•
    setTimeout(() => {
      processTransfer(paymentId, retryCount + 1);
    }, waitTime);
  } else {
    // é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œæ ‡è®°ä¸ºå¤±è´¥
    payment.transferStatus = 'failed';
    payment.status = 'failed';
    await payment.save();
  }
}
```

---

## æˆåŠŸåˆ¤æ–­çš„å…³é”®ç‚¹

### 1. TronWeb çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

TronWeb ä½¿ç”¨ **å¼‚å¸¸é©±åŠ¨** çš„æ–¹å¼ï¼š

```javascript
try {
  const tx = await contract.transfer(toAddress, amount).send();
  // âœ… å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œ = æˆåŠŸ
  // âœ… tx åŒ…å«äº¤æ˜“å“ˆå¸Œ
  return { success: true, txid: tx };
} catch (error) {
  // âŒ å¦‚æœè¿›å…¥è¿™é‡Œ = å¤±è´¥
  // âŒ error åŒ…å«å¤±è´¥åŸå› 
  throw new Error('è½¬è´¦å¤±è´¥: ' + error.message);
}
```

**æˆåŠŸçš„æ ‡å¿—**:
- âœ… æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸
- âœ… è¿”å›äº†äº¤æ˜“å“ˆå¸Œ (txid)

**å¤±è´¥çš„æ ‡å¿—**:
- âŒ æŠ›å‡ºå¼‚å¸¸
- âŒ å¼‚å¸¸ä¿¡æ¯åŒ…å«å¤±è´¥åŸå› 

### 2. äº¤æ˜“å“ˆå¸Œ (txid) çš„æ„ä¹‰

äº¤æ˜“å“ˆå¸Œæ˜¯ **å”¯ä¸€çš„äº¤æ˜“æ ‡è¯†ç¬¦**ï¼š

```
txid: "abc123def456...xyz789"
```

**æœ‰äº† txid å°±è¯´æ˜**:
- âœ… äº¤æ˜“å·²æäº¤åˆ°åŒºå—é“¾ç½‘ç»œ
- âœ… äº¤æ˜“å·²è¢«èŠ‚ç‚¹æ¥å—
- âœ… äº¤æ˜“æ­£åœ¨ç­‰å¾…æ‰“åŒ…
- âœ… å¯ä»¥åœ¨åŒºå—æµè§ˆå™¨æŸ¥è¯¢

**æŸ¥çœ‹äº¤æ˜“**:
```
https://tronscan.org/#/transaction/{txid}
```

### 3. åŒºå—ç¡®è®¤

TRON ç½‘ç»œçš„ç¡®è®¤é€Ÿåº¦ï¼š
- **æäº¤**: ç«‹å³ï¼ˆ< 1 ç§’ï¼‰
- **ç¡®è®¤**: çº¦ 3 ç§’ï¼ˆæ‰“åŒ…åˆ°åŒºå—ï¼‰
- **æœ€ç»ˆç¡®è®¤**: çº¦ 1 åˆ†é’Ÿï¼ˆ19 ä¸ªåŒºå—ç¡®è®¤ï¼‰

**æˆ‘ä»¬çš„åˆ¤æ–­æ ‡å‡†**:
- âœ… æœ‰ txid = è½¬è´¦æˆåŠŸ
- âœ… ä¸éœ€è¦ç­‰å¾…åŒºå—ç¡®è®¤
- âœ… ç”¨æˆ·å¯ä»¥é€šè¿‡ txid è‡ªè¡ŒæŸ¥è¯¢

---

## ä¸ºä»€ä¹ˆè¿™æ ·åˆ¤æ–­æ˜¯å¯é çš„ï¼Ÿ

### 1. TronWeb çš„å¯é æ€§

TronWeb æ˜¯ TRON å®˜æ–¹æä¾›çš„ SDKï¼š
- âœ… ç»è¿‡å……åˆ†æµ‹è¯•
- âœ… è¢«å¹¿æ³›ä½¿ç”¨
- âœ… æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†

### 2. åŒºå—é“¾çš„ä¸å¯é€†æ€§

ä¸€æ—¦äº¤æ˜“è¢«æäº¤ï¼š
- âœ… æ— æ³•æ’¤é”€
- âœ… æ— æ³•ä¿®æ”¹
- âœ… æ°¸ä¹…è®°å½•åœ¨åŒºå—é“¾ä¸Š

### 3. å¤šå±‚éªŒè¯

æˆ‘ä»¬çš„ç³»ç»Ÿæœ‰ 3 å±‚éªŒè¯ï¼š
1. âœ… å‘é€å‰éªŒè¯ï¼ˆåœ°å€ã€ä½™é¢ï¼‰
2. âœ… äº¤æ˜“æäº¤éªŒè¯ï¼ˆtxidï¼‰
3. âœ… åŒºå—ç¡®è®¤éªŒè¯ï¼ˆå¯é€‰ï¼‰

### 4. å®Œæ•´çš„æ—¥å¿—è®°å½•

æ¯ä¸€æ­¥éƒ½æœ‰è¯¦ç»†æ—¥å¿—ï¼š
```
ğŸ”„ å‡†å¤‡å‘é€ 100 USDT åˆ° TXxxxxx
ğŸ’° å½“å‰USDTä½™é¢: 1000
ğŸ“¤ å‘é€ 100000000 Sun (100 USDT)
âœ… USDTå‘é€æˆåŠŸ! TxID: abc123...
âœ… ä»£ä»˜æˆåŠŸ: ORD123456, txHash: abc123...
```

---

## å®é™…æ¡ˆä¾‹

### æˆåŠŸæ¡ˆä¾‹

```javascript
// æ—¥å¿—è¾“å‡º
ğŸ”„ å¼€å§‹å¤„ç†è½¬è´¦ (å°è¯• 1/4): ORD1738123456789
ğŸ”„ å‡†å¤‡å‘é€ 100 USDT åˆ° TXxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ğŸ’° å½“å‰USDTä½™é¢: 1000.000000
ğŸ“¤ å‘é€ 100000000 Sun (100 USDT)
âœ… USDTå‘é€æˆåŠŸ! TxID: abc123def456...xyz789
âœ… ä»£ä»˜æˆåŠŸ: ORD1738123456789, txHash: abc123def456...xyz789
ğŸ“§ é‚®ä»¶é€šçŸ¥å·²å‘é€: user@example.com

// æ•°æ®åº“è®°å½•
{
  platformOrderId: "ORD1738123456789",
  paymentStatus: "paid",
  transferStatus: "completed",  // â† æˆåŠŸæ ‡å¿—
  status: "completed",
  txHash: "abc123def456...xyz789",  // â† äº¤æ˜“å“ˆå¸Œ
  transferTime: "2026-01-29T10:30:00.000Z"
}
```

### å¤±è´¥æ¡ˆä¾‹ï¼ˆä¼šè‡ªåŠ¨é‡è¯•ï¼‰

```javascript
// æ—¥å¿—è¾“å‡º
ğŸ”„ å¼€å§‹å¤„ç†è½¬è´¦ (å°è¯• 1/4): ORD1738123456789
ğŸ”„ å‡†å¤‡å‘é€ 100 USDT åˆ° TXxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ğŸ’° å½“å‰USDTä½™é¢: 50.000000
âŒ ä»£ä»˜å¤±è´¥ (å°è¯• 1/4): USDTä½™é¢ä¸è¶³ã€‚å½“å‰ä½™é¢: 50, éœ€è¦: 100
â³ 5ç§’åé‡è¯•...

// å¦‚æœ 3 æ¬¡éƒ½å¤±è´¥
âŒ è½¬è´¦æœ€ç»ˆå¤±è´¥: ORD1738123456789

// æ•°æ®åº“è®°å½•
{
  platformOrderId: "ORD1738123456789",
  paymentStatus: "paid",
  transferStatus: "failed",  // â† å¤±è´¥æ ‡å¿—
  status: "failed",
  txHash: null,  // â† æ²¡æœ‰äº¤æ˜“å“ˆå¸Œ
  transferTime: null
}
```

---

## æ€»ç»“

### é’±åŒ…åœ°å€

- âœ… **ä¸éœ€è¦è¾“å…¥**ï¼Œä»ç§é’¥è‡ªåŠ¨æ´¾ç”Ÿ
- âœ… æ›´å®‰å…¨ã€æ›´å‡†ç¡®ã€æ›´ä¾¿æ·
- âœ… ç¬¦åˆåŒºå—é“¾æ ‡å‡†è®¾è®¡

### è½¬è´¦æˆåŠŸåˆ¤æ–­

- âœ… **æœ‰ txid = æˆåŠŸ**
- âœ… TronWeb å¼‚å¸¸é©±åŠ¨æœºåˆ¶
- âœ… å¤šå±‚éªŒè¯ä¿è¯å¯é æ€§
- âœ… å®Œæ•´çš„æ—¥å¿—å’ŒçŠ¶æ€è¿½è¸ª

### å¯é æ€§ä¿è¯

1. âœ… TronWeb å®˜æ–¹ SDK
2. âœ… åŒºå—é“¾ä¸å¯é€†æ€§
3. âœ… å¤šå±‚éªŒè¯æœºåˆ¶
4. âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶
5. âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•
6. âœ… å¯åœ¨åŒºå—æµè§ˆå™¨éªŒè¯

**æ‚¨å¯ä»¥å®Œå…¨ä¿¡ä»»è¿™å¥—æœºåˆ¶ï¼** ğŸ¯

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´: 2026-01-29*
