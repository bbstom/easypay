# Telegram Bot 自动检测群组功能完成

## 完成时间
2026-02-05

## 功能说明

Bot 现在可以自动检测和管理所在的群组和频道，无需手动输入 Chat ID。

## 新增功能

### 1. 自动检测群组 ✅
- Bot 被添加到群组时自动记录
- 实时更新群组信息
- 记录 Bot 权限状态

### 2. 群组管理 ✅
- 显示所有 Bot 所在的群组
- 显示群组类型（群组/超级群组/频道）
- 显示 Bot 状态（成员/管理员）
- 显示成员数量

### 3. 可视化选择 ✅
- 复选框选择目标群组
- 显示群组详细信息
- 支持多选
- 保留手动输入选项

## 数据模型

### TelegramGroup 模型

```javascript
{
  chatId: String,        // 群组 ID
  title: String,         // 群组名称
  type: String,          // 类型: group/supergroup/channel
  username: String,      // 公开群组用户名
  memberCount: Number,   // 成员数量
  botStatus: String,     // Bot 状态: member/admin/left
  botPermissions: {      // Bot 权限
    canSendMessages: Boolean,
    canDeleteMessages: Boolean,
    canPinMessages: Boolean,
    canInviteUsers: Boolean
  },
  lastMessageAt: Date,   // 最后消息时间
  messageCount: Number,  // 消息计数
  active: Boolean        // 是否活跃
}
```

## 工作原理

### 1. 自动检测

当 Bot 被添加到群组时：
```javascript
bot.on('my_chat_member', async (ctx) => {
  // 自动记录群组信息
  // 保存到数据库
});
```

### 2. 实时更新

当群组有消息时：
```javascript
bot.on('message', async (ctx) => {
  // 更新群组活跃状态
  // 增加消息计数
});
```

### 3. 权限检测

Bot 成为管理员时：
- 自动检测权限
- 保存权限信息
- 显示在前端

## 使用方法

### 步骤 1：添加 Bot 到群组

1. 打开 Telegram 群组
2. 点击群组名称 → 添加成员
3. 搜索并添加你的 Bot
4. （可选）设置 Bot 为管理员

### 步骤 2：激活检测

1. 在群组中发送任意消息（例如 `/start`）
2. Bot 会自动记录群组信息
3. 刷新管理后台即可看到群组

### 步骤 3：发送群发消息

1. 进入 Telegram 管理页面
2. 点击"创建群发"
3. 目标类型选择"👨‍👩‍👧‍👦 群组"
4. 勾选要发送的群组
5. 编辑消息内容
6. 点击"发送"

## 前端界面

### 群组选择器

```
选择群组/频道 (3 个可用)

☑️ 官方公告群
   👥 超级群组 • 👑 管理员 • ID: -1001234567890
   1,234 人

☐ 用户交流群
   👥 群组 • 👤 成员 • ID: -1009876543210
   567 人

☐ 产品更新频道
   📢 频道 • 👑 管理员 • ID: -1001111111111
   5,678 人
```

### 未检测到群组时

```
📢 未检测到群组

1. 将 Bot 添加到群组或频道
2. 在群组中发送任意消息
3. 刷新此页面查看群组列表

🔄 刷新群组列表
```

## API 端点

### 获取群组列表
```
GET /api/telegram/groups
Authorization: Bearer <token>

Response:
[
  {
    "chatId": "-1001234567890",
    "title": "官方公告群",
    "type": "supergroup",
    "botStatus": "admin",
    "memberCount": 1234,
    "active": true
  }
]
```

### 刷新群组信息
```
POST /api/telegram/groups/:chatId/refresh
Authorization: Bearer <token>

Response:
{
  "chatId": "-1001234567890",
  "title": "官方公告群",
  "memberCount": 1234,
  "updatedAt": "2024-01-01T12:00:00Z"
}
```

## 群组类型说明

### 1. 普通群组 (group)
- 成员上限：200 人
- 功能：基础群聊功能
- Bot 权限：有限

### 2. 超级群组 (supergroup)
- 成员上限：200,000 人
- 功能：完整群组功能
- Bot 权限：完整（如果是管理员）

### 3. 频道 (channel)
- 成员上限：无限
- 功能：单向广播
- Bot 权限：需要管理员权限才能发送

## Bot 权限说明

### 成员权限
- ✅ 接收消息
- ✅ 发送消息
- ❌ 删除消息
- ❌ 置顶消息
- ❌ 邀请用户

### 管理员权限
- ✅ 接收消息
- ✅ 发送消息
- ✅ 删除消息（如果授予）
- ✅ 置顶消息（如果授予）
- ✅ 邀请用户（如果授予）

## 注意事项

### 1. 频道发送
- Bot 必须是频道管理员
- 需要"发送消息"权限
- 消息会显示为频道消息

### 2. 群组发送
- Bot 可以是普通成员
- 消息会显示 Bot 名称
- 可能受到群组限制

### 3. 权限检查
- 发送前检查 Bot 权限
- 权限不足会发送失败
- 建议设置 Bot 为管理员

### 4. 隐私模式
- 默认情况下，Bot 只能接收 @ 提及的消息
- 需要关闭隐私模式才能接收所有消息
- 在 @BotFather 中设置

## 故障排查

### Q1: 群组未显示？

**检查项：**
1. Bot 是否已添加到群组
2. 是否在群组中发送过消息
3. 刷新管理后台页面
4. 查看后端日志

**解决方法：**
```bash
# 查看日志
pm2 logs telegram-bot

# 应该看到类似输出
✅ Bot 加入群组: 测试群组 (-1001234567890)
```

### Q2: 无法发送到频道？

**原因：**
- Bot 不是频道管理员
- Bot 没有发送消息权限

**解决方法：**
1. 将 Bot 设为频道管理员
2. 授予"发送消息"权限
3. 刷新群组信息

### Q3: 发送失败？

**可能原因：**
1. Bot 被移除
2. 权限不足
3. 群组已解散
4. Chat ID 错误

**解决方法：**
- 检查 Bot 状态
- 重新添加 Bot
- 刷新群组列表

### Q4: 成员数量不显示？

**原因：**
- 某些群组不公开成员数量
- Bot 权限不足

**解决方法：**
- 设置 Bot 为管理员
- 使用"刷新群组信息"功能

## 高级功能

### 1. 定时群发
```javascript
// 未来可以添加
{
  scheduledAt: "2024-01-01T12:00:00Z",
  repeat: "daily"
}
```

### 2. 群组分组
```javascript
// 未来可以添加
{
  groupTags: ["官方", "用户", "测试"]
}
```

### 3. 发送统计
```javascript
// 未来可以添加
{
  viewCount: 1234,
  clickCount: 567
}
```

## 相关命令

### 关闭隐私模式
```
1. 找到 @BotFather
2. 发送 /mybots
3. 选择你的 Bot
4. Bot Settings → Group Privacy
5. 选择 Turn off
```

### 设置 Bot 为管理员
```
1. 打开群组设置
2. 管理员 → 添加管理员
3. 选择你的 Bot
4. 授予所需权限
```

## 测试步骤

1. **创建测试群组**
   - 创建新的 Telegram 群组
   - 添加 Bot 到群组

2. **发送测试消息**
   - 在群组中发送 `/start`
   - 查看后端日志确认检测

3. **查看群组列表**
   - 打开管理后台
   - 进入 Telegram 管理
   - 点击"创建群发"
   - 选择"群组"目标
   - 确认群组显示

4. **发送测试群发**
   - 勾选测试群组
   - 编辑消息内容
   - 点击"发送"
   - 在群组中确认收到

## 总结

现在你可以：
- ✅ 自动检测 Bot 所在的群组
- ✅ 可视化选择目标群组
- ✅ 查看群组详细信息
- ✅ 发送富文本群发消息
- ✅ 管理多个群组和频道

无需手动输入 Chat ID，一切都是自动的！
