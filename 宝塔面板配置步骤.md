# 宝塔面板反向代理配置步骤

## 当前问题
你的宝塔面板只配置了前端代理（端口3000），需要添加后端API代理（端口5000）。

## 配置步骤

### 方法1: 使用宝塔面板界面配置（推荐）

#### 1. 登录宝塔面板
访问 `http://your-server-ip:8888`

#### 2. 找到网站配置
- 点击左侧菜单 "网站"
- 找到你的网站（域名）
- 点击 "设置"

#### 3. 配置反向代理
- 点击 "反向代理" 标签
- 你应该能看到现有的代理配置（端口3000）

#### 4. 添加API代理规则
点击 "添加反向代理"，填写以下信息：

**第一个代理（API后端）**:
- 代理名称: `API后端`
- 目标URL: `http://127.0.0.1:5000`
- 发送域名: `$host`
- 内容替换: 留空
- 代理目录: `/api`
- 高级功能:
  ```
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_connect_timeout 60s;
  proxy_send_timeout 60s;
  proxy_read_timeout 60s;
  ```

**第二个代理（前端）**:
- 保持现有配置不变
- 或者修改为:
  - 代理名称: `前端`
  - 目标URL: `http://127.0.0.1:3000`
  - 发送域名: `$host`
  - 代理目录: `/`

#### 5. 调整代理顺序
**重要**: API代理必须在前端代理之前！

在宝塔面板中，通过拖拽调整顺序，确保：
1. `/api` 代理在上面
2. `/` 代理在下面

### 方法2: 直接修改配置文件

#### 1. 找到配置文件
在宝塔面板中：
- 网站 → 设置 → 配置文件

或者通过SSH：
```bash
# 配置文件通常在这个位置
nano /www/server/panel/vhost/nginx/your-domain.conf
```

#### 2. 找到反向代理部分
找到 `#PROXY-START/` 和 `#PROXY-END/` 之间的内容

#### 3. 替换为新配置
将原来的配置替换为：

```nginx
#PROXY-START/

# API 后端代理 - 必须放在前面
location ^~ /api {
    proxy_pass http://127.0.0.1:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    add_header Cache-Control no-cache;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# 前端代理
location ^~ / {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_http_version 1.1;
    add_header X-Cache $upstream_cache_status;
    
    set $static_fileqVdUmse3 0;
    if ( $uri ~* "\.(gif|png|jpg|css|js|woff|woff2)$" ) {
        set $static_fileqVdUmse3 1;
        expires 1m;
    }
    if ( $static_fileqVdUmse3 = 0 ) {
        add_header Cache-Control no-cache;
    }
}

#PROXY-END/
```

#### 4. 保存并重启Nginx
在宝塔面板中：
- 点击 "保存"
- 软件商店 → Nginx → 重启

或者通过SSH：
```bash
# 测试配置
nginx -t

# 重启Nginx
systemctl restart nginx
```

## 验证配置

### 1. 测试前端访问
在浏览器访问: `https://your-domain.com`
应该能看到前端页面

### 2. 测试API访问
在浏览器访问: `https://your-domain.com/api/settings/public`
应该返回JSON数据

### 3. 测试支付回调
```bash
curl -X POST https://your-domain.com/api/payments/notify \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "test=1"
```
应该返回 "FAIL" 或其他响应

## 更新项目配置

### 1. 修改 .env 文件
```env
APP_URL=https://your-domain.com
```

### 2. 重启后端服务
```bash
# 进入项目目录
cd /www/wwwroot/your-project

# 重启后端
pm2 restart all
# 或
npm run server
```

### 3. 在后台配置支付回调
登录管理后台 → 系统设置 → 支付配置
- 回调地址: `https://your-domain.com/api/payments/notify`

## 常见问题

### Q1: 配置后API还是访问不了？
A: 检查以下几点：
1. 后端服务是否正常运行（端口5000）
2. 防火墙是否开放了5000端口（本地访问）
3. Nginx配置是否正确保存并重启
4. 查看Nginx错误日志: `/www/wwwlogs/your-domain.error.log`

### Q2: 如何查看Nginx日志？
A: 在宝塔面板中：
- 网站 → 设置 → 日志
- 或者查看文件: `/www/wwwlogs/your-domain.log`

### Q3: 代理顺序为什么重要？
A: Nginx按顺序匹配location规则：
- 如果 `/` 在前面，所有请求都会被它匹配，包括 `/api`
- 所以 `/api` 必须在 `/` 前面，才能优先匹配API请求

### Q4: 如何确认后端服务正常运行？
A: 
```bash
# 检查端口
netstat -tlnp | grep 5000

# 或使用 ss
ss -tlnp | grep 5000

# 本地测试
curl http://127.0.0.1:5000/api/settings/public
```

### Q5: 宝塔面板的反向代理和手动配置有什么区别？
A: 
- 宝塔面板会在 `#PROXY-START/` 和 `#PROXY-END/` 之间自动生成配置
- 手动修改这部分内容是安全的
- 但如果通过宝塔面板界面修改，会覆盖手动修改的内容

## 完整的配置检查清单

- [ ] 后端服务运行在 5000 端口
- [ ] 前端服务运行在 3000 端口
- [ ] Nginx 配置了 `/api` 代理到 5000
- [ ] Nginx 配置了 `/` 代理到 3000
- [ ] `/api` 代理在 `/` 代理之前
- [ ] `.env` 文件配置了正确的 `APP_URL`
- [ ] 后端服务已重启
- [ ] Nginx 已重启
- [ ] 可以访问前端页面
- [ ] 可以访问API接口
- [ ] 支付回调URL配置正确

## 推荐的宝塔安全设置

### 1. 关闭不必要的端口
在宝塔面板 → 安全：
- 只开放 80 (HTTP)
- 只开放 443 (HTTPS)
- 只开放 8888 (宝塔面板)
- **不要开放** 3000 和 5000 端口（只允许本地访问）

### 2. 配置SSL证书
在宝塔面板 → 网站 → 设置 → SSL：
- 选择 "Let's Encrypt"
- 申请免费证书
- 开启 "强制HTTPS"

### 3. 配置防火墙
在宝塔面板 → 安全 → 系统防火墙：
- 启用防火墙
- 只允许必要的端口

## 技术支持

如果遇到问题，请提供：
1. 宝塔面板版本
2. Nginx版本
3. 完整的Nginx配置文件
4. Nginx错误日志
5. 后端服务运行状态

---

**最后更新**: 2026年2月1日
