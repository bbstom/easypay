# ==================== EasyPay Nginx 配置 - SEO 增强版 ====================
# 支持搜索引擎爬虫的动态渲染配置
# 
# 功能：
# 1. 检测搜索引擎爬虫（Google、百度、必应等）
# 2. 爬虫访问时返回预渲染的 HTML（通过 Prerender.io 或自建服务）
# 3. 普通用户访问正常的 React 应用
# 4. 完整的 API 代理和安全配置

# ==================== HTTP 自动跳转到 HTTPS ====================
server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com www.your-domain.com;
    
    return 301 https://$server_name$request_uri;
}

# ==================== HTTPS 主配置 ====================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # ==================== SSL 证书配置 ====================
    ssl_certificate /path/to/your/fullchain.pem;
    ssl_certificate_key /path/to/your/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # ==================== 日志配置 ====================
    access_log /var/log/nginx/easypay_access.log;
    error_log /var/log/nginx/easypay_error.log;
    
    # ==================== 基础配置 ====================
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    server_tokens off;
    
    # ==================== 后端 API 代理 ====================
    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # ==================== 前端静态文件 + SEO 优化 ====================
    location / {
        root /path/to/easypay/dist;
        
        # ==================== SEO 关键配置：检测搜索引擎爬虫 ====================
        set $prerender 0;
        
        # 检测常见搜索引擎爬虫
        if ($http_user_agent ~* "googlebot|bingbot|yandex|baiduspider|twitterbot|facebookexternalhit|rogerbot|linkedinbot|embedly|quora link preview|showyoubot|outbrain|pinterest|slackbot|vkShare|W3C_Validator|360Spider|Sogou") {
            set $prerender 1;
        }
        
        # 检测 _escaped_fragment_ 参数（旧版 Google AJAX 爬取方案）
        if ($args ~ "_escaped_fragment_") {
            set $prerender 1;
        }
        
        # 排除 Prerender 自己的请求（避免无限循环）
        if ($http_user_agent ~ "Prerender") {
            set $prerender 0;
        }
        
        # 排除静态资源文件（不需要预渲染）
        if ($uri ~* "\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|doc|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent|ttf|woff|woff2|svg|eot)") {
            set $prerender 0;
        }
        
        # ==================== 方案 A：使用 Prerender.io（推荐，简单） ====================
        # 如果是爬虫，转发到 Prerender.io
        # 注册地址：https://prerender.io/（免费版 250 页/月）
        # 注册后将 YOUR_PRERENDER_TOKEN 替换为你的 token
        
        if ($prerender = 1) {
            # 重写 URL 为 Prerender.io 格式
            rewrite .* /https://$host$request_uri? break;
            
            # 转发到 Prerender.io
            proxy_pass http://service.prerender.io;
            
            # 添加认证 token（注册后获取）
            # proxy_set_header X-Prerender-Token YOUR_PRERENDER_TOKEN;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # ==================== 方案 B：使用自建 Prerender（免费，需要自己部署） ====================
        # 如果你想自建预渲染服务，取消下面的注释，注释掉上面的 Prerender.io 配置
        
        # if ($prerender = 1) {
        #     # 转发到本地 Prerender 服务（默认端口 3000）
        #     # Prerender 使用 ?url= 参数格式
        #     proxy_pass http://127.0.0.1:3000/render?url=https://$host$request_uri;
        #     
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        # }
        
        # ==================== 普通用户访问（React 应用） ====================
        # 支持 React Router 的 History 模式
        try_files $uri $uri/ /index.html;
        index index.html;
        
        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|webp)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
            access_log off;
        }
        
        # HTML 文件不缓存
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
        }
    }
    
    # ==================== 安全头部配置 ====================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # ==================== 禁止访问敏感文件 ====================
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ==================== Gzip 压缩 ====================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";
}

# ==================== 部署步骤 ====================
#
# 方案 A：使用 Prerender.io（推荐）
# 
# 1. 注册 Prerender.io
#    - 访问：https://prerender.io/
#    - 注册免费账号（250 页/月）
#    - 获取 Prerender Token
#
# 2. 配置 Nginx
#    - 将上面配置中的 YOUR_PRERENDER_TOKEN 替换为你的 token
#    - 取消注释：proxy_set_header X-Prerender-Token YOUR_PRERENDER_TOKEN;
#
# 3. 测试配置
#    nginx -t
#
# 4. 重载 Nginx
#    nginx -s reload
#
# 5. 验证效果
#    curl -A "Mozilla/5.0 (compatible; Googlebot/2.1)" https://your-domain.com/
#    应该能看到完整的 HTML 内容，而不是空的 <div id="root"></div>
#
# ==================== 方案 B：自建 Prerender ====================
#
# 1. 安装 Node.js（如果还没有）
#
# 2. 运行自动部署脚本
#    chmod +x setup-seo-prerender.sh
#    sudo ./setup-seo-prerender.sh
#
# 3. 验证服务运行
#    pm2 status prerender
#    curl 'http://127.0.0.1:3000/render?url=https://example.com'
#
# 4. 修改 Nginx 配置
#    - 注释掉 Prerender.io 的配置
#    - 取消注释 Prerender 的配置
#
# 5. 测试和重载
#    nginx -t
#    nginx -s reload
#
# ==================== 验证 SEO 效果 ====================
#
# 1. 模拟 Googlebot 访问
#    curl -A "Mozilla/5.0 (compatible; Googlebot/2.1)" https://your-domain.com/
#
# 2. 模拟百度爬虫访问
#    curl -A "Mozilla/5.0 (compatible; Baiduspider/2.0)" https://your-domain.com/
#
# 3. 使用 Google 富媒体测试工具
#    https://search.google.com/test/rich-results
#
# 4. 使用 Facebook 分享调试器
#    https://developers.facebook.com/tools/debug/
#
# 5. 查看 Nginx 日志
#    tail -f /var/log/nginx/easypay_access.log
#    # 查看是否有爬虫访问记录
#
# ==================== 成本对比 ====================
#
# Prerender.io：
# - 免费版：250 页/月
# - 基础版：$20/月，1000 页
# - 专业版：$200/月，10000 页
#
# Prerender（自建）：
# - 完全免费
# - 需要服务器资源（约 500MB 内存）
# - 需要自己维护
#
# ==================== 推荐方案 ====================
#
# 如果你的网站：
# - 页面数量少（<250 页）→ 使用 Prerender.io 免费版
# - 页面数量多 → 自建 Prerender
# - 预算充足 → 使用 Prerender.io 付费版（稳定可靠）
# - 技术能力强 → 自建 Prerender（完全免费）

