# 内网开发环境测试指南

## 问题说明

内网开发环境无法接收支付平台的回调，因为支付平台无法访问内网地址。

## 测试方案对比

| 方案 | 支付回调 | USDT代付 | 难度 | 推荐度 |
|------|---------|---------|------|--------|
| 内网穿透 | ✅ | ✅ | ⭐ | ⭐⭐⭐⭐⭐ |
| 模拟回调 | ✅ | ✅ | ⭐⭐ | ⭐⭐⭐⭐ |
| 测试服务器 | ✅ | ✅ | ⭐⭐⭐ | ⭐⭐⭐ |
| 跳过回调 | ❌ | ✅ | ⭐ | ⭐⭐ |

## 方案 1：内网穿透（推荐）

### 使用 ngrok

1. **下载安装**
   - 访问：https://ngrok.com/download
   - 注册账号（免费）
   - 下载对应系统版本

2. **启动穿透**
   ```bash
   # Windows
   ngrok.exe http 3000
   
   # Mac/Linux
   ./ngrok http 3000
   ```

3. **获取公网地址**
   ```
   Forwarding: https://abc123.ngrok.io -> http://localhost:3000
   ```

4. **配置回调地址**
   - 打开管理后台 → 系统设置
   - 支付回调地址：`https://abc123.ngrok.io/api/payments/notify`
   - 保存配置

5. **测试支付**
   - 创建订单
   - 完成支付
   - 查看后端日志，应该收到回调

### 使用 localtunnel（更简单）

```bash
# 安装
npm install -g localtunnel

# 启动
lt --port 3000

# 输出：your url is: https://xyz456.loca.lt
```

### 使用 Cloudflare Tunnel（更稳定）

```bash
# 安装 cloudflared
# Windows: 下载 exe
# Mac: brew install cloudflare/cloudflare/cloudflared

# 启动
cloudflared tunnel --url http://localhost:3000
```

## 方案 2：模拟回调（推荐）

### 使用测试脚本

```bash
# 1. 配置脚本
# 编辑 server/scripts/testPaymentCallback.js
# 修改 MERCHANT_ID 和 API_KEY

# 2. 测试支付回调
node server/scripts/testPaymentCallback.js callback

# 3. 测试 USDT 代付
node server/scripts/testPaymentCallback.js transfer
```

### 脚本功能

1. **模拟支付回调**
   - 创建测试订单
   - 生成正确的签名
   - 发送回调请求
   - 验证订单状态

2. **测试 USDT 代付**
   - 创建订单
   - 标记为已支付
   - 触发自动转账
   - 查看转账结果

### 手动模拟回调

使用 Postman 或 curl：

```bash
# 1. 创建订单（获取 orderId）
curl -X POST http://localhost:3000/api/payments/create \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 100,
    "payType": "USDT",
    "userAddress": "TYourAddress...",
    "userEmail": "test@example.com"
  }'

# 2. 模拟回调
curl -X POST http://localhost:3000/api/payments/notify \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "ORDER_ID_FROM_STEP1",
    "merchantId": "YOUR_MERCHANT_ID",
    "amount": 100,
    "status": "success",
    "payTime": "2024-01-29T15:30:00Z",
    "tradeNo": "TRADE123456",
    "sign": "GENERATED_SIGNATURE"
  }'
```

## 方案 3：跳过回调，直接测试代付

### USDT/TRX 代付流程

```
用户支付 → 管理员确认 → 自动转账
         ↑
      (跳过回调)
```

### 测试步骤

1. **创建订单**
   - 前端创建订单
   - 获取订单 ID

2. **手动标记已支付**
   ```bash
   # 方式 1：使用 MongoDB
   db.payments.updateOne(
     { orderId: "ORDER_ID" },
     { $set: { paymentStatus: "paid" } }
   )
   
   # 方式 2：使用管理后台
   # 财务管理 → 找到订单 → 标记为已支付
   ```

3. **触发转账**
   - 系统检测到已支付
   - 自动执行 USDT/TRX 转账
   - 查看后端日志

4. **验证结果**
   - 检查订单状态
   - 查看转账哈希
   - 在区块链浏览器验证

### 使用测试脚本

```bash
# 创建订单并自动转账
node server/scripts/testTransfer.js
```

## 方案 4：部署到测试服务器

### 免费选项

1. **Railway**
   - 访问：https://railway.app/
   - 连接 GitHub 仓库
   - 自动部署
   - 获得公网域名

2. **Render**
   - 访问：https://render.com/
   - 免费套餐
   - 支持 Node.js

3. **Fly.io**
   - 访问：https://fly.io/
   - 免费额度
   - 全球部署

### 付费选项

1. **阿里云轻量服务器**
   - 最低 ¥24/月
   - 1核2G
   - 公网 IP

2. **腾讯云轻量服务器**
   - 最低 ¥25/月
   - 1核2G
   - 公网 IP

## 推荐测试流程

### 阶段 1：本地测试（无需回调）

1. ✅ 测试 USDT 余额查询
2. ✅ 测试 TRX 余额查询
3. ✅ 测试 USDT 转账功能
4. ✅ 测试 TRX 转账功能
5. ✅ 测试能量租赁

```bash
# 运行测试
node server/scripts/testTransfer.js
```

### 阶段 2：模拟回调测试

1. ✅ 测试订单创建
2. ✅ 测试回调接收
3. ✅ 测试签名验证
4. ✅ 测试自动转账

```bash
# 运行测试
node server/scripts/testPaymentCallback.js callback
```

### 阶段 3：内网穿透测试

1. ✅ 启动 ngrok
2. ✅ 配置回调地址
3. ✅ 真实支付测试
4. ✅ 完整流程验证

```bash
# 启动穿透
ngrok http 3000
```

### 阶段 4：生产环境部署

1. ✅ 部署到服务器
2. ✅ 配置域名
3. ✅ 配置 HTTPS
4. ✅ 真实环境测试

## 常见问题

### Q1: ngrok 连接不稳定

**解决：**
- 使用付费版（更稳定）
- 切换到 Cloudflare Tunnel
- 部署到测试服务器

### Q2: 模拟回调签名错误

**解决：**
1. 检查 MERCHANT_ID 和 API_KEY
2. 确认 API 版本（V1 或 V2）
3. 查看后端日志获取详细错误

### Q3: USDT 转账失败

**解决：**
1. 检查钱包余额（TRX 和 USDT）
2. 检查能量是否足够
3. 查看后端日志
4. 验证私钥配置

### Q4: 回调地址配置错误

**解决：**
- 确保包含完整路径：`https://domain.com/api/payments/notify`
- 不要包含端口号（ngrok 已处理）
- 使用 HTTPS（不是 HTTP）

## 调试技巧

### 1. 查看后端日志

```bash
# 开发模式（自动重启）
npm run dev

# 查看详细日志
# 所有 console.log 都会显示
```

### 2. 使用 MongoDB Compass

- 连接数据库
- 查看 payments 集合
- 实时查看订单状态变化

### 3. 使用区块链浏览器

- TronScan: https://tronscan.org/
- 输入交易哈希查看详情
- 验证转账是否成功

### 4. 使用 Postman

- 导入 API 接口
- 测试各个端点
- 查看请求/响应

## 总结

**最佳实践：**

1. **开发阶段**：使用模拟回调 + 直接测试代付
2. **测试阶段**：使用 ngrok + 真实支付
3. **生产环境**：部署到服务器 + 配置域名

**核心要点：**
- USDT/TRX 代付不依赖回调，可以直接测试
- 支付回调需要公网地址，使用内网穿透或模拟
- 测试脚本可以覆盖大部分场景
- 生产环境必须使用真实服务器
