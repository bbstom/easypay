# 安全加固 - 快速实施指南

## 立即执行（10 分钟）

### 1. 生成强加密密钥

```bash
cd /www/wwwroot/kk.vpno.eu.org/easypay
node server/scripts/generateStrongKey.js
```

复制生成的密钥，添加到 `.env` 文件：
```env
ENCRYPTION_KEY=生成的64字节密钥
```

### 2. 设置文件权限

```bash
# 设置 .env 文件权限（只有所有者可读写）
chmod 600 .env

# 设置日志文件权限
chmod 600 /www/wwwlogs/kk.vpno.eu.org*.log

# 设置脚本执行权限
chmod +x server/scripts/*.js
```

### 3. 配置管理员 IP 白名单

在 `.env` 文件中添加：
```env
# 管理员 IP 白名单（多个 IP 用逗号分隔）
ADMIN_IP_WHITELIST=你的IP地址,另一个IP地址
```

查看你的 IP：
```bash
curl ifconfig.me
```

### 4. 运行安全审计

```bash
node server/scripts/securityAudit.js
```

查看审计结果，修复发现的问题。

### 5. 重启服务

```bash
pm2 restart easypay-backend
pm2 logs easypay-backend --lines 20
```

---

## 今天完成（1-2 小时）

### 6. 启用审计日志

修改需要审计的路由，添加审计中间件。

**示例：钱包管理路由**

```javascript
// server/routes/wallets.js
const { auditMiddleware, ipWhitelistCheck } = require('../middleware/audit');

// 创建钱包 - 添加审计
router.post('/', 
  auth, 
  adminOnly, 
  ipWhitelistCheck,  // IP 白名单检查
  auditMiddleware('CREATE_WALLET', 'wallet'),  // 审计日志
  async (req, res) => {
    // ... 原有代码
  }
);

// 更新钱包 - 添加审计
router.put('/:id', 
  auth, 
  adminOnly, 
  ipWhitelistCheck,
  auditMiddleware('UPDATE_WALLET', 'wallet'),
  async (req, res) => {
    // ... 原有代码
  }
);

// 删除钱包 - 添加审计
router.delete('/:id', 
  auth, 
  adminOnly, 
  ipWhitelistCheck,
  auditMiddleware('DELETE_WALLET', 'wallet'),
  async (req, res) => {
    // ... 原有代码
  }
);
```

### 7. 添加速率限制

```javascript
// server/index.js
const { rateLimit } = require('./middleware/audit');

// 全局速率限制：每分钟最多 100 个请求
app.use(rateLimit(100, 60000));

// API 路由速率限制：每分钟最多 60 个请求
app.use('/api', rateLimit(60, 60000));
```

### 8. 禁用敏感接口

检查并删除或注释掉任何可能泄露私钥的接口：

```javascript
// server/routes/wallets.js

// ❌ 删除这种接口
// router.get('/:id/private-key', auth, adminOnly, async (req, res) => {
//   const wallet = await Wallet.findById(req.params.id);
//   const privateKey = decryptPrivateKey(wallet.privateKeyEncrypted, masterKey);
//   res.json({ privateKey });
// });
```

### 9. 更新 Nginx 配置

添加安全头：

```nginx
# 在 server 块中添加
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;

# 隐藏服务器版本
server_tokens off;

# 限制请求大小
client_max_body_size 10M;

# 限制请求速率
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req zone=api_limit burst=20 nodelay;
```

重载 Nginx：
```bash
nginx -t
nginx -s reload
```

---

## 本周完成（2-3 天）

### 10. 启用 MongoDB 认证（如果未启用）

```bash
# 连接到 MongoDB
mongo

# 创建管理员用户
use admin
db.createUser({
  user: "admin",
  pwd: "强密码",
  roles: [ { role: "userAdminAnyDatabase", db: "admin" } ]
})

# 创建应用用户
use fastpay
db.createUser({
  user: "fastpay_user",
  pwd: "强密码",
  roles: [ { role: "readWrite", db: "fastpay" } ]
})
```

更新 `.env`：
```env
MONGODB_URI=mongodb://fastpay_user:强密码@localhost:27017/fastpay?authSource=fastpay
```

### 11. 配置数据库备份

```bash
# 创建备份脚本
cat > /root/backup_mongodb.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/root/mongodb_backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# 备份数据库
mongodump --uri="mongodb://fastpay_user:密码@localhost:27017/fastpay?authSource=fastpay" \
  --out="$BACKUP_DIR/backup_$DATE"

# 加密备份
tar -czf "$BACKUP_DIR/backup_$DATE.tar.gz" "$BACKUP_DIR/backup_$DATE"
openssl enc -aes-256-cbc -salt -in "$BACKUP_DIR/backup_$DATE.tar.gz" \
  -out "$BACKUP_DIR/backup_$DATE.tar.gz.enc" -k "备份密码"

# 删除未加密的备份
rm -rf "$BACKUP_DIR/backup_$DATE" "$BACKUP_DIR/backup_$DATE.tar.gz"

# 保留最近 7 天的备份
find $BACKUP_DIR -name "*.enc" -mtime +7 -delete

echo "备份完成: backup_$DATE.tar.gz.enc"
EOF

chmod +x /root/backup_mongodb.sh

# 添加到 crontab（每天凌晨 2 点备份）
crontab -e
# 添加：0 2 * * * /root/backup_mongodb.sh
```

### 12. 设置监控告警

创建监控脚本：

```bash
# server/scripts/securityMonitor.js
```

```javascript
#!/usr/bin/env node

require('dotenv').config();
const mongoose = require('mongoose');
const AuditLog = require('../models/AuditLog');

async function checkSecurity() {
  await mongoose.connect(process.env.MONGODB_URI);
  
  // 检查异常 IP
  const anomalousIPs = await AuditLog.getAnomalousIPs(1);
  if (anomalousIPs.length > 0) {
    console.log('⚠️  发现异常 IP:');
    anomalousIPs.forEach(ip => {
      console.log(`  ${ip._id}: ${ip.failCount} 次失败`);
    });
    // 发送告警邮件或通知
  }
  
  // 检查敏感操作
  const sensitiveOps = await AuditLog.getSensitiveOperations(1);
  if (sensitiveOps.length > 10) {
    console.log('⚠️  敏感操作频繁:', sensitiveOps.length);
    // 发送告警
  }
  
  await mongoose.connection.close();
}

checkSecurity().catch(console.error);
```

添加到 crontab（每小时检查一次）：
```bash
0 * * * * cd /www/wwwroot/kk.vpno.eu.org/easypay && node server/scripts/securityMonitor.js
```

---

## 验证清单

完成后，运行以下检查：

```bash
# 1. 安全审计
node server/scripts/securityAudit.js

# 2. 检查文件权限
ls -la .env

# 3. 检查服务状态
pm2 status

# 4. 检查日志
pm2 logs easypay-backend --lines 50

# 5. 测试 API
curl https://kk.vpno.eu.org/api/settings/public

# 6. 检查审计日志
mongo mongodb://... -eval "db.auditlogs.find().limit(10).pretty()"
```

---

## 安全检查清单

- [ ] 生成并配置强加密密钥（64+ 字节）
- [ ] 设置 .env 文件权限为 600
- [ ] 配置管理员 IP 白名单
- [ ] 运行安全审计并修复问题
- [ ] 启用审计日志
- [ ] 添加速率限制
- [ ] 禁用敏感接口
- [ ] 更新 Nginx 安全配置
- [ ] 启用 MongoDB 认证
- [ ] 配置数据库备份
- [ ] 设置监控告警
- [ ] 定期安全审计（每周）

---

## 紧急联系

如果发现安全问题：

1. **立即停止服务**
   ```bash
   pm2 stop easypay-backend
   ```

2. **检查审计日志**
   ```bash
   node server/scripts/checkAuditLogs.js
   ```

3. **转移资金**（如果必要）
   - 使用备用钱包转移资金

4. **联系技术支持**
   - 保留所有日志
   - 记录事件时间线

---

## 定期维护

### 每周
- 运行安全审计
- 检查审计日志
- 更新依赖包

### 每月
- 检查备份完整性
- 审查访问日志
- 更新安全策略

### 每季度
- 密钥轮换
- 安全培训
- 渗透测试

---

## 参考文档

- 安全风险评估和加固方案.md
- 私钥格式说明.md
- 钱包配置安全升级说明.md
