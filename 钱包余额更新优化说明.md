# 钱包余额更新优化说明

## 修复时间
2026-02-05

## 问题描述
代付完成后，更新钱包余额时出现错误：
```
❌ 更新钱包余额失败: class java.security.InvalidParameterException : owner_address isn't set
```

## 问题原因
1. 缺少详细的错误日志，无法快速定位问题
2. 没有验证钱包地址是否存在
3. API 调用失败时错误信息不够详细

## 修复内容

### 1. 增强错误处理 (`server/routes/payments.js`)

**修改前：**
```javascript
async function updateWalletBalance(walletId) {
  try {
    const wallet = await Wallet.findById(walletId);
    if (!wallet) return;
    
    const trxBalance = await tronService.getBalance(wallet.address);
    // ...
  } catch (error) {
    console.error('更新钱包余额失败:', error.message);
  }
}
```

**修改后：**
```javascript
async function updateWalletBalance(walletId) {
  try {
    const wallet = await Wallet.findById(walletId);
    if (!wallet) {
      console.error('❌ 更新余额失败: 钱包不存在');
      return;
    }

    console.log(`\n🔄 开始更新钱包余额: ${wallet.name} (${wallet.address})`);

    // 验证地址
    if (!wallet.address) {
      console.error('❌ 更新余额失败: 钱包地址为空');
      return;
    }

    console.log('📊 正在查询 TRX 余额...');
    const trxBalance = await tronService.getBalance(wallet.address);
    console.log(`✅ TRX 余额: ${trxBalance.toFixed(2)}`);
    
    console.log('📊 正在查询 USDT 余额...');
    const usdtBalance = await tronService.getUSDTBalance(wallet.address);
    console.log(`✅ USDT 余额: ${usdtBalance.toFixed(2)}`);

    // 更新数据库
    wallet.balance.trx = trxBalance;
    wallet.balance.usdt = usdtBalance;
    wallet.balance.lastUpdated = new Date();
    await wallet.save();

    console.log(`✅ 钱包余额已更新: ${wallet.name}\n`);
  } catch (error) {
    console.error('❌ 更新钱包余额失败:', error.message);
    console.error('错误详情:', error);
  }
}
```

**改进点：**
- ✅ 添加钱包存在性检查
- ✅ 添加地址有效性验证
- ✅ 添加详细的进度日志
- ✅ 添加完整的错误信息输出
- ✅ 使用 emoji 图标增强可读性

### 2. 增强参数验证 (`server/services/tronService.js`)

**修改前：**
```javascript
async getBalance(address) {
  if (!this.tronWeb) await this.initialize();
  
  return this.retryApiCall(async () => {
    const balance = await this.tronWeb.trx.getBalance(address);
    return balance / 1000000;
  });
}
```

**修改后：**
```javascript
async getBalance(address) {
  if (!address) {
    throw new Error('地址参数不能为空');
  }

  if (!this.tronWeb) await this.initialize();

  console.log(`📊 查询 TRX 余额: ${address}`);
  
  return this.retryApiCall(async () => {
    const balance = await this.tronWeb.trx.getBalance(address);
    return balance / 1000000;
  });
}

async getUSDTBalance(address) {
  if (!address) {
    throw new Error('地址参数不能为空');
  }

  if (!this.tronWeb) await this.initialize();

  console.log(`📊 查询 USDT 余额: ${address}`);
  
  // ... 余额查询逻辑
}
```

**改进点：**
- ✅ 在方法入口处验证地址参数
- ✅ 提前抛出明确的错误信息
- ✅ 添加查询日志，便于追踪

## 优化效果

### 修复前的日志
```
❌ 更新钱包余额失败: class java.security.InvalidParameterException : owner_address isn't set
```
- ❌ 无法知道是哪个钱包
- ❌ 无法知道失败在哪个步骤
- ❌ 错误信息不够明确

### 修复后的日志

**成功情况：**
```
🔄 开始更新钱包余额: ces (TXxx...xxx)
📊 正在查询 TRX 余额...
📊 查询 TRX 余额: TXxx...xxx
✅ TRX 余额: 123.45
📊 正在查询 USDT 余额...
📊 查询 USDT 余额: TXxx...xxx
✅ USDT 余额: 678.90
✅ 钱包余额已更新: ces
   TRX: 123.45
   USDT: 678.90
```

**失败情况（钱包不存在）：**
```
❌ 更新余额失败: 钱包不存在
```

**失败情况（地址为空）：**
```
🔄 开始更新钱包余额: ces (undefined)
❌ 更新余额失败: 钱包地址为空
```

**失败情况（API 调用失败）：**
```
🔄 开始更新钱包余额: ces (TXxx...xxx)
📊 正在查询 TRX 余额...
📊 查询 TRX 余额: TXxx...xxx
❌ API 调用失败 (尝试 1/3): owner_address isn't set
⏳ 1 秒后重试...
❌ 更新钱包余额失败: owner_address isn't set
错误详情: Error: owner_address isn't set
    at ...
```

## 测试方法

### 1. 正常流程测试
1. 创建一个代付订单
2. 支付成功后观察日志
3. 应该看到完整的余额更新日志

### 2. 异常情况测试
可以通过修改数据库测试：
```javascript
// 测试地址为空的情况
db.wallets.updateOne(
  { name: "test" },
  { $set: { address: "" } }
);
```

## 注意事项

1. **不影响核心功能**
   - 余额更新失败不会影响转账
   - 转账已经成功完成
   - 只是数据库中的余额显示可能不准确

2. **手动刷新**
   - 如果自动更新失败
   - 可以在后台手动点击"刷新"按钮
   - 或使用"刷新所有钱包"功能

3. **日志监控**
   - 部署后观察日志
   - 如果仍有错误，可以根据详细日志快速定位

## 部署说明

**后端部署：**
```bash
pm2 restart easypay
pm2 logs easypay --lines 100
```

**验证方法：**
1. 创建一个小额测试订单
2. 支付成功后查看日志
3. 确认看到详细的余额更新日志

## 相关文件
- `server/routes/payments.js` - 更新钱包余额函数
- `server/services/tronService.js` - TRX/USDT 余额查询方法

## 完成状态
✅ 已完成
- ✅ 增强错误处理
- ✅ 添加参数验证
- ✅ 添加详细日志
- ✅ 改进错误信息
